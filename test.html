<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" type="image/png" href="data:image/png;base64,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">
  <link rel="apple-touch-icon" href="data:image/png;base64,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">
  <title>GENYSYS (Private Beta)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18.2.0 - pinned versions with crossorigin for security -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js" crossorigin="anonymous"></script>
  <style>
    body { background: #0f172a; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ============================================
    // ANALYTICS CONFIGURATION
    // ============================================
    // Replace with your Google Apps Script Web App URL
    const ANALYTICS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxp_XAHJDYn8gRpbqaHrDjC1u1Dgyy3-i_JU6WS9R62XiFm26tJdhZP1EOi3ID8mgtg/exec';
    
    // Allowed events (must match server allowlist)
    const ALLOWED_EVENTS = [
      'session_start', 'onboarding_complete', 'first_hrv_logged', 'hrv_logged',
      'hrv_backfilled', 'command_generated', 'compliance_recorded', 'energy_recorded',
      'day_3_active', 'day_7_active', 'day_14_active', 'day_30_active',
      'feedback_submitted', 'feedback_dismissed', 'data_exported', 'results_sent',
      'data_reset', 'legacy_user_migrated'
    ];

    // ============================================
    // DATE HELPERS (use local time, not UTC)
    // ============================================
    const getLocalDateString = (date = new Date()) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const getTodayLocal = () => getLocalDateString();
    
    const getYesterdayLocal = () => {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return getLocalDateString(yesterday);
    };
    
    // Generate UUID v4
    const generateUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };

    // Get timezone (privacy-friendly region detection)
    const getTimezone = () => {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (e) {
        return 'Unknown';
      }
    };

    // Analytics tracker
    const Analytics = {
      userId: null,
      timezone: null,
      device: null,
      firstUseDate: null,

      init() {
        // Get or create user ID
        let stored = localStorage.getItem('genysys_analytics');
        if (stored) {
          const data = JSON.parse(stored);
          this.userId = data.userId;
          this.timezone = data.timezone || getTimezone();
          this.firstUseDate = data.firstUseDate;
        } else {
          this.userId = generateUUID();
          this.timezone = getTimezone();
          
          // Check if they have existing app data (legacy user from before analytics)
          const appData = localStorage.getItem('genysys_user_data');
          if (appData) {
            try {
              const parsed = JSON.parse(appData);
              this.firstUseDate = parsed.firstUseDate || getTodayLocal();
              // Track that this is a migrated legacy user (delay to ensure init completes)
              setTimeout(() => this.track('legacy_user_migrated', { 
                device: parsed.hrvSource?.label || 'unknown',
                daysLogged: parsed.hrvHistory?.length || 0
              }), 100);
            } catch (e) {
              this.firstUseDate = getTodayLocal();
            }
          } else {
            this.firstUseDate = getTodayLocal();
          }
          
          this.save();
        }
      },

      save() {
        localStorage.setItem('genysys_analytics', JSON.stringify({
          userId: this.userId,
          timezone: this.timezone,
          firstUseDate: this.firstUseDate
        }));
      },

      setDevice(device) {
        this.device = device;
      },

      getDaysActive() {
        if (!this.firstUseDate) return 0;
        const first = new Date(this.firstUseDate);
        const now = new Date();
        return Math.floor((now - first) / (1000 * 60 * 60 * 24));
      },

      track(eventName, properties = {}) {
        // Client-side validation (matches server)
        if (!ALLOWED_EVENTS.includes(eventName)) {
          console.warn('[Analytics] Unknown event:', eventName);
          return;
        }
        
        if (!this.userId) {
          console.warn('[Analytics] No userId, skipping');
          return;
        }
        
        const payload = {
          timestamp: new Date().toISOString(),
          userId: this.userId,
          event: eventName,
          device: this.device || properties.device || 'unknown',
          daysActive: this.getDaysActive(),
          region: this.timezone,
          ...properties
        };

        // Log to console in development
        console.log('[Analytics]', eventName, payload);

        // Send to Google Sheets (fire and forget)
        if (ANALYTICS_ENDPOINT && ANALYTICS_ENDPOINT !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
          fetch(ANALYTICS_ENDPOINT, {
            method: 'POST',
            mode: 'no-cors', // Google Apps Script requires this
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).catch(err => console.log('Analytics error:', err));
        }
      }
    };

    // Initialize analytics
    Analytics.init();

    // ============================================
    // APP CONFIGURATION
    // ============================================
    const THRESHOLDS = { REST: -1.0, PERFORM: 0.5, MIN_DAYS: 7, MIN_PREVIEW_DAYS: 3, MAD_FLOOR: 3.0 };

    const PRESCRIPTIONS = {
      REST: {
        color: '#EF4444',
        bg: 'rgba(239, 68, 68, 0.15)',
        headline: 'REST',
        action: 'Technique work. Easy cardio. Stretch. Guilt-free.',
        promise: 'Tomorrow you\'ll have more.'
      },
      BUILD: {
        color: '#F59E0B',
        bg: 'rgba(245, 158, 11, 0.15)',
        headline: 'BUILD',
        action: 'Execute your program. Standard effort.',
        promise: 'You\'re building capacity.'
      },
      PERFORM: {
        color: '#10B981',
        bg: 'rgba(16, 185, 129, 0.15)',
        headline: 'PERFORM',
        action: 'Push hard. Chase PRs. Go heavy.',
        promise: 'You earned this.'
      },
      LEARNING: {
        color: '#6B7280',
        bg: 'rgba(107, 114, 128, 0.15)',
        headline: 'LEARNING',
        action: 'Train normally. Log HRV each morning.',
        promise: 'Building your baseline.'
      }
    };

    const calculateMedian = (arr) => {
      const sorted = [...arr].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    };

    const calculateMAD = (arr, median) => {
      const deviations = arr.map(v => Math.abs(v - median)).sort((a, b) => a - b);
      return Math.max(calculateMedian(deviations) * 1.4826, THRESHOLDS.MAD_FLOOR);
    };

    const getCommandKey = (zScore) => {
      if (zScore === null) return 'LEARNING';
      if (zScore < THRESHOLDS.REST) return 'REST';
      if (zScore >= THRESHOLDS.PERFORM) return 'PERFORM';
      return 'BUILD';
    };

    const ZScoreChart = ({ zScore, baseline, mad }) => {
      const minZ = -3, maxZ = 3, range = maxZ - minZ;
      const clampedZ = Math.max(minZ, Math.min(maxZ, zScore));
      const markerPosition = ((clampedZ - minZ) / range) * 100;
      const restEnd = ((-1 - minZ) / range) * 100;
      const buildEnd = ((0.5 - minZ) / range) * 100;
      const restHRV = Math.round(baseline + (-1 * mad));
      const performHRV = Math.round(baseline + (0.5 * mad));

      return (
        <div className="bg-slate-800 rounded-xl p-4 space-y-3">
          <div className="text-xs text-slate-500 uppercase tracking-wide text-center">Where You Are Today</div>
          <div className="flex text-xs font-medium">
            <div className="text-red-400" style={{ width: `${restEnd}%` }}>REST</div>
            <div className="text-amber-400" style={{ width: `${buildEnd - restEnd}%` }}>BUILD</div>
            <div className="text-green-400 text-right flex-1">PERFORM</div>
          </div>
          <div className="relative h-8 rounded-lg overflow-hidden">
            <div className="absolute inset-0 flex">
              <div className="h-full bg-red-500/30" style={{ width: `${restEnd}%` }} />
              <div className="h-full bg-amber-500/30" style={{ width: `${buildEnd - restEnd}%` }} />
              <div className="h-full bg-green-500/30 flex-1" />
            </div>
            <div className="absolute top-0 bottom-0 w-0.5 bg-slate-600" style={{ left: `${restEnd}%` }} />
            <div className="absolute top-0 bottom-0 w-0.5 bg-slate-600" style={{ left: `${buildEnd}%` }} />
            <div className="absolute top-0 bottom-0 flex flex-col items-center transition-all duration-300" style={{ left: `${markerPosition}%`, transform: 'translateX(-50%)' }}>
              <div className="w-1 flex-1 bg-white rounded-full shadow-lg shadow-white/50" />
            </div>
          </div>
          <div className="flex justify-between text-xs text-slate-600">
            <span>{Math.round(baseline + (minZ * mad))}</span>
            <span className="text-slate-500">{restHRV}</span>
            <span className="text-slate-500">{performHRV}</span>
            <span>{Math.round(baseline + (maxZ * mad))}</span>
          </div>
          <div className="text-center text-xs text-slate-600">
            Your baseline: <span className="text-slate-400 font-mono">{Math.round(baseline)} ms</span>
            <span className="text-slate-700 mx-2">•</span>
            Range: <span className="text-slate-400 font-mono">{restHRV}—{performHRV} ms</span> is BUILD
          </div>
        </div>
      );
    };

    const exportToCSV = (hrvHistory, complianceLog, userName, hrvSource) => {
      const allDates = [...new Set([...hrvHistory.map(h => h.date), ...complianceLog.map(c => c.date)])].sort();
      const headers = ['Date', 'HRV (ms)', 'Command', 'Followed', 'Energy', 'Source'];
      const rows = allDates.map(date => {
        const hrv = hrvHistory.find(h => h.date === date);
        const compliance = complianceLog.find(c => c.date === date);
        return [date, hrv?.value || '', compliance?.command || '', compliance?.followed || '', compliance?.energy || '', hrvSource?.label || ''];
      });
      const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `genysys_hrv_${userName || 'data'}_${getTodayLocal()}.csv`;
      link.click();
      
      // Track export
      Analytics.track('data_exported', { daysLogged: hrvHistory.length });
    };

    const generateCSVContent = (hrvHistory, complianceLog, userName, hrvSource) => {
      const allDates = [...new Set([...hrvHistory.map(h => h.date), ...complianceLog.map(c => c.date)])].sort();
      const headers = ['Date', 'HRV (ms)', 'Command', 'Followed', 'Energy', 'Source'];
      const rows = allDates.map(date => {
        const hrv = hrvHistory.find(h => h.date === date);
        const compliance = complianceLog.find(c => c.date === date);
        return [date, hrv?.value || '', compliance?.command || '', compliance?.followed || '', compliance?.energy || '', hrvSource?.label || ''];
      });
      return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    };

    const HRV_GUIDES = {
      whoop: {
        title: 'Finding HRV in WHOOP',
        steps: [
          'Open the WHOOP app',
          'Tap on today\'s Recovery score',
          'Look for "HRV" — it\'s in milliseconds (ms)',
          'Use the number next to "HRV" (e.g., 45, 62, 78)'
        ]
      },
      apple: {
        title: 'Finding HRV on Apple Watch',
        steps: [
          'Open the Health app on your iPhone',
          'Tap Browse → Heart → Heart Rate Variability',
          'Look at your most recent morning reading',
          'Use the number in milliseconds (ms)'
        ]
      },
      oura: {
        title: 'Finding HRV in Oura',
        steps: [
          'Open the Oura app',
          'Tap on Readiness',
          'Scroll to "HRV Balance"',
          'Tap to see your average HRV in ms'
        ]
      },
      garmin: {
        title: 'Finding HRV in Garmin',
        steps: [
          'Open Garmin Connect app',
          'Go to Health Stats → HRV Status',
          'Look for your overnight HRV average',
          'Use the number in milliseconds (ms)'
        ]
      },
      fitbit: {
        title: 'Finding HRV in Fitbit',
        steps: [
          'Open the Fitbit app',
          'Tap the Health Metrics tile (or go to Discover → Health Metrics)',
          'Look for "Heart Rate Variability"',
          'Use the number in milliseconds (ms)'
        ]
      },
      welltory: {
        title: 'Taking HRV with Welltory',
        steps: [
          'Open Welltory each morning before getting up',
          'Tap "Measure" and place finger on camera',
          'Wait 1-2 minutes for the reading',
          'Use the HRV number shown (in ms)'
        ]
      },
      other: {
        title: 'Finding Your HRV',
        steps: [
          'Open your health/fitness app',
          'Look for "HRV" or "Heart Rate Variability"',
          'Find the number in milliseconds (ms)',
          'Usually shown as a number like 35-100'
        ]
      }
    };

    const FeedbackModal = ({ step, setStep, useful, setUseful, improvement, setImprovement, email, setEmail, onSend, onDismiss, getDaysSinceFirstUse }) => (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div className="bg-slate-800 rounded-2xl p-6 max-w-sm w-full space-y-5" onClick={e => e.stopPropagation()}>
          
          {/* Step 1: The real question */}
          {step === 1 && (
            <>
              <div className="text-center">
                <h2 className="text-xl font-semibold text-white">Has this changed how you train?</h2>
              </div>
              
              <div className="space-y-3">
                <button
                  onClick={() => { setUseful('yes'); setStep(2); }}
                  className="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition text-left px-4"
                >
                  Yes
                </button>
                <button
                  onClick={() => { setUseful('not_yet'); setStep(2); }}
                  className="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition text-left px-4"
                >
                  Not yet
                </button>
              </div>

              <button onClick={() => onDismiss(false)} className="w-full text-slate-500 hover:text-slate-300 text-sm transition pt-2">
                Skip for now
              </button>
            </>
          )}

          {/* Step 2: The improvement */}
          {step === 2 && (
            <>
              <div className="text-center">
                <h2 className="text-xl font-semibold text-white">One thing that would make it better?</h2>
              </div>
              
              <textarea
                value={improvement}
                onChange={(e) => setImprovement(e.target.value)}
                placeholder="Anything at all..."
                className="w-full bg-slate-700 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none h-28"
                autoFocus
              />

              <button
                onClick={() => setStep(3)}
                className="w-full bg-white text-slate-900 font-semibold py-3 rounded-xl transition hover:bg-slate-100"
              >
                Next
              </button>
            </>
          )}

          {/* Step 3: Early access - single button, email signals interest */}
          {step === 3 && (
            <>
              <div className="text-center space-y-2">
                <h2 className="text-lg font-semibold text-white">
                  {useful === 'yes' ? "Glad it's helping." : "Fair."} Here's what we're building.
                </h2>
              </div>

              <div className="space-y-4 text-sm">
                <div className="space-y-1">
                  <div className="text-white font-medium">Auto-sync</div>
                  <div className="text-slate-400">No more typing. We pull from your wearable.</div>
                </div>
                <div className="space-y-1">
                  <div className="text-white font-medium">PERFORM window</div>
                  <div className="text-slate-400">Know when your next high-intensity day is coming.</div>
                </div>
              </div>

              <div className="space-y-2 pt-2">
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="Email for early access"
                  className="w-full bg-slate-700 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <button
                onClick={() => onSend()}
                className="w-full bg-white text-slate-900 font-semibold py-3 rounded-xl transition hover:bg-slate-100"
              >
                Send feedback
              </button>
            </>
          )}

        </div>
      </div>
    );

    const InfoModal = ({ onClose, hrvSource }) => {
      const guide = HRV_GUIDES[hrvSource?.type] || HRV_GUIDES.other;
      return (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={onClose}>
        <div className="bg-slate-800 rounded-2xl p-6 max-w-md max-h-[80vh] overflow-y-auto space-y-4" onClick={e => e.stopPropagation()}>
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold">How GENYSYS Works</h2>
            <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">&times;</button>
          </div>
          
          <div className="space-y-4 text-sm text-slate-300">
            <p>Your nervous system tells us how recovered you are. We read it. We tell you what to do.</p>
            
            <div className="bg-slate-700/50 rounded-lg p-3 space-y-2">
              <div className="flex items-center gap-2"><span className="text-red-400 font-bold">REST</span> <span className="text-slate-400">→ Light movement only. System needs recovery.</span></div>
              <div className="flex items-center gap-2"><span className="text-amber-400 font-bold">BUILD</span> <span className="text-slate-400">→ Standard training. Execute your program.</span></div>
              <div className="flex items-center gap-2"><span className="text-green-400 font-bold">PERFORM</span> <span className="text-slate-400">→ System primed. Push hard. Chase PRs.</span></div>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">What is HRV?</h3>
              <p className="text-slate-400">Heart Rate Variability — the time variation between heartbeats, measured in milliseconds (ms). Higher usually means more recovered. Most people range from 20-100ms.</p>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">Where to find your HRV ({hrvSource?.label})</h3>
              <ol className="list-decimal list-inside space-y-1 text-slate-400">
                {guide.steps.map((step, i) => (
                  <li key={i}>{step}</li>
                ))}
              </ol>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">The Process</h3>
              <ol className="list-decimal list-inside space-y-1 text-slate-400">
                <li>Log your morning HRV from your device</li>
                <li>After 3 days: Preview commands begin</li>
                <li>After 7 days: Full personalized baseline</li>
              </ol>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">No Wearable?</h3>
              <p className="text-slate-400 mb-2">Download <span className="text-white">Welltory</span> (free). Take a 1-minute reading with your phone camera each morning.</p>
              <div className="flex gap-2">
                <a href="https://apps.apple.com/app/welltory/id1074367771" target="_blank" rel="noopener noreferrer" className="flex-1 bg-slate-700 hover:bg-slate-600 text-center text-xs py-2 rounded-lg transition">iOS App Store</a>
                <a href="https://play.google.com/store/apps/details?id=com.welltory.client.android" target="_blank" rel="noopener noreferrer" className="flex-1 bg-slate-700 hover:bg-slate-600 text-center text-xs py-2 rounded-lg transition">Google Play</a>
              </div>
            </div>

            <div className="bg-amber-900/30 border border-amber-700/50 rounded-lg p-3">
              <h3 className="font-semibold text-amber-400 mb-1">⚠️ Use the Same Device</h3>
              <p className="text-slate-400 text-xs">Your data is stored locally on this device only. It won't transfer to other phones or computers. Always log from the same device.</p>
            </div>

            <div className="pt-2 border-t border-slate-700">
              <p className="text-slate-500 text-xs">GENYSYS Private Beta — Your feedback shapes what we build next.</p>
            </div>
          </div>
        </div>
      </div>
    );
    };

    const App = () => {
      const [hrvHistory, setHrvHistory] = useState([]);
      const [complianceLog, setComplianceLog] = useState([]);
      const [todayHRV, setTodayHRV] = useState('');
      const [result, setResult] = useState(null);
      const [showHistory, setShowHistory] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [showOnboarding, setShowOnboarding] = useState(true);
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [showHrvGuide, setShowHrvGuide] = useState(false);
      const [showInitialSetup, setShowInitialSetup] = useState(false);
      const [editingName, setEditingName] = useState(false);
      const [showAddHrv, setShowAddHrv] = useState(false);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackStep, setFeedbackStep] = useState(1);
      const [feedbackUseful, setFeedbackUseful] = useState(null); // 'yes' or 'not_yet'
      const [feedbackImprovement, setFeedbackImprovement] = useState('');
      const [feedbackEmail, setFeedbackEmail] = useState('');
      const [firstUseDate, setFirstUseDate] = useState(null);
      const [feedbackDismissedAt, setFeedbackDismissedAt] = useState(null);
      const [feedbackSubmitted, setFeedbackSubmitted] = useState(false);
      const [newEntry, setNewEntry] = useState('');
      const [newEntryDate, setNewEntryDate] = useState(getTodayLocal());
      const [userName, setUserName] = useState('');
      const [hrvSource, setHrvSource] = useState(null); // {type: 'WHOOP'|etc, custom?: string}
      const [isLoading, setIsLoading] = useState(true);
      const [otherSourceText, setOtherSourceText] = useState('');
      
      // Track retention milestones
      const trackedMilestones = useRef(new Set());

      const CONTACT_EMAIL = 'clinton.bill.williams@gmail.com';

      const HRV_SOURCES = [
        { id: 'whoop', label: 'WHOOP' },
        { id: 'apple', label: 'Apple Watch' },
        { id: 'oura', label: 'Oura' },
        { id: 'garmin', label: 'Garmin' },
        { id: 'fitbit', label: 'Fitbit' },
        { id: 'welltory', label: 'Welltory (Phone Camera)' },
        { id: 'other', label: 'Other' },
      ];

      // Load from localStorage
      useEffect(() => {
        try {
          const saved = localStorage.getItem('genysys_user_data');
          if (saved) {
            const data = JSON.parse(saved);
            setHrvHistory(data.hrvHistory || []);
            setUserName(data.userName || '');
            setComplianceLog(data.complianceLog || []);
            setHrvSource(data.hrvSource || null);
            setFirstUseDate(data.firstUseDate || null);
            setFeedbackDismissedAt(data.feedbackDismissedAt || null);
            setFeedbackSubmitted(data.feedbackSubmitted || false);
            
            // Set device for analytics
            if (data.hrvSource) {
              Analytics.setDevice(data.hrvSource.label);
            }
            
            // Skip onboarding for returning users
            if (data.hrvSource) {
              setShowOnboarding(false);
              
              // Track returning user session
              Analytics.track('session_start', { returning: true });
            }
          } else {
            // Track new user session
            Analytics.track('session_start', { returning: false });
          }
        } catch (e) { console.log('No saved data'); }
        setIsLoading(false);
      }, []);

      // Save to localStorage
      useEffect(() => {
        if (isLoading) return;
        localStorage.setItem('genysys_user_data', JSON.stringify({ 
          hrvHistory, userName, complianceLog, hrvSource,
          firstUseDate, feedbackDismissedAt, feedbackSubmitted 
        }));
      }, [hrvHistory, userName, complianceLog, hrvSource, firstUseDate, feedbackDismissedAt, feedbackSubmitted, isLoading]);

      // Set firstUseDate when user first completes onboarding
      useEffect(() => {
        if (hrvSource && !firstUseDate) {
          setFirstUseDate(getTodayLocal());
        }
      }, [hrvSource, firstUseDate]);

      // Calculate days since first use
      const getDaysSinceFirstUse = () => {
        if (!firstUseDate) return 0;
        const first = new Date(firstUseDate);
        const now = new Date();
        const diff = Math.floor((now - first) / (1000 * 60 * 60 * 24));
        return diff;
      };

      // Track retention milestones
      useEffect(() => {
        if (!hrvSource || isLoading) return;
        
        const daysActive = getDaysSinceFirstUse();
        const milestones = [3, 7, 14, 30];
        
        milestones.forEach(milestone => {
          if (daysActive >= milestone && !trackedMilestones.current.has(milestone)) {
            trackedMilestones.current.add(milestone);
            Analytics.track(`day_${milestone}_active`, { daysLogged: hrvHistory.length });
          }
        });
      }, [hrvSource, isLoading, hrvHistory.length]);

      // Check if we should show feedback prompt
      // TEST VERSION: Shows immediately (>= 0) instead of waiting for day 7
      const shouldShowFeedback = () => {
        if (feedbackSubmitted) return false;
        const daysSinceFirstUse = getDaysSinceFirstUse();
        
        // TEST: First prompt immediately
        if (daysSinceFirstUse >= 0 && !feedbackDismissedAt) return true;
        
        // TEST: Second prompt immediately after dismissal
        if (daysSinceFirstUse >= 0 && feedbackDismissedAt) {
          const dismissedDate = new Date(feedbackDismissedAt);
          const daysSinceDismissed = Math.floor((new Date() - dismissedDate) / (1000 * 60 * 60 * 24));
          if (daysSinceDismissed >= 0) return true;
        }
        
        return false;
      };

      // Check for feedback prompt after calculating command
      useEffect(() => {
        if (result && result.commandKey && result.commandKey !== 'LEARNING' && shouldShowFeedback()) {
          // Small delay so they see their command first
          const timer = setTimeout(() => setShowFeedback(true), 1500);
          return () => clearTimeout(timer);
        }
      }, [result]);

      const sendFeedback = () => {
        // Track feedback via analytics (no email needed)
        Analytics.track('feedback_submitted', { 
          useful: feedbackUseful,
          improvementText: feedbackImprovement.substring(0, 500) || '',
          userEmail: feedbackEmail.trim().substring(0, 100) || '',
          daysLogged: hrvHistory.length
        });
        
        setFeedbackSubmitted(true);
        setShowFeedback(false);
        setFeedbackStep(1);
        setFeedbackUseful(null);
        setFeedbackImprovement('');
        setFeedbackEmail('');
      };

      const dismissFeedback = (dontAskAgain) => {
        if (dontAskAgain) {
          setFeedbackSubmitted(true);
        } else {
          setFeedbackDismissedAt(getTodayLocal());
        }
        setShowFeedback(false);
        setFeedbackStep(1);
        
        // Track feedback dismissal
        Analytics.track('feedback_dismissed', { dontAskAgain });
      };

      // Auto-calculate if today's data exists
      useEffect(() => {
        if (isLoading) return;
        const todayDate = getTodayLocal();
        const todayEntry = hrvHistory.find(h => h.date === todayDate);
        if (todayEntry) {
          setTodayHRV(todayEntry.value.toString());
          const historyWithoutToday = hrvHistory.filter(h => h.date !== todayDate);
          const values = historyWithoutToday.map(h => h.value);
          const isPreview = values.length >= THRESHOLDS.MIN_PREVIEW_DAYS && values.length < THRESHOLDS.MIN_DAYS;
          
          if (values.length < THRESHOLDS.MIN_PREVIEW_DAYS) {
            setResult({ commandKey: 'LEARNING', baseline: null, mad: null, zScore: null, daysNeeded: THRESHOLDS.MIN_PREVIEW_DAYS - values.length, isPreview: false });
          } else {
            const median = calculateMedian(values);
            const mad = calculateMAD(values, median);
            const zScore = (todayEntry.value - median) / mad;
            setResult({ commandKey: getCommandKey(zScore), baseline: median, mad, zScore, todayValue: todayEntry.value, isPreview, daysUntilFull: isPreview ? THRESHOLDS.MIN_DAYS - values.length : 0 });
          }
        }
      }, [isLoading, hrvHistory]);

      const addToHistory = () => {
        const val = parseFloat(newEntry);
        if (isNaN(val) || val <= 0) return;
        const existingIndex = hrvHistory.findIndex(h => h.date === newEntryDate);
        let newHistory = existingIndex >= 0 
          ? hrvHistory.map((h, i) => i === existingIndex ? { value: val, date: newEntryDate } : h)
          : [...hrvHistory, { value: val, date: newEntryDate }];
        newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        if (newHistory.length > 14) newHistory.shift();
        setHrvHistory(newHistory);
        setNewEntry('');
        
        // Track historical HRV entry
        Analytics.track('hrv_backfilled', { hrv: val, hrvDate: newEntryDate, daysLogged: newHistory.length });
      };

      const removeFromHistory = (displayIndex) => {
        const actualIndex = hrvHistory.length - 1 - displayIndex;
        setHrvHistory(hrvHistory.filter((_, i) => i !== actualIndex));
      };

      const calculateCommand = () => {
        const today = parseFloat(todayHRV);
        if (isNaN(today) || today <= 0) { setResult({ error: 'Enter valid HRV' }); return; }
        
        const todayDate = getTodayLocal();
        const existingIndex = hrvHistory.findIndex(h => h.date === todayDate);
        const isFirstHRV = hrvHistory.length === 0;
        
        let updatedHistory = existingIndex >= 0
          ? hrvHistory.map((h, i) => i === existingIndex ? { value: today, date: todayDate } : h)
          : [...hrvHistory, { value: today, date: todayDate }];
        updatedHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        if (updatedHistory.length > 14) updatedHistory.shift();
        setHrvHistory(updatedHistory);

        const historyWithoutToday = updatedHistory.filter(h => h.date !== todayDate);
        const values = historyWithoutToday.map(h => h.value);

        let commandKey;
        const isPreview = values.length >= THRESHOLDS.MIN_PREVIEW_DAYS && values.length < THRESHOLDS.MIN_DAYS;
        
        if (values.length < THRESHOLDS.MIN_PREVIEW_DAYS) {
          setResult({ commandKey: 'LEARNING', baseline: null, mad: null, zScore: null, daysNeeded: THRESHOLDS.MIN_PREVIEW_DAYS - values.length, isPreview: false });
          commandKey = 'LEARNING';
        } else {
          const median = calculateMedian(values);
          const mad = calculateMAD(values, median);
          const zScore = (today - median) / mad;
          commandKey = getCommandKey(zScore);
          setResult({ commandKey, baseline: median, mad, zScore, todayValue: today, isPreview, daysUntilFull: isPreview ? THRESHOLDS.MIN_DAYS - values.length : 0 });
        }

        // Log today's command
        const existingLog = complianceLog.findIndex(c => c.date === todayDate);
        if (existingLog >= 0) {
          setComplianceLog(complianceLog.map((c, i) => i === existingLog ? { ...c, command: commandKey } : c));
        } else {
          setComplianceLog([...complianceLog, { date: todayDate, command: commandKey, followed: null, energy: null }]);
        }
        
        // Track HRV logging
        if (isFirstHRV) {
          Analytics.track('first_hrv_logged', { hrv: today, hrvDate: todayDate });
        } else {
          Analytics.track('hrv_logged', { 
            hrv: today,
            hrvDate: todayDate,
            command: commandKey, 
            daysLogged: updatedHistory.length,
            isPreview
          });
        }
        
        // Track command generation (only for non-LEARNING)
        if (commandKey !== 'LEARNING') {
          Analytics.track('command_generated', { command: commandKey, isPreview });
        }
      };

      // Yesterday compliance logic
      const yesterdayDate = getYesterdayLocal();
      const yesterdayData = complianceLog.find(c => c.date === yesterdayDate);
      const needsYesterdayCompliance = yesterdayData && yesterdayData.command && yesterdayData.command !== 'LEARNING' && yesterdayData.followed === null;

      const todayDate = getTodayLocal();
      const todayCompliance = complianceLog.find(c => c.date === todayDate);
      const needsEnergyInput = todayCompliance && todayCompliance.command && todayCompliance.energy === null;

      const recordYesterdayCompliance = (followed) => {
        setComplianceLog(complianceLog.map(c => c.date === yesterdayDate ? { ...c, followed } : c));
        
        // Track compliance
        Analytics.track('compliance_recorded', { 
          complianceDate: yesterdayDate,
          command: yesterdayData.command, 
          followed 
        });
      };

      const recordTodayEnergy = (energy) => {
        setComplianceLog(complianceLog.map(c => c.date === todayDate ? { ...c, energy } : c));
        
        // Track energy input
        if (energy !== 'skipped') {
          Analytics.track('energy_recorded', { energy });
        }
      };

      const clearHistory = () => { setHrvHistory([]); setComplianceLog([]); setResult(null); };
      const resetAll = () => { 
        localStorage.removeItem('genysys_user_data'); 
        setHrvHistory([]); 
        setComplianceLog([]); 
        setUserName(''); 
        setHrvSource(null); 
        setResult(null); 
        setTodayHRV(''); 
        setFirstUseDate(null); 
        setFeedbackDismissedAt(null); 
        setFeedbackSubmitted(false); 
        setFeedbackStep(1); 
        setFeedbackUseful(null); 
        setFeedbackImprovement(''); 
        setFeedbackEmail(''); 
        
        // Track reset (but don't reset analytics ID)
        Analytics.track('data_reset');
      };

      // ============================================
      // EVIDENCE LOOP CALCULATION
      // ============================================
      const calculateEvidence = () => {
        if (hrvHistory.length < 5 || complianceLog.length < 3) return null;
        
        // Get baseline stats
        const values = hrvHistory.map(h => h.value).sort((a,b) => a - b);
        const median = values[Math.floor(values.length / 2)];
        const deviations = values.map(v => Math.abs(v - median));
        const mad = Math.max(deviations.sort((a,b) => a - b)[Math.floor(deviations.length / 2)] * 1.4826, THRESHOLDS.MAD_FLOOR);
        
        // Track REST command outcomes (the core validation)
        let restFollowed = { total: 0, crashed: 0 };  // Rested when told to rest
        let restIgnored = { total: 0, crashed: 0 };   // Pushed when told to rest
        
        // Track overall outcomes
        let protectedDays = 0;     // REST followed → recovered
        let missedRecovery = 0;    // REST followed → still crashed
        let overspent = 0;         // REST ignored → crashed (pushed when body said stop)
        let missedWindows = 0;     // BUILD/PERFORM → skipped (had capacity, didn't use it)
        
        // Functional Days: days you START with capacity (HRV above crash threshold)
        let functionalDays = 0;
        hrvHistory.forEach(h => {
          const zScore = (h.value - median) / mad;
          if (zScore >= THRESHOLDS.REST) functionalDays++;
        });
        
        complianceLog.forEach(log => {
          if (!log.command || log.command === 'LEARNING' || !log.followed) return;
          
          // Find next day's HRV
          const logDate = new Date(log.date);
          const nextDate = new Date(logDate);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = getLocalDateString(nextDate);
          const nextDayHRV = hrvHistory.find(h => h.date === nextDateStr);
          
          if (log.command === 'REST') {
            // User was told to rest - compliance is yes/no
            if (log.followed === 'yes') {
              // They rested as commanded
              restFollowed.total++;
              if (nextDayHRV) {
                const zScore = (nextDayHRV.value - median) / mad;
                const crashed = zScore < THRESHOLDS.REST;
                if (crashed) {
                  restFollowed.crashed++;
                  missedRecovery++;
                } else {
                  protectedDays++;
                }
              }
            } else if (log.followed === 'no') {
              // They pushed anyway (ignored REST)
              restIgnored.total++;
              if (nextDayHRV) {
                const zScore = (nextDayHRV.value - median) / mad;
                const crashed = zScore < THRESHOLDS.REST;
                if (crashed) {
                  restIgnored.crashed++;
                  overspent++;  // Pushed when body said stop
                }
              }
            }
          } else if (log.command === 'BUILD' || log.command === 'PERFORM') {
            // User was cleared to train
            if (log.followed === 'skipped') {
              // Had capacity but didn't use it
              missedWindows++;
            }
          }
        });
        
        return {
          restFollowed,
          restIgnored,
          functionalDays,
          totalDays: hrvHistory.length,
          protectedDays,
          missedRecovery,
          overspent,
          missedWindows,
          hasEnoughData: restFollowed.total + restIgnored.total >= 2
        };
      };
      
      const evidence = calculateEvidence();
      
      // ============================================
      // COMMAND CONTEXT - The feedback loop
      // Shows consequence history WITH the command
      // 
      // Window logic:
      // - Minimum: 3 REST decisions before showing stats
      // - Sample: last 5 REST decisions (however long that takes)
      // - Maximum: 60 days cap for relevance
      // - Streak: consecutive from today, no window
      // 
      // Core loop: Command → Comply/Override → Outcome → Evidence → Trust
      // 
      // Recovery = next day HRV z-score >= -1.0 (above crash threshold)
      // Crash = next day HRV z-score < -1.0 (in crash zone)
      // ============================================
      // ============================================
      // PROOF MESSAGES - The control loop feedback
      // Shows specific days for maximum emotional impact
      // CRITICAL: All messages gated by ACTUAL app usage days
      // Backfilled data does NOT count toward message thresholds
      // ============================================
      const getDayName = (dateStr) => {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return days[new Date(dateStr).getDay()];
      };

      const getCommandContext = () => {
        if (!result || !result.commandKey || result.commandKey === 'LEARNING') return null;
        
        // CRITICAL: Get actual days using the app (not backfilled data)
        const daysOnApp = getDaysSinceFirstUse();
        
        // Get baseline for crash detection
        const values = hrvHistory.map(h => h.value).sort((a,b) => a - b);
        if (values.length < 5) return null;
        const median = values[Math.floor(values.length / 2)];
        const deviations = values.map(v => Math.abs(v - median));
        const mad = Math.max(deviations.sort((a,b) => a - b)[Math.floor(deviations.length / 2)] * 1.4826, THRESHOLDS.MAD_FLOOR);
        
        // Helper to check if a day was a crash
        const wasCrash = (dateStr) => {
          const hrvEntry = hrvHistory.find(h => h.date === dateStr);
          if (!hrvEntry) return null;
          const zScore = (hrvEntry.value - median) / mad;
          return zScore < THRESHOLDS.REST;
        };
        
        // Helper to check if a day was ready (BUILD or PERFORM)
        const wasReady = (dateStr) => {
          const hrvEntry = hrvHistory.find(h => h.date === dateStr);
          if (!hrvEntry) return null;
          const zScore = (hrvEntry.value - median) / mad;
          return zScore >= THRESHOLDS.REST;
        };
        
        // Get next day from a date string
        const getNextDay = (dateStr) => {
          const d = new Date(dateStr);
          d.setDate(d.getDate() + 1);
          return getLocalDateString(d);
        };
        
        // Only look at compliance logs AFTER firstUseDate (real app usage, not backfill)
        const firstUseDateObj = firstUseDate ? new Date(firstUseDate) : null;
        if (!firstUseDateObj) return null; // No first use date = no proof messages
        
        const recentLogs = complianceLog
          .filter(log => {
            const logDate = new Date(log.date);
            return logDate >= firstUseDateObj && log.command && log.followed;
          })
          .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Find most recent REST override that crashed (only from real usage)
        const restOverrideCrash = recentLogs.find(log => {
          if (log.command !== 'REST' || log.followed !== 'no') return false;
          const nextDay = getNextDay(log.date);
          return wasCrash(nextDay) === true;
        });
        
        // Find most recent REST followed that recovered (only from real usage)
        const restFollowedRecovered = recentLogs.find(log => {
          if (log.command !== 'REST' || log.followed !== 'yes') return false;
          const nextDay = getNextDay(log.date);
          return wasReady(nextDay) === true;
        });
        
        // Priority 1: Override warnings can show after 2+ days (they need real consequence data)
        // This is legitimate - they actually used the app, got a command, ignored it, and crashed
        if (daysOnApp >= 2 && restOverrideCrash) {
          const overrideDay = getDayName(restOverrideCrash.date);
          const crashDay = getDayName(getNextDay(restOverrideCrash.date));
          return {
            type: 'warning',
            text: `You pushed through REST on ${overrideDay}. ${crashDay} you crashed.`
          };
        }
        
        // Priority 2: REST follow proof needs 3+ days (they followed, recovered, now seeing REST again)
        if (daysOnApp >= 3 && result.commandKey === 'REST' && restFollowedRecovered) {
          const restDay = getDayName(restFollowedRecovered.date);
          const readyDay = getDayName(getNextDay(restFollowedRecovered.date));
          return {
            type: 'affirm',
            text: `You committed to REST on ${restDay}. ${readyDay} you were ready.`
          };
        }
        
        // Priority 3: Streak messages ONLY after 7+ days of actual app usage
        // This prevents BS detection - backfilled data doesn't count
        if (daysOnApp >= 7 && (result.commandKey === 'BUILD' || result.commandKey === 'PERFORM')) {
          // Only count HRV entries AFTER firstUseDate for the streak
          const sortedHRV = [...hrvHistory]
            .filter(h => new Date(h.date) >= firstUseDateObj)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
          
          const lastSeven = sortedHRV.slice(0, 7);
          if (lastSeven.length >= 5) {
            let readyCount = 0;
            for (const entry of lastSeven) {
              const zScore = (entry.value - median) / mad;
              if (zScore >= THRESHOLDS.REST) readyCount++;
            }
            
            if (readyCount >= 5) {
              return {
                type: 'affirm',
                text: `${readyCount} of your last ${lastSeven.length} mornings, you woke up ready. That's you.`
              };
            }
          }
        }
        
        // Priority 4: PERFORM earned message after 5+ days
        if (daysOnApp >= 5 && result.commandKey === 'PERFORM') {
          return {
            type: 'earned',
            text: `Your body is primed. This is your day.`
          };
        }
        
        // Priority 5: Early encouragement (days 3-6) - BUILD only
        if (result.commandKey === 'BUILD') {
          if (daysOnApp >= 3 && daysOnApp <= 4) {
            return {
              type: 'affirm',
              text: `Commands active. Let's see what you've got.`
            };
          } else if (daysOnApp >= 5 && daysOnApp <= 6) {
            return {
              type: 'affirm',
              text: `${daysOnApp} days in. Your pattern is emerging.`
            };
          }
        }
        
        return null;
      };

      
      const commandContext = getCommandContext();
      
      // Handle onboarding completion
      const handleOnboardingComplete = (source) => {
        setHrvSource(source);
        Analytics.setDevice(source.label);
        Analytics.track('onboarding_complete', { device: source.label });
        setShowHrvGuide(true);
      };

      // Handle HRV guide completion - go to initial setup for backfill
      const handleHrvGuideComplete = () => {
        setShowHrvGuide(false);
        setShowInitialSetup(true);
      };

      // Check if user missed yesterday's HRV
      const missedYesterdayHRV = () => {
        if (hrvHistory.length === 0) return false;
        const yesterday = getYesterdayLocal();
        const today = getTodayLocal();
        const hasYesterday = hrvHistory.some(h => h.date === yesterday);
        const hasToday = hrvHistory.some(h => h.date === today);
        // Only alert if they have history but missed yesterday and haven't logged today
        return !hasYesterday && !hasToday && hrvHistory.length >= 3;
      };

      // Check if today's HRV is entered
      const hasTodayHRV = hrvHistory.some(h => h.date === getTodayLocal());

      if (isLoading) return <div className="min-h-screen bg-slate-900 text-white flex items-center justify-center"><div className="text-slate-400">Loading...</div></div>;

      // Intro onboarding (first time only)
      if (!hrvSource && showOnboarding) {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-6 flex flex-col justify-center overflow-x-hidden">
          {/* TEST MODE: Floating Reset Button */}
          <button 
            onClick={() => {
              if (confirm('Reset ALL data and restart onboarding?')) {
                resetAll();
                setShowOnboarding(true);
                setOnboardingStep(1);
                setShowHrvGuide(false);
                setShowInitialSetup(false);
              }
            }}
            className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg z-50 flex items-center gap-1"
          >
            🔄 RESET TEST
          </button>
            <div className="max-w-md mx-auto space-y-8">
              
              {/* Screen 1: The crash */}
              {onboardingStep === 1 && (
                <>
                  <div className="space-y-6 text-center">
                    <p className="text-slate-400 text-lg">Some days your body says stop.</p>
                    <p className="text-white text-xl font-medium">You push anyway.</p>
                    <p className="text-slate-500 text-lg">The next day, you pay for it.</p>
                  </div>
                  <button 
                    onClick={() => setOnboardingStep(2)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Next
                  </button>
                </>
              )}

              {/* Screen 2: The missed opportunity */}
              {onboardingStep === 2 && (
                <>
                  <div className="space-y-6 text-center">
                    <p className="text-slate-400 text-lg">Some days you're ready to PR.</p>
                    <p className="text-white text-xl font-medium">But you don't know it. So you hold back.</p>
                    <p className="text-slate-500 text-lg">That day is gone.</p>
                  </div>
                  <button 
                    onClick={() => setOnboardingStep(3)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Next
                  </button>
                </>
              )}

              {/* Screen 3: The pivot */}
              {onboardingStep === 3 && (
                <>
                  <div className="text-center">
                    <p className="text-white text-2xl font-semibold">What if you knew which day was which?</p>
                  </div>
                  <button 
                    onClick={() => setOnboardingStep(4)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Next
                  </button>
                </>
              )}

              {/* Screen 4: The product */}
              {onboardingStep === 4 && (
                <>
                  <div className="space-y-6 text-center">
                    <p className="text-slate-400">One command. Every morning.</p>
                    <div className="flex justify-center gap-6 py-2">
                      <span className="text-red-400 font-black text-3xl">REST</span>
                      <span className="text-amber-400 font-black text-3xl">BUILD</span>
                      <span className="text-green-400 font-black text-3xl">PERFORM</span>
                    </div>
                    <div className="space-y-2 text-slate-500 text-sm">
                      <p>Validated on 2,249 days of real data.</p>
                      <p>When people follow the command, they crash <span className="text-white">2-4x less</span>.</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => setShowOnboarding(false)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Get Started
                  </button>
                  <p className="text-slate-600 text-xs text-center">No wearable? No problem — we'll show you a free option.</p>
                </>
              )}

            </div>
          </div>
        );
      }

      // HRV source selection
      if (!hrvSource) {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
          {/* TEST MODE: Floating Reset Button */}
          <button 
            onClick={() => {
              if (confirm('Reset ALL data and restart onboarding?')) {
                resetAll();
                setShowOnboarding(true);
                setOnboardingStep(1);
                setShowHrvGuide(false);
                setShowInitialSetup(false);
              }
            }}
            className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg z-50 flex items-center gap-1"
          >
            🔄 RESET TEST
          </button>
            <div className="max-w-md mx-auto space-y-6 pt-8">
              <div className="text-center space-y-2">
                <h1 className="text-2xl font-bold">Where do you get your HRV?</h1>
                <p className="text-slate-500 text-sm">We'll show you exactly where to find it</p>
              </div>
              
              <div className="space-y-2">
                {HRV_SOURCES.map(source => (
                  <button
                    key={source.id}
                    onClick={() => {
                      if (source.id !== 'other') {
                        handleOnboardingComplete({ type: source.id, label: source.label });
                      }
                    }}
                    className={`w-full text-left px-4 py-3 rounded-lg transition ${
                      source.id === 'other' 
                        ? 'bg-slate-800/50 text-slate-400' 
                        : 'bg-slate-800 hover:bg-slate-700 text-white'
                    }`}
                  >
                    {source.label}
                  </button>
                ))}
              </div>
              
              {/* Other input */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={otherSourceText}
                  onChange={(e) => setOtherSourceText(e.target.value)}
                  placeholder="Other source..."
                  className="flex-1 min-w-0 bg-slate-800 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                  onClick={() => {
                    if (otherSourceText.trim()) {
                      handleOnboardingComplete({ type: 'other', label: otherSourceText.trim() });
                    }
                  }}
                  disabled={!otherSourceText.trim()}
                  className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg px-4 py-3 font-medium transition shrink-0"
                >
                  Go
                </button>
              </div>

              <div className="text-center text-slate-600 text-xs pt-4">
                Don't have a wearable? Select <span className="text-slate-400">Welltory</span> — it's free and uses your phone camera.
              </div>
            </div>
          </div>
        );
      }

      // HRV Guide screen (shows after device selection)
      if (showHrvGuide) {
        const guide = HRV_GUIDES[hrvSource.type] || HRV_GUIDES.other;
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
          {/* TEST MODE: Floating Reset Button */}
          <button 
            onClick={() => {
              if (confirm('Reset ALL data and restart onboarding?')) {
                resetAll();
                setShowOnboarding(true);
                setOnboardingStep(1);
                setShowHrvGuide(false);
                setShowInitialSetup(false);
              }
            }}
            className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg z-50 flex items-center gap-1"
          >
            🔄 RESET TEST
          </button>
            <div className="max-w-md mx-auto space-y-6 pt-8">
              
              <div className="text-center space-y-2">
                <h1 className="text-2xl font-bold">{guide.title}</h1>
              </div>

              {/* What is HRV */}
              <div className="bg-slate-800/50 rounded-xl p-4 space-y-2">
                <h3 className="text-slate-400 text-xs uppercase tracking-wide">What is HRV?</h3>
                <p className="text-slate-300 text-sm">Heart Rate Variability — the variation in time between heartbeats. Higher usually means more recovered. It's measured in milliseconds (ms).</p>
                <p className="text-slate-500 text-xs">Most people range from 20-100ms. Yours will vary day to day.</p>
              </div>

              {/* Steps */}
              <div className="bg-slate-800 rounded-xl p-4 space-y-3">
                <h3 className="text-slate-400 text-xs uppercase tracking-wide">How to find it</h3>
                <ol className="space-y-3">
                  {guide.steps.map((step, i) => (
                    <li key={i} className="flex gap-3 text-sm">
                      <span className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center shrink-0 text-xs font-bold">{i + 1}</span>
                      <span className="text-slate-300">{step}</span>
                    </li>
                  ))}
                </ol>
              </div>

              <button 
                onClick={handleHrvGuideComplete}
                className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
              >
                Got it — Let's Start
              </button>

              <button 
                onClick={() => {
                  setHrvSource(null);
                  setShowHrvGuide(false);
                }}
                className="w-full text-slate-600 text-sm py-2 hover:text-slate-400 transition"
              >
                ← Choose different device
              </button>
            </div>
          </div>
        );
      }

      // Initial Setup - Import historical data after onboarding
      if (showInitialSetup) {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
          {/* TEST MODE: Floating Reset Button */}
          <button 
            onClick={() => {
              if (confirm('Reset ALL data and restart onboarding?')) {
                resetAll();
                setShowOnboarding(true);
                setOnboardingStep(1);
                setShowHrvGuide(false);
                setShowInitialSetup(false);
              }
            }}
            className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg z-50 flex items-center gap-1"
          >
            🔄 RESET TEST
          </button>
            <div className="max-w-md mx-auto space-y-6 pt-8">
              
              <div className="text-center space-y-2">
                <h1 className="text-2xl font-bold">Build Your Baseline</h1>
                <p className="text-slate-400 text-sm">Add your recent HRV readings to get accurate commands faster</p>
              </div>

              {/* Name input */}
              <div className="bg-slate-800 rounded-xl p-4">
                <label className="text-xs text-slate-500 uppercase tracking-wide block mb-2">Your name</label>
                <input 
                  type="text" 
                  value={userName} 
                  onChange={(e) => setUserName(e.target.value)} 
                  placeholder="Enter your name"
                  className="w-full bg-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              {/* Historical data entry */}
              <div className="bg-slate-800 rounded-xl p-4 space-y-4">
                <div>
                  <label className="text-xs text-slate-500 uppercase tracking-wide block mb-2">Add past HRV readings</label>
                  <p className="text-slate-500 text-xs mb-3">Look back at your last 7-14 days if you have them</p>
                </div>
                
                <div className="flex gap-2">
                  <input 
                    type="number" 
                    value={newEntry} 
                    onChange={(e) => setNewEntry(e.target.value)} 
                    onKeyDown={(e) => e.key === 'Enter' && addToHistory()} 
                    placeholder="HRV (ms)" 
                    className="w-24 bg-slate-700 rounded-lg px-3 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                  />
                  <input 
                    type="date" 
                    value={newEntryDate} 
                    onChange={(e) => setNewEntryDate(e.target.value)} 
                    className="flex-1 min-w-0 bg-slate-700 rounded-lg px-3 py-3 text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                  />
                  <button 
                    onClick={addToHistory} 
                    className="bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-3 font-medium transition shrink-0"
                  >
                    Add
                  </button>
                </div>

                {/* Show added entries */}
                {hrvHistory.length > 0 && (
                  <div className="space-y-1 pt-2 max-h-32 overflow-y-auto">
                    {[...hrvHistory].reverse().map((entry, i) => (
                      <div key={i} className="flex justify-between items-center text-sm text-slate-400 py-1 border-b border-slate-700/50">
                        <span>{entry.date}</span>
                        <div className="flex items-center gap-3">
                          <span className="font-mono">{entry.value} ms</span>
                          <button onClick={() => removeFromHistory(i)} className="text-red-400/60 hover:text-red-400">✕</button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Progress indicator */}
                <div className="text-center pt-2">
                  <div className="text-slate-500 text-sm">
                    {hrvHistory.length === 0 ? (
                      "No readings yet"
                    ) : hrvHistory.length < 3 ? (
                      <span>{hrvHistory.length} reading{hrvHistory.length !== 1 ? 's' : ''} — need {3 - hrvHistory.length} more for commands</span>
                    ) : hrvHistory.length < 7 ? (
                      <span className="text-blue-400">{hrvHistory.length} readings — good start!</span>
                    ) : (
                      <span className="text-green-400">✓ {hrvHistory.length} readings — great baseline!</span>
                    )}
                  </div>
                </div>
              </div>

              <button 
                onClick={() => setShowInitialSetup(false)}
                className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
              >
                {hrvHistory.length >= 3 ? "Start Using GENYSYS" : "Skip — I'll add data daily"}
              </button>

              <p className="text-slate-600 text-xs text-center">
                You can always add historical data later
              </p>
            </div>
          </div>
        );
      }

      const prescription = result && !result.error ? PRESCRIPTIONS[result.commandKey] : null;

      return (
        <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
          {/* TEST MODE: Floating Reset Button */}
          <button 
            onClick={() => {
              if (confirm('Reset ALL data and restart onboarding?')) {
                resetAll();
                setShowOnboarding(true);
                setOnboardingStep(1);
                setShowHrvGuide(false);
                setShowInitialSetup(false);
              }
            }}
            className="fixed bottom-4 right-4 bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-2 rounded-lg shadow-lg z-50 flex items-center gap-1"
          >
            🔄 RESET TEST
          </button>
          
          <div className="max-w-md mx-auto space-y-4">
            
            {/* Header */}
            <div className="flex items-center justify-between pt-2 pb-1">
              <div className="flex items-center gap-2">
                <div className="text-xs text-slate-600">{hrvSource?.label}</div>
                <button onClick={() => setShowInfo(true)} className="text-slate-500 hover:text-slate-300 text-sm">ℹ</button>
              </div>
              <div className="flex items-center gap-2">
                {editingName ? (
                  <input 
                    type="text" 
                    value={userName} 
                    onChange={(e) => setUserName(e.target.value)} 
                    onBlur={() => setEditingName(false)}
                    onKeyDown={(e) => e.key === 'Enter' && setEditingName(false)}
                    autoFocus
                    className="text-xs text-slate-300 bg-slate-800 rounded px-2 py-1 w-24 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    placeholder="Your name"
                  />
                ) : (
                  <button 
                    onClick={() => setEditingName(true)} 
                    className="text-xs text-slate-500 hover:text-slate-300 transition"
                  >
                    {userName || 'Add name'}
                  </button>
                )}
              </div>
            </div>

            {/* Info Modal */}
            {showInfo && <InfoModal onClose={() => setShowInfo(false)} hrvSource={hrvSource} />}
            {showFeedback && <FeedbackModal step={feedbackStep} setStep={setFeedbackStep} useful={feedbackUseful} setUseful={setFeedbackUseful} improvement={feedbackImprovement} setImprovement={setFeedbackImprovement} email={feedbackEmail} setEmail={setFeedbackEmail} onSend={sendFeedback} onDismiss={dismissFeedback} getDaysSinceFirstUse={getDaysSinceFirstUse} />}

            {/* Missed Yesterday Alert */}
            {missedYesterdayHRV() && !hasTodayHRV && (
              <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3 flex items-center justify-between">
                <div className="text-amber-400 text-sm">You missed yesterday's HRV</div>
                <button 
                  onClick={() => {
                    setNewEntryDate(getYesterdayLocal());
                    setShowAddHrv(true);
                  }}
                  className="text-amber-400 text-sm font-medium hover:text-amber-300"
                >
                  Add it →
                </button>
              </div>
            )}

            {/* Yesterday - Simple one-tap log */}
            {needsYesterdayCompliance && (
              <div className="bg-slate-800/80 rounded-xl p-4">
                <div className="text-center mb-3">
                  <span className="text-slate-500 text-sm">Yesterday: </span>
                  <span className="text-lg font-semibold" style={{ color: PRESCRIPTIONS[yesterdayData.command]?.color || '#6B7280' }}>{yesterdayData.command}</span>
                </div>
                <div className="flex gap-3">
                  <button onClick={() => recordYesterdayCompliance('yes')} className="flex-1 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg py-3 text-sm font-medium transition">
                    {yesterdayData.command === 'REST' ? 'Rested' : 'Trained'}
                  </button>
                  <button onClick={() => recordYesterdayCompliance('no')} className="flex-1 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg py-3 text-sm font-medium transition">
                    {yesterdayData.command === 'REST' ? 'Trained' : 'Rested'}
                  </button>
                </div>
              </div>
            )}
            
            {/* TODAY'S HRV INPUT - Show prominently if not entered */}
            {!hasTodayHRV && (
              <div className="bg-slate-800 rounded-2xl p-6 space-y-4">
                <div className="text-center">
                  <div className="text-slate-400 text-sm mb-1">Good morning{userName ? `, ${userName}` : ''}</div>
                  <div className="text-white text-xl font-semibold">What's your HRV today?</div>
                </div>
                <div className="flex gap-3">
                  <input 
                    type="number" 
                    value={todayHRV} 
                    onChange={(e) => setTodayHRV(e.target.value)} 
                    onKeyDown={(e) => e.key === 'Enter' && calculateCommand()} 
                    placeholder="Enter HRV" 
                    className="flex-1 min-w-0 bg-slate-700 rounded-xl px-4 py-4 text-2xl text-center font-mono text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    autoFocus
                  />
                  <button 
                    onClick={calculateCommand} 
                    className="bg-blue-600 hover:bg-blue-700 rounded-xl px-6 py-4 font-bold text-lg transition shrink-0"
                  >
                    GO
                  </button>
                </div>
                <div className="text-center text-slate-600 text-xs">
                  Find it in your {hrvSource?.label || 'wearable'} app
                </div>
              </div>
            )}

            {/* HERO - Command + Action + Promise + Proof */}
            {hasTodayHRV && prescription && (
              <div className="rounded-3xl p-8 text-center" style={{ backgroundColor: prescription.bg, border: `1px solid ${prescription.color}40` }}>
                
                {/* THE COMMAND */}
                <div className="text-7xl font-black tracking-tight mb-4" style={{ color: prescription.color }}>
                  {prescription.headline}
                </div>
                
                {/* THE ACTION */}
                <div className="text-xl text-slate-200 font-medium mb-3">
                  {prescription.action}
                </div>
                
                {/* THE PROMISE */}
                <div className="text-slate-400 text-base mb-6">
                  {prescription.promise}
                </div>
                
                {/* THE PROOF */}
                {commandContext && (
                  <div className={`text-sm py-3 px-4 rounded-xl ${
                    commandContext.type === 'warning' ? 'bg-red-500/10 text-red-400' :
                    commandContext.type === 'affirm' ? 'bg-green-500/10 text-green-400' :
                    commandContext.type === 'earned' ? 'bg-emerald-500/10 text-emerald-400' :
                    'bg-slate-700/30 text-slate-400'
                  }`}>
                    {commandContext.text}
                  </div>
                )}
                
                {/* Learning state */}
                {result.daysNeeded && (
                  <div className="text-amber-400/80 text-sm mt-4">
                    {result.daysNeeded} more day{result.daysNeeded > 1 ? 's' : ''} to calibrate
                  </div>
                )}
                
                {/* Preview indicator */}
                {result.isPreview && (
                  <div className="text-slate-500 text-xs mt-4">
                    Preview — {result.daysUntilFull} more day{result.daysUntilFull !== 1 ? 's' : ''} for full accuracy
                  </div>
                )}
              </div>
            )}

            {/* Error state */}
            {result?.error && <div className="bg-red-900/30 text-red-400 rounded-xl p-4 text-center">{result.error}</div>}

            {/* Add Historical Data Modal */}
            {showAddHrv && (
              <div className="fixed inset-0 bg-black/70 flex items-end justify-center z-50">
                <div className="bg-slate-800 rounded-t-2xl p-6 w-full max-w-md space-y-4">
                  <div className="flex justify-between items-center">
                    <h3 className="text-lg font-semibold text-white">Add Past HRV</h3>
                    <button onClick={() => setShowAddHrv(false)} className="text-slate-400 hover:text-white text-2xl leading-none">×</button>
                  </div>
                  
                  <div className="flex gap-2">
                    <input 
                      type="number" 
                      value={newEntry} 
                      onChange={(e) => setNewEntry(e.target.value)} 
                      onKeyDown={(e) => e.key === 'Enter' && addToHistory()} 
                      placeholder="HRV (ms)" 
                      className="w-28 bg-slate-700 rounded-lg px-3 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      autoFocus
                    />
                    <input 
                      type="date" 
                      value={newEntryDate} 
                      onChange={(e) => setNewEntryDate(e.target.value)} 
                      className="flex-1 min-w-0 bg-slate-700 rounded-lg px-3 py-3 text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    />
                    <button 
                      onClick={addToHistory} 
                      className="bg-blue-600 hover:bg-blue-700 rounded-lg px-5 py-3 font-semibold transition shrink-0"
                    >
                      Add
                    </button>
                  </div>

                  {/* Recent history */}
                  {hrvHistory.length > 0 && (
                    <div className="space-y-1 max-h-48 overflow-y-auto">
                      <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Your entries</div>
                      {[...hrvHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 14).map((entry, i) => (
                        <div key={entry.date} className="flex justify-between items-center text-sm text-slate-400 py-2 border-b border-slate-700/50">
                          <span>{entry.date}</span>
                          <div className="flex items-center gap-3">
                            <span className="font-mono">{entry.value} ms</span>
                            <button onClick={() => {
                              const idx = hrvHistory.findIndex(h => h.date === entry.date);
                              if (idx !== -1) removeFromHistory(idx);
                            }} className="text-red-400/60 hover:text-red-400">×</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Done button */}
                  <button 
                    onClick={() => setShowAddHrv(false)} 
                    className="w-full bg-slate-700 hover:bg-slate-600 text-white font-medium py-3 rounded-lg transition"
                  >
                    Done
                  </button>
                </div>
              </div>
            )}

            {/* Minimal Footer */}
            <div className="flex items-center justify-between pt-4 pb-2">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => setShowAddHrv(true)} 
                  className="text-slate-600 hover:text-slate-400 text-xs flex items-center gap-1 transition"
                >
                  <span className="text-lg">+</span> Add past HRV
                </button>
              </div>
              <div className="flex items-center gap-3">
                {hrvHistory.length > 0 && (
                  <span className="text-slate-700 text-xs">{hrvHistory.length} days logged</span>
                )}
                <button 
                  onClick={() => setShowInfo(true)} 
                  className="text-slate-600 hover:text-slate-400 text-xs transition"
                >
                  Help
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
