<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0A0A0A">
  <title>GENYSYS — TEST MODE</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js" crossorigin="anonymous"></script>
  
  <style>
    :root {
      --bg-primary: #0A0A0A;
      --bg-elevated: #111111;
      --bg-card: #141414;
      --text-primary: #F5F5F0;
      --text-secondary: #A1A1AA;
      --text-muted: #52525B;
      --text-faint: #3F3F46;
      --gold: #C9A962;
      --gold-dim: rgba(201, 169, 98, 0.15);
      --green: #6EE7B7;
      --rose: #FDA4AF;
      --amber: #FCD34D;
      --bg-test: #1a1a0a;
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-body); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
    .font-display { font-family: var(--font-display); font-weight: 300; letter-spacing: 0.02em; }
    
    @keyframes fadeRise { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    
    .animate-rise { animation: fadeRise 400ms ease-out forwards; }
    .animate-fade { animation: fadeIn 400ms ease-out forwards; }
    .delay-100 { animation-delay: 100ms; opacity: 0; }
    .delay-200 { animation-delay: 200ms; opacity: 0; }
    .delay-300 { animation-delay: 300ms; opacity: 0; }
    .delay-400 { animation-delay: 400ms; opacity: 0; }
    .delay-500 { animation-delay: 500ms; opacity: 0; }
    .delay-1000 { animation-delay: 1000ms; opacity: 0; }
    .delay-1500 { animation-delay: 1500ms; opacity: 0; }
    .delay-2000 { animation-delay: 2000ms; opacity: 0; }
    
    .btn-primary {
      background: transparent;
      border: 1px solid var(--text-faint);
      color: var(--text-secondary);
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 15px;
      cursor: pointer;
      transition: all 150ms ease;
      width: 100%;
    }
    .btn-primary:active { background: var(--bg-elevated); border-color: var(--gold); color: var(--gold); }
    .btn-primary.active { background: var(--bg-elevated); border-color: var(--gold); color: var(--gold); }
    
    .btn-ghost { background: transparent; border: none; color: var(--text-muted); padding: 12px 24px; font-size: 13px; cursor: pointer; transition: color 150ms ease; }
    .btn-ghost:hover { color: var(--text-secondary); }
    
    .input-minimal {
      background: transparent;
      border: 1px solid var(--text-faint);
      border-radius: 12px;
      padding: 16px 20px;
      color: var(--text-primary);
      font-size: 17px;
      font-family: var(--font-body);
      width: 100%;
      text-align: center;
      outline: none;
      transition: border-color 150ms ease;
    }
    .input-minimal:focus { border-color: var(--gold); }
    .input-minimal::placeholder { color: var(--text-muted); }
    
    .divider { height: 1px; background: var(--text-faint); opacity: 0.3; margin: 24px 0; }
    
    .insight-block {
      border-left: 2px solid var(--gold);
      padding-left: 24px;
      margin-top: 32px;
      opacity: 0.85;
    }
    .insight-block .label { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
    .insight-block .content { font-family: var(--font-display); font-style: italic; font-size: 15px; line-height: 1.8; color: var(--text-secondary); }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 100; }
    .modal-content { position: fixed; inset: 0; z-index: 101; overflow-y: auto; }
    
    ::-webkit-scrollbar { width: 0; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"] { -moz-appearance: textfield; }
    
    /* TEST MODE STYLES */
    .btn-test { background: var(--bg-test); border: 1px solid var(--amber); color: var(--amber); padding: 8px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 150ms ease; white-space: nowrap; }
    .btn-test:hover { background: rgba(252, 211, 77, 0.1); }
    .btn-test.active { background: var(--amber); color: #000; }
    
    .test-badge { position: fixed; top: 12px; right: 12px; background: var(--amber); color: #000; font-size: 9px; font-weight: 600; padding: 4px 10px; border-radius: 4px; letter-spacing: 0.1em; z-index: 200; }
    
    .test-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-test); border-top: 2px solid var(--amber); z-index: 100; max-height: 60vh; overflow-y: auto; }
    .test-panel-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(252,211,77,0.2); background: rgba(0,0,0,0.3); }
    .test-panel-content { padding: 16px; }
    
    .test-section { margin-bottom: 20px; }
    .test-section-title { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--amber); margin-bottom: 10px; opacity: 0.8; }
    
    .test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
    
    .test-stat { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; }
    .test-stat-label { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
    .test-stat-value { font-size: 14px; color: var(--text-primary); font-weight: 500; }
    
    .test-input { background: rgba(0,0,0,0.4); border: 1px solid rgba(252,211,77,0.3); border-radius: 6px; padding: 8px 12px; color: var(--text-primary); font-size: 13px; width: 100%; }
    .test-input:focus { border-color: var(--amber); outline: none; }
    
    .milestone-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-radius: 6px; margin-bottom: 4px; font-size: 12px; }
    .milestone-item.current { background: rgba(252,211,77,0.15); color: var(--amber); }
    .milestone-item.reached { background: rgba(110,231,183,0.1); color: var(--green); }
    .milestone-item.future { background: rgba(0,0,0,0.2); color: var(--text-muted); }
    
    input[type="file"] { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ============================================
    // ANALYTICS
    // ============================================
    const ANALYTICS_ENDPOINT = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
    const ALLOWED_EVENTS = [
      'session_start', 'onboarding_complete', 'first_hrv_logged', 'hrv_logged',
      'hrv_backfilled', 'command_generated', 'compliance_recorded',
      'day_3_active', 'day_7_active', 'day_14_active', 'day_30_active', 'day_60_active', 'day_90_active',
      'milestone_reached', 'observation_shown',
      'feedback_round1_submitted', 'feedback_round1_dismissed', 
      'feedback_round2_submitted', 'feedback_round2_dismissed',
      'data_exported', 'data_reset', 'legacy_user_migrated'
    ];

    const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });

    const Analytics = {
      userId: null,
      timezone: null,
      device: null,
      firstUseDate: null,

      init() {
        const stored = localStorage.getItem('genysys_analytics');
        if (stored) {
          const data = JSON.parse(stored);
          Object.assign(this, data);
        } else {
          this.userId = generateUUID();
          this.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          this.firstUseDate = getTodayLocal();
          this.save();
        }
      },

      save() {
        localStorage.setItem('genysys_analytics', JSON.stringify({
          userId: this.userId, timezone: this.timezone, firstUseDate: this.firstUseDate
        }));
      },

      setDevice(device) { this.device = device; },
      
      getDaysActive() {
        if (!this.firstUseDate) return 0;
        return Math.floor((new Date() - new Date(this.firstUseDate)) / (1000 * 60 * 60 * 24));
      },

      track(event, props = {}) {
        if (!ALLOWED_EVENTS.includes(event)) return;
        const payload = {
          timestamp: new Date().toISOString(),
          userId: this.userId,
          event,
          device: this.device || props.device || 'unknown',
          daysActive: this.getDaysActive(),
          region: this.timezone,
          ...props
        };
        console.log('[Analytics]', event, payload);
        if (ANALYTICS_ENDPOINT !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
          fetch(ANALYTICS_ENDPOINT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }).catch(() => {});
        }
      }
    };

    Analytics.init();

    // ============================================
    // UTILITIES
    // ============================================
    const getLocalDateString = (date = new Date()) => {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    };
    const getTodayLocal = () => getLocalDateString();
    const getYesterdayLocal = () => {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      return getLocalDateString(d);
    };
    const getDayName = (dateStr) => ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][new Date(dateStr).getDay()];
    const formatDateAnchor = (dateStr) => {
      if (!dateStr) return null;
      const date = new Date(dateStr + 'T12:00:00');
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const day = date.getDate();
      const suffix = [1,21,31].includes(day) ? 'st' : [2,22].includes(day) ? 'nd' : [3,23].includes(day) ? 'rd' : 'th';
      return `${months[date.getMonth()]} ${day}${suffix}`;
    };

    // ============================================
    // TEST UTILITIES
    // ============================================
    const parseWHOOPCSV = (csvText) => {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      
      // Find column indices
      const dateCol = headers.findIndex(h => h.toLowerCase().includes('cycle start') || h.toLowerCase().includes('date'));
      const hrvCol = headers.findIndex(h => h.toLowerCase().includes('heart rate variability') || h.toLowerCase() === 'hrv');
      const tzCol = headers.findIndex(h => h.toLowerCase().includes('timezone'));
      
      if (dateCol === -1 || hrvCol === -1) {
        console.error('Could not find date or HRV columns', headers);
        return { entries: [], timezones: [] };
      }
      
      const entries = [];
      const timezones = [];
      
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const dateStr = row[dateCol];
        const hrvVal = parseFloat(row[hrvCol]);
        const tz = tzCol !== -1 ? row[tzCol] : null;
        
        if (dateStr && !isNaN(hrvVal) && hrvVal > 0) {
          // Parse date - handle various formats
          let date;
          if (dateStr.includes(' ')) {
            date = dateStr.split(' ')[0]; // Take date part only
          } else {
            date = dateStr;
          }
          // Normalize to YYYY-MM-DD
          if (date.includes('/')) {
            const parts = date.split('/');
            if (parts[2].length === 4) {
              date = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
            }
          }
          
          entries.push({ date, value: Math.round(hrvVal) });
          if (tz) timezones.push({ date, timezone: tz });
        }
      }
      
      // Sort by date and remove duplicates (keep latest)
      entries.sort((a, b) => new Date(a.date) - new Date(b.date));
      const uniqueEntries = [];
      const seenDates = new Set();
      for (let i = entries.length - 1; i >= 0; i--) {
        if (!seenDates.has(entries[i].date)) {
          seenDates.add(entries[i].date);
          uniqueEntries.unshift(entries[i]);
        }
      }
      
      return { entries: uniqueEntries, timezones };
    };

    const generateTestComplianceLog = (hrvHistory, complianceRate = 0.7) => {
      const log = [];
      for (let i = 0; i < hrvHistory.length - 1; i++) {
        const entry = hrvHistory[i];
        const values = hrvHistory.slice(0, i + 1).map(h => h.value);
        if (values.length < 7) continue;
        
        const median = calculateMedian(values);
        const mad = calculateMAD(values, median);
        const zScore = (entry.value - median) / mad;
        const command = getCommandKey(zScore);
        
        if (command === 'REST') {
          const followed = Math.random() < complianceRate ? 'yes' : 'no';
          log.push({ date: entry.date, command, followed });
        }
      }
      return log;
    };

    const MILESTONES = [7, 14, 21, 30, 45, 60, 90, 180, 365];

    // ============================================
    // ALGORITHM (Validated - DO NOT MODIFY)
    // ============================================
    const THRESHOLDS = { REST: -1.0, PERFORM: 0.5, MIN_DAYS: 7, MAD_FLOOR: 3.0 };

    const calculateMedian = (arr) => {
      const sorted = [...arr].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    };

    const calculateMAD = (arr, median) => {
      const deviations = arr.map(v => Math.abs(v - median)).sort((a, b) => a - b);
      return Math.max(calculateMedian(deviations) * 1.4826, THRESHOLDS.MAD_FLOOR);
    };

    const getCommandKey = (zScore) => {
      if (zScore === null) return 'LEARNING';
      if (zScore < THRESHOLDS.REST) return 'REST';
      if (zScore >= THRESHOLDS.PERFORM) return 'PERFORM';
      return 'BUILD';
    };

    // ============================================
    // PATTERN ENGINE
    // ============================================
    const analyzePatterns = (hrvHistory, complianceLog = [], firstUseDate) => {
      if (hrvHistory.length < 3) return null;

      const values = hrvHistory.map(h => h.value);
      const median = calculateMedian(values);
      const mad = calculateMAD(values, median);

      const withZScores = hrvHistory.map(h => ({
        ...h,
        zScore: (h.value - median) / mad,
        command: getCommandKey((h.value - median) / mad)
      })).sort((a, b) => new Date(a.date) - new Date(b.date));

      const patterns = {
        baseline: median,
        mad,
        totalDays: hrvHistory.length,
        restDays: withZScores.filter(h => h.command === 'REST').length,
        buildDays: withZScores.filter(h => h.command === 'BUILD').length,
        performDays: withZScores.filter(h => h.command === 'PERFORM').length,
        crashesAfterIgnoredRest: [],
        recoveriesAfterRest: [],
        trend: null,
        consecutiveBelowBaseline: 0,
        consecutiveAboveBaseline: 0,
        consecutiveRestDays: 0,
        nearestMatch: null,
        lastPerformDate: null,
        daysSincePerform: null,
        lastRestDate: null,
        daysSinceRest: null,
        isVolatile: false,
        isStable: false,
        isTravel: false,
        weekendSplit: null,
        weakDay: null,
        strongDay: null,
        declineTrend: null,
        baselineShift: null,
      };

      // Trend analysis (last 5 days)
      const recent = withZScores.slice(-5);
      if (recent.length >= 3) {
        let rising = 0, falling = 0;
        for (let i = 1; i < recent.length; i++) {
          if (recent[i].zScore > recent[i-1].zScore) rising++;
          else if (recent[i].zScore < recent[i-1].zScore) falling++;
        }
        patterns.trend = rising >= 3 ? 'rising' : falling >= 3 ? 'falling' : 'stable';
      }

      // Declining trend detection (4+ days)
      if (recent.length >= 4) {
        let declining = true;
        for (let i = 1; i < recent.length && declining; i++) {
          if (recent[i].value >= recent[i-1].value) declining = false;
        }
        if (declining) {
          patterns.declineTrend = {
            days: recent.length,
            values: recent.map(r => r.value),
            drop: recent[0].value - recent[recent.length - 1].value
          };
        }
      }

      // Consecutive days tracking
      const reversed = [...withZScores].reverse();
      for (const h of reversed) {
        if (h.zScore < 0) patterns.consecutiveBelowBaseline++;
        else break;
      }
      patterns.consecutiveAboveBaseline = 0;
      for (const h of reversed) {
        if (h.zScore > 0) patterns.consecutiveAboveBaseline++;
        else break;
      }

      // Consecutive REST days
      for (const h of reversed) {
        if (h.command === 'REST') patterns.consecutiveRestDays++;
        else break;
      }

      // Last PERFORM
      const performDays = withZScores.filter(h => h.command === 'PERFORM');
      if (performDays.length > 0) {
        const lastPerform = performDays[performDays.length - 1];
        patterns.lastPerformDate = lastPerform.date;
        patterns.daysSincePerform = Math.floor((new Date(getTodayLocal()) - new Date(lastPerform.date)) / (1000 * 60 * 60 * 24));
      }

      // Last REST
      const restDaysHistory = withZScores.filter(h => h.command === 'REST');
      if (restDaysHistory.length > 0) {
        const lastRest = restDaysHistory[restDaysHistory.length - 1];
        patterns.lastRestDate = lastRest.date;
        patterns.daysSinceRest = Math.floor((new Date(getTodayLocal()) - new Date(lastRest.date)) / (1000 * 60 * 60 * 24));
      }

      // Compliance outcomes
      complianceLog.forEach(log => {
        if (!log.command || !log.followed) return;
        const nextDate = new Date(log.date);
        nextDate.setDate(nextDate.getDate() + 1);
        const nextDateStr = getLocalDateString(nextDate);
        const nextDay = withZScores.find(h => h.date === nextDateStr);
        if (!nextDay) return;
        
        if (log.command === 'REST' && log.followed === 'no' && nextDay.zScore < THRESHOLDS.REST) {
          patterns.crashesAfterIgnoredRest.push({ ignoredDate: log.date, crashDate: nextDateStr });
        }
        if (log.command === 'REST' && log.followed === 'yes' && nextDay.zScore >= THRESHOLDS.REST) {
          patterns.recoveriesAfterRest.push({ restDate: log.date, readyDate: nextDateStr });
        }
      });

      // Volatility
      const zScoreStd = Math.sqrt(withZScores.reduce((sum, h) => sum + Math.pow(h.zScore, 2), 0) / withZScores.length);
      patterns.isVolatile = zScoreStd > 1.5;
      patterns.isStable = zScoreStd < 0.8;

      // Travel detection (big swing in last 3 days)
      const recent3 = withZScores.slice(-3);
      if (recent3.length >= 3) {
        const recent3Zs = recent3.map(h => h.zScore);
        const range = Math.max(...recent3Zs) - Math.min(...recent3Zs);
        patterns.isTravel = range > 2.5;
      }

      // Day-of-week patterns
      const dayOfWeekStats = {};
      withZScores.forEach(h => {
        const dow = new Date(h.date).getDay();
        if (!dayOfWeekStats[dow]) dayOfWeekStats[dow] = { sum: 0, count: 0, values: [] };
        dayOfWeekStats[dow].sum += h.zScore;
        dayOfWeekStats[dow].count++;
        dayOfWeekStats[dow].values.push(h.value);
      });
      
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      let worstDay = null, worstAvg = Infinity;
      let bestDay = null, bestAvg = -Infinity;
      
      Object.entries(dayOfWeekStats).forEach(([dow, stats]) => {
        if (stats.count >= 2) {
          const avg = stats.sum / stats.count;
          if (avg < worstAvg) { worstAvg = avg; worstDay = parseInt(dow); }
          if (avg > bestAvg) { bestAvg = avg; bestDay = parseInt(dow); }
        }
      });
      
      if (worstDay !== null && worstAvg < -0.3) patterns.weakDay = { day: dayNames[worstDay], avgZ: worstAvg };
      if (bestDay !== null && bestAvg > 0.3) patterns.strongDay = { day: dayNames[bestDay], avgZ: bestAvg };

      // Weekend split
      const weekdayValues = withZScores.filter(h => { const d = new Date(h.date).getDay(); return d >= 1 && d <= 5; }).map(h => h.value);
      const weekendValues = withZScores.filter(h => { const d = new Date(h.date).getDay(); return d === 0 || d === 6; }).map(h => h.value);
      
      if (weekdayValues.length >= 3 && weekendValues.length >= 2) {
        const weekdayMean = weekdayValues.reduce((a, b) => a + b, 0) / weekdayValues.length;
        const weekendMean = weekendValues.reduce((a, b) => a + b, 0) / weekendValues.length;
        const spread = weekendMean - weekdayMean;
        if (Math.abs(spread) >= 3) {
          patterns.weekendSplit = { weekdayMean: Math.round(weekdayMean), weekendMean: Math.round(weekendMean), spread: Math.round(spread) };
        }
      }

      // Baseline shift (compare first 14 days to last 14 days if 60+ days)
      if (hrvHistory.length >= 60) {
        const first14 = withZScores.slice(0, 14).map(h => h.value);
        const last14 = withZScores.slice(-14).map(h => h.value);
        const firstBaseline = first14.reduce((a, b) => a + b, 0) / first14.length;
        const lastBaseline = last14.reduce((a, b) => a + b, 0) / last14.length;
        const shift = lastBaseline - firstBaseline;
        const shiftPercent = Math.round((shift / firstBaseline) * 100);
        if (Math.abs(shiftPercent) >= 5) {
          patterns.baselineShift = { from: Math.round(firstBaseline), to: Math.round(lastBaseline), percent: shiftPercent };
        }
      }

      // Nearest historical match
      const today = hrvHistory.find(h => h.date === getTodayLocal());
      if (today) {
        const todayZ = (today.value - median) / mad;
        let nearest = null;
        let nearestDiff = Infinity;
        
        withZScores.forEach(h => {
          if (h.date === getTodayLocal()) return;
          const diff = Math.abs(h.zScore - todayZ);
          if (diff < nearestDiff && diff < 0.5) {
            nearestDiff = diff;
            nearest = h;
          }
        });
        
        if (nearest) {
          const nextDate = new Date(nearest.date);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = getLocalDateString(nextDate);
          const compliance = complianceLog.find(c => c.date === nearest.date);
          const nextDay = withZScores.find(h => h.date === nextDateStr);
          
          patterns.nearestMatch = {
            date: nearest.date,
            zScore: nearest.zScore,
            command: nearest.command,
            pushed: compliance?.followed === 'no',
            rested: compliance?.followed === 'yes',
            nextDayCrashed: nextDay ? nextDay.zScore < THRESHOLDS.REST : null,
            nextDayRecovered: nextDay ? nextDay.zScore >= 0 : null
          };
        }
      }

      return patterns;
    };

    // ============================================
    // CONFIDENCE SYSTEM
    // ============================================
    const calculateConfidence = (hrvHistory, patterns, complianceLog = []) => {
      if (!patterns || hrvHistory.length < 14) {
        return { level: 'low', score: 30, reason: 'early_onboarding' };
      }
      
      const todayEntry = hrvHistory.find(h => h.date === getTodayLocal());
      let signalScore = 15;
      
      if (todayEntry && patterns.baseline && patterns.mad) {
        const robustZ = Math.abs((todayEntry.value - patterns.baseline) / patterns.mad);
        signalScore = robustZ < 0.7 ? 15 : robustZ < 1.5 ? 30 : 45;
      }
      
      let qualityScore = hrvHistory.length >= 30 ? 25 : hrvHistory.length >= 21 ? 20 : hrvHistory.length >= 14 ? 15 : 10;
      
      const hasYesterday = hrvHistory.some(h => h.date === getYesterdayLocal());
      if (!hasYesterday) qualityScore = Math.max(10, qualityScore - 10);
      
      let supportScore = 5;
      if (patterns.nearestMatch) {
        const today = hrvHistory.find(h => h.date === getTodayLocal());
        if (today) {
          const todayZ = (today.value - patterns.baseline) / patterns.mad;
          const todayCommand = getCommandKey(todayZ);
          const similarDays = hrvHistory.filter(h => {
            if (h.date === getTodayLocal()) return false;
            const z = (h.value - patterns.baseline) / patterns.mad;
            return getCommandKey(z) === todayCommand && Math.abs(z - todayZ) < 0.8;
          });
          supportScore = similarDays.length >= 4 ? 20 : similarDays.length >= 2 ? 12 : 5;
        }
      }
      
      const totalScore = signalScore + qualityScore + supportScore;
      let level = totalScore >= 75 ? 'high' : totalScore >= 50 ? 'medium' : 'low';
      
      if (patterns.isVolatile && level === 'high') level = 'medium';
      if (patterns.isTravel) level = 'low';
      
      return { level, score: totalScore, reason: level === 'low' ? 'insufficient_evidence' : level === 'medium' ? 'moderate_evidence' : 'strong_evidence' };
    };

    // ============================================
    // MODE SYSTEM (DIRECTIVE / PROTECTIVE / UNCERTAIN)
    // ============================================
    const getMode = (confidence, complianceLog, daysOnApp) => {
      if (confidence.level === 'low' || daysOnApp < 14) return 'UNCERTAIN';
      
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const recentOverrides = complianceLog.filter(log => new Date(log.date) >= sevenDaysAgo && log.followed === 'no').length;
      
      const yesterdayLog = complianceLog.find(c => c.date === getYesterdayLocal());
      const ignoredYesterdayRest = yesterdayLog?.command === 'REST' && yesterdayLog?.followed === 'no';
      
      if (recentOverrides >= 2 || ignoredYesterdayRest) return 'PROTECTIVE';
      return 'DIRECTIVE';
    };

    // ============================================
    // CONTEXT BUILDER
    // ============================================
    const getContext = (command, patterns, complianceLog, hrvHistory, daysOnApp) => {
      const confidence = calculateConfidence(hrvHistory, patterns, complianceLog);
      const mode = getMode(confidence, complianceLog, daysOnApp);
      
      const context = {
        mode, confidence,
        type: 'default',
        isWarning: false,
        isAfterRest: false,
        isConsecutive: false,
        isTravel: patterns?.isTravel || false,
        trend: patterns?.trend || 'stable'
      };
      
      if (patterns?.isTravel) {
        context.type = 'travel';
        context.isWarning = true;
      } else if (command === 'REST') {
        if (patterns?.trend === 'falling' || confidence.level === 'low') {
          context.isWarning = true;
          context.type = 'warning';
        }
        if (patterns?.consecutiveRestDays >= 2) context.type = 'streak';
      } else if (command === 'BUILD') {
        if (patterns?.trend === 'falling') { context.isWarning = true; context.type = 'warning'; }
        const yesterdayLog = complianceLog.find(c => c.date === getYesterdayLocal());
        if (yesterdayLog?.command === 'REST' && yesterdayLog?.followed === 'yes') {
          context.isAfterRest = true;
          context.type = 'after_rest';
        }
      } else if (command === 'PERFORM') {
        const yesterdayLog = complianceLog.find(c => c.date === getYesterdayLocal());
        if (yesterdayLog?.command === 'PERFORM') { context.isConsecutive = true; context.type = 'consecutive'; }
        if (patterns?.crashesAfterIgnoredRest?.length >= 2) context.isWarning = true;
      }
      
      return context;
    };

    // ============================================
    // OBSERVATION GENERATOR - The Voice
    // ============================================
    const generateObservation = (command, patterns, daysOnApp, hrvHistory, complianceLog = []) => {
      const seed = new Date().getDate();
      const pick = (arr) => arr[seed % arr.length];
      
      if (!patterns) {
        const daysRemaining = 4 - hrvHistory.length;
        if (daysRemaining > 0) return { text: `${daysRemaining} day${daysRemaining > 1 ? 's' : ''} until commands unlock.`, type: 'learning' };
        return { text: "Your baseline is forming.", type: 'learning' };
      }

      const context = getContext(command, patterns, complianceLog, hrvHistory, daysOnApp);
      const { mode, confidence, isTravel, isAfterRest, isConsecutive, isWarning } = context;
      const crashCount = patterns.crashesAfterIgnoredRest?.length || 0;
      const canPersonalize = daysOnApp >= 14 && confidence.level !== 'low';

      // TRAVEL override
      if (isTravel) {
        return { text: "Signal disrupted. Timezone, travel, or major change detected.", type: 'travel' };
      }

      // REST
      if (command === 'REST') {
        // Date anchor (pattern match warning)
        if (canPersonalize && patterns.nearestMatch?.nextDayCrashed) {
          const anchor = formatDateAnchor(patterns.nearestMatch.date);
          if (anchor) return { text: `This looks like ${anchor}. That day cost you.`, type: 'rest_date_anchor' };
        }
        
        // Proof (crash count)
        if (canPersonalize && crashCount >= 2) {
          return { text: `${crashCount} times you've pushed through REST. ${crashCount} times you paid.`, type: 'rest_proof' };
        }

        // Streak REST
        if (patterns.consecutiveRestDays >= 2) {
          return pick([
            { text: `Day ${patterns.consecutiveRestDays}. The adaptation is deepening.`, type: 'rest_streak' },
            { text: "Still building. The foundation is almost set.", type: 'rest_streak' }
          ]);
        }
        
        if (mode === 'DIRECTIVE') {
          return pick([
            { text: "The work is done. Now the building happens.", type: 'rest_directive' },
            { text: "You stressed the system. Now it adapts.", type: 'rest_directive' },
            { text: "Not a setback. A setup.", type: 'rest_directive' },
            { text: "This isn't stopping. This is building.", type: 'rest_directive' },
            { text: "The stimulus is in. The body is responding.", type: 'rest_directive' }
          ]);
        }
        if (mode === 'PROTECTIVE') {
          return pick([
            { text: "You feel fine. The trend says otherwise.", type: 'rest_protective' },
            { text: "The body doesn't send alerts. It just keeps sliding until it hands you the bill.", type: 'rest_protective' },
            { text: "The itch is loud. The signal says wait.", type: 'rest_protective' },
            { text: "Restlessness is a feeling, not a command.", type: 'rest_protective' }
          ]);
        }
        return { text: "Signal is unclear. Default to less.", type: 'rest_uncertain' };
      }

      // BUILD
      if (command === 'BUILD') {
        if (isAfterRest) {
          return pick([
            { text: "You rested. This is the return.", type: 'build_after_rest' },
            { text: "Yesterday's patience. Today's capacity.", type: 'build_after_rest' },
            { text: "This is what trust buys.", type: 'build_after_rest' }
          ]);
        }
        
        if (mode === 'DIRECTIVE') {
          return pick([
            { text: "Room to work. Not room to be reckless.", type: 'build_directive' },
            { text: "Middle of your range. Solid work is available.", type: 'build_directive' },
            { text: "Enough for quality. Not enough for ego.", type: 'build_directive' },
            { text: "Not your best. Not your worst. Just work.", type: 'build_directive' },
            { text: "Some days are for PRs. Today is for reps.", type: 'build_directive' },
            { text: "Not every day is a story. Some are just sentences.", type: 'build_directive' }
          ]);
        }
        if (mode === 'PROTECTIVE') {
          return pick([
            { text: "Still in range, but the direction matters.", type: 'build_protective' },
            { text: "The runway is getting shorter. Land smoothly.", type: 'build_protective' },
            { text: "Solid work available. Not a day to dig deep.", type: 'build_protective' }
          ]);
        }
        return { text: "Do what's programmed. Nothing extra.", type: 'build_uncertain' };
      }

      // PERFORM
      if (command === 'PERFORM') {
        if (isConsecutive) {
          return pick([
            { text: "Second straight day. Rare. Stay disciplined.", type: 'perform_consecutive' },
            { text: "Still green. But every PERFORM borrows from the future.", type: 'perform_consecutive' }
          ]);
        }
        
        if (canPersonalize && patterns.daysSincePerform >= 7) {
          return { text: `First green light in ${patterns.daysSincePerform} days. The drought is over.`, type: 'perform_rarity' };
        }
        
        if (mode === 'DIRECTIVE') {
          return pick([
            { text: "The tank is full. This is what you've been building toward.", type: 'perform_directive' },
            { text: "Green light. No caveats.", type: 'perform_directive' },
            { text: "Capacity is peaking. Use it. You can't save it.", type: 'perform_directive' }
          ]);
        }
        if (mode === 'PROTECTIVE') {
          return pick([
            { text: "Green light. But the road still has turns.", type: 'perform_protective' },
            { text: "Capacity is high. Doesn't mean infinite.", type: 'perform_protective' }
          ]);
        }
        return { text: "Green, but signal is noisy. Keep it controlled.", type: 'perform_uncertain' };
      }
      
      return { text: "Baseline forming.", type: 'learning' };
    };

    // ============================================
    // ACTION GENERATOR - The Prescription
    // ============================================
    const generateActions = (command, patterns, hrvHistory, complianceLog = [], daysOnApp = 0) => {
      if (!patterns || hrvHistory.length < 7) return null;
      
      const context = getContext(command, patterns, complianceLog, hrvHistory, daysOnApp);
      const { isTravel, isWarning, isAfterRest, isConsecutive } = context;

      // TRAVEL override
      if (isTravel) {
        return {
          primaryAction: "Walk in sunlight for 20-30 minutes. That's your only job today.",
          effortBoundary: "Walking pace only. Tourist pace.",
          recoveryLever: "Hydrate aggressively. Sleep when tired, even if it's the 'wrong' time.",
          guardrail: "Don't try to shake off jet lag with a workout. The bill comes in 48 hours."
        };
      }

      // REST
      if (command === 'REST') {
        if (isWarning) {
          return {
            primaryAction: "10-20 minute walk. 10 minutes stretching. That's the whole day.",
            effortBoundary: "Conversation pace. If you can't speak in full sentences, slow down. RPE 2.",
            recoveryLever: "In bed 30-60 minutes earlier than usual. This is the lever.",
            guardrail: "Restlessness is a feeling, not a command."
          };
        }
        return {
          primaryAction: "20-30 minutes easy movement. Walk, stretch, foam roll. Stop while it still feels easy.",
          effortBoundary: "Nose-breath only. If you need your mouth, slow down. RPE 2-3.",
          recoveryLever: "Water before coffee. Protein at every meal. Protect an 8-hour sleep window.",
          guardrail: "No 'just a quick one.' That's how rest days become debt."
        };
      }

      // BUILD
      if (command === 'BUILD') {
        if (isWarning) {
          return {
            primaryAction: "Same workout. Pull one lever back 20%: lighter load, fewer reps, or shorter time cap. Pick one.",
            effortBoundary: "RPE 6 ceiling. When form breaks, rack it.",
            recoveryLever: "In bed 30 minutes earlier than usual. Protein within 60 minutes.",
            guardrail: "A shortened session is a win. A crash is a week lost."
          };
        }
        if (isAfterRest) {
          return {
            primaryAction: "Full programmed work. Finish feeling like you could do a little more—but don't.",
            effortBoundary: "RPE 7. Leave 20% in the tank. That's fuel for the streak.",
            recoveryLever: "Don't undo yesterday's investment. Another good night tonight.",
            guardrail: "Feeling good doesn't mean 'go all out.' It means 'execute cleanly.'"
          };
        }
        return {
          primaryAction: "Programmed work only. Skip the finisher. Leave 10 minutes before you normally would.",
          effortBoundary: "RPE 7 cap. Finish feeling like you could do a little more. When form breaks, rack it.",
          recoveryLever: "Protein within 2 hours of training. Protect 7-8 hours sleep.",
          guardrail: "Don't turn a BUILD day into a PERFORM day. They have different purposes."
        };
      }

      // PERFORM
      if (command === 'PERFORM') {
        if (isConsecutive) {
          return {
            primaryAction: "Shorter session than yesterday. 75% duration, 85% intensity.",
            effortBoundary: "RPE 7-8 ceiling. Lower than yesterday. If warm-up feels off, convert to BUILD.",
            recoveryLever: "Tonight is critical. 8+ hours. Extra protein. This is probably the last green for a while.",
            guardrail: "Three consecutive PERFORMs almost never end well. Stop while you're ahead."
          };
        }
        if (isWarning) {
          return {
            primaryAction: "One hard effort in the first 15 minutes. Then coast. No encores.",
            effortBoundary: "RPE 8 once. Then immediately drop to 6.",
            recoveryLever: "Double down on recovery tonight. What you do in the next 12 hours matters more than what you did in the gym.",
            guardrail: "This pattern has cost days before. Keep today clean so tomorrow stays alive."
          };
        }
        return {
          primaryAction: "Your hard effort goes in the first 20 minutes. Heavy lift, benchmark, key interval—whatever it is, do it first. Then coast.",
          effortBoundary: "RPE 8-9 for one effort. Leave a rep in reserve. Then drop to 6-7. No second peaks.",
          recoveryLever: "Refuel within 60 minutes: protein + carbs. Protect an 8-hour sleep window. This is where gains lock in.",
          guardrail: "Don't turn a great day into a two-day hangover. One peak. Then done."
        };
      }

      return null;
    };

    // ============================================
    // IMPOSSIBLE INSIGHTS - The Story Arc
    // ============================================
    const getImpossibleInsight = (daysOnApp, patterns, complianceLog, hrvHistory) => {
      if (!patterns) return null;

      // Day 7: Weekend Split
      if (daysOnApp === 7 && patterns.weekendSplit) {
        return {
          label: 'YOUR FIRST WEEK',
          lines: [
            `Monday through Friday: ${patterns.weekendSplit.weekdayMean}.`,
            `Saturday and Sunday: ${patterns.weekendSplit.weekendMean}.`,
            '',
            'You are not the same person on weekends.',
            '',
            "You've never noticed this.",
            'How could you?',
            "You can't feel a weekly average.",
            '',
            "But it's been true your whole life.",
            'Now you know.'
          ]
        };
      }

      // Day 10+: Declining Trend Truth
      if (daysOnApp >= 10 && daysOnApp <= 12 && patterns.declineTrend) {
        const { values } = patterns.declineTrend;
        return {
          label: 'WHAT YOU CAN\'T FEEL',
          lines: [
            ...values.map((v, i) => `Day ${daysOnApp - values.length + i + 1}: ${v}`),
            '',
            'You felt fine on each of those days.',
            '',
            "The body doesn't argue.",
            "It doesn't complain.",
            'It just keeps score.',
            '',
            'And then one morning it hands you the bill.'
          ]
        };
      }

      // Day 14: Day-of-Week Pattern
      if (daysOnApp === 14 && (patterns.weakDay || patterns.strongDay)) {
        const lines = [];
        if (patterns.weakDay && patterns.strongDay) {
          lines.push(`Your lowest days: ${patterns.weakDay.day}s.`);
          lines.push(`Your highest days: ${patterns.strongDay.day}s.`);
        } else if (patterns.weakDay) {
          lines.push(`Your ${patterns.weakDay.day}s consistently drag.`);
        } else {
          lines.push(`Your ${patterns.strongDay.day}s consistently peak.`);
        }
        return {
          label: 'YOUR SECOND SECRET',
          lines: [
            ...lines,
            '',
            'This is not random.',
            'This is your weekly rhythm.',
            '',
            'It was there before I started watching.',
            "It's been there your whole life.",
            '',
            'You just never saw it.'
          ]
        };
      }

      // Day 21: First Crash Timing
      if (daysOnApp >= 21 && daysOnApp <= 25 && patterns.crashesAfterIgnoredRest?.length >= 1) {
        return {
          label: 'HOW CRASHES WORK',
          lines: [
            'The crash did not happen today.',
            'It happened three days ago.',
            '',
            'Today is when your body',
            'stopped hiding it from you.',
            '',
            'The cause is always days before the symptom.',
            '',
            "Now you've seen it once.",
            "You'll recognize the setup next time."
          ]
        };
      }

      // Day 30: The Mirror
      if (daysOnApp === 30) {
        const restIssued = complianceLog.filter(c => c.command === 'REST').length;
        const restFollowed = complianceLog.filter(c => c.command === 'REST' && c.followed === 'yes').length;
        const daysAbove = hrvHistory.filter(h => (h.value - patterns.baseline) / patterns.mad >= 0).length;
        const daysBelow = hrvHistory.length - daysAbove;
        
        return {
          label: 'ONE MONTH',
          lines: [
            `REST commands: ${restIssued}`,
            `Followed: ${restFollowed}`,
            '',
            `Days above baseline: ${daysAbove}`,
            `Days below baseline: ${daysBelow}`,
            '',
            patterns.crashesAfterIgnoredRest?.length > 0 
              ? 'The times REST was skipped all preceded your lowest stretches.'
              : '',
            patterns.recoveriesAfterRest?.length > 0
              ? 'The times REST was followed all preceded climbs.'
              : '',
            '',
            'The pattern is already clear.'
          ].filter(l => l !== '')
        };
      }

      // Day 45+: Pattern Vindication (same setup, different outcome)
      if (daysOnApp >= 45 && daysOnApp <= 50 && patterns.recoveriesAfterRest?.length >= 2 && patterns.crashesAfterIgnoredRest?.length >= 1) {
        const recovery = patterns.recoveriesAfterRest[patterns.recoveriesAfterRest.length - 1];
        const crash = patterns.crashesAfterIgnoredRest[0];
        return {
          label: 'SAME PATTERN. DIFFERENT ENDING.',
          lines: [
            `This looked like ${formatDateAnchor(crash.ignoredDate)}.`,
            'Same slope. Same setup.',
            '',
            'Last time, rest was skipped.',
            `${formatDateAnchor(crash.crashDate)}: crashed.`,
            '',
            'This time, rest happened.',
            `${formatDateAnchor(recovery.readyDate)}: climbing.`,
            '',
            'Same film. Different ending.',
            '',
            'The ending was always a choice.'
          ]
        };
      }

      // Day 60: Baseline Shift
      if (daysOnApp === 60 && patterns.baselineShift) {
        const { from, to, percent } = patterns.baselineShift;
        const direction = percent > 0 ? 'more' : 'less';
        return {
          label: 'TWO MONTHS',
          lines: [
            `Your baseline when you started: ${from}.`,
            `Your baseline now: ${to}.`,
            '',
            `That's ${Math.abs(percent)}% ${direction} capacity`,
            'than the person who walked in.',
            '',
            percent > 0 ? 'Not from training more.' : '',
            percent > 0 ? 'From resting better.' : '',
            '',
            'The capacity was never gone.',
            'It was buried under fatigue',
            "you didn't know you were carrying."
          ].filter(l => l !== '')
        };
      }

      // Day 90: The Switch
      if (daysOnApp === 90) {
        const restFollowed = complianceLog.filter(c => c.command === 'REST' && c.followed === 'yes').length;
        const restSkipped = complianceLog.filter(c => c.command === 'REST' && c.followed === 'no').length;
        const recoveries = patterns.recoveriesAfterRest?.length || 0;
        const crashes = patterns.crashesAfterIgnoredRest?.length || 0;
        
        const followedRate = restFollowed > 0 ? Math.round(recoveries / restFollowed * 100) : 0;
        const skippedRate = restSkipped > 0 ? Math.round(crashes / restSkipped * 100) : 0;
        
        return {
          label: 'NINETY DAYS',
          lines: [
            `When REST is followed: ${followedRate}% climb the next day.`,
            `When REST is skipped: ${skippedRate}% crash within 72 hours.`,
            '',
            "That's not a correlation.",
            "That's a switch.",
            '',
            'The body has been running this experiment',
            'your whole life.',
            '',
            'Rest → rise.',
            'Push through → fall.',
            '',
            'You just never had a translator',
            'to show you the results.',
            '',
            'Now you do.'
          ]
        };
      }

      // Day 180: Identity Shift
      if (daysOnApp === 180) {
        return {
          label: 'SIX MONTHS',
          lines: [
            'You have outlasted most people',
            'who start tracking recovery.',
            '',
            "Most quit because they couldn't rest",
            'when the number said rest.',
            '',
            'The story was too loud.',
            '"I feel fine."',
            '"Rest is weakness."',
            '',
            'You heard the same story.',
            'You just stopped letting it decide.',
            '',
            "That's the only difference."
          ]
        };
      }

      // Day 365: The Full Translation
      if (daysOnApp === 365) {
        const lines = [
          'Here is what I learned about you:',
          ''
        ];
        
        if (patterns.recoveriesAfterRest?.length > patterns.crashesAfterIgnoredRest?.length) {
          lines.push('When you rest, you rise.');
        }
        if (patterns.weakDay) lines.push(`Your ${patterns.weakDay.day}s need protecting.`);
        if (patterns.strongDay) lines.push(`Your ${patterns.strongDay.day}s are your peak.`);
        if (patterns.weekendSplit?.spread > 5) lines.push('Weekends restore you.');
        
        lines.push('');
        lines.push('None of this was hidden.');
        lines.push('It was all there, every day, for your entire life.');
        lines.push('');
        lines.push('You just needed someone to read it to you');
        lines.push('until you learned to read it yourself.');
        lines.push('');
        lines.push('You can read it now.');
        lines.push('');
        lines.push('The signal was never the treasure.');
        lines.push('The treasure was learning to hear it.');
        
        return { label: 'ONE YEAR', lines };
      }

      return null;
    };

    // ============================================
    // UI COMPONENTS
    // ============================================
    
    const CommandWord = ({ command, onClick, isRevealed }) => {
      const colors = { REST: '#FDA4AF', BUILD: '#C9A962', PERFORM: '#6EE7B7', LEARNING: '#A1A1AA' };
      return (
        <div className={`text-center cursor-pointer transition-all duration-500 ${isRevealed ? 'pt-8' : 'pt-24'}`} onClick={onClick}>
          <h1 className={`font-display animate-rise ${isRevealed ? 'text-4xl' : 'text-7xl'}`} style={{ color: colors[command], transition: 'font-size 500ms ease' }}>
            {command}
          </h1>
          {!isRevealed && <p className="text-sm mt-8 animate-fade delay-1000" style={{ color: 'var(--text-muted)', opacity: 0.4 }}>touch to understand</p>}
        </div>
      );
    };

    const Observation = ({ text }) => (
      <div className="text-center px-8 animate-rise">
        <p className="text-base leading-relaxed" style={{ color: 'var(--text-secondary)', lineHeight: 1.8 }}>{text}</p>
      </div>
    );

    const Prescription = ({ actions }) => {
      if (!actions) return null;
      return (
        <div className="px-8 space-y-5 animate-rise delay-200">
          <div className="divider" />
          <div className="space-y-4">
            {[actions.primaryAction, actions.effortBoundary, actions.recoveryLever].map((text, i) => (
              <div key={i} className="flex items-start gap-3">
                <span className="mt-2 block w-1.5 h-1.5 rounded-full flex-shrink-0" style={{ backgroundColor: 'var(--gold)' }} />
                <p className="text-sm leading-relaxed" style={{ color: i === 0 ? 'var(--text-secondary)' : 'var(--text-muted)' }}>{text}</p>
              </div>
            ))}
          </div>
          <div className="divider" />
          <div className="flex items-start gap-3 animate-rise delay-300">
            <span style={{ color: 'var(--rose)', fontSize: '14px' }}>⚠</span>
            <p className="text-sm leading-relaxed" style={{ color: 'var(--rose)', opacity: 0.8 }}>{actions.guardrail}</p>
          </div>
        </div>
      );
    };

    const InsightBlock = ({ insight }) => {
      if (!insight) return null;
      return (
        <div className="insight-block animate-rise delay-400 mt-8 mx-8">
          <div className="label">{insight.label}</div>
          <div className="content">
            {insight.lines.map((line, i) => <React.Fragment key={i}>{line || <br />}{line && i < insight.lines.length - 1 && <br />}</React.Fragment>)}
          </div>
        </div>
      );
    };

    const CompliancePrompt = ({ onSelect }) => (
      <div className="modal-overlay" />
      ,
      <div className="modal-content flex items-center justify-center p-10">
        <div className="text-center space-y-10 animate-rise max-w-sm w-full">
          <p className="font-display text-xl italic" style={{ color: 'var(--text-secondary)' }}>Yesterday was...</p>
          <div className="flex gap-4">
            <button onClick={() => onSelect('yes')} className="btn-primary flex-1">Rested</button>
            <button onClick={() => onSelect('no')} className="btn-primary flex-1">Trained</button>
          </div>
        </div>
      </div>
    );

    const HRVInput = ({ value, onChange, onSubmit, hrvSource }) => (
      <div className="space-y-6 animate-rise">
        <div className="text-center">
          <p className="text-sm mb-2" style={{ color: 'var(--text-muted)' }}>{hrvSource?.label || 'Your'} HRV this morning</p>
        </div>
        <input type="number" value={value} onChange={(e) => onChange(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && onSubmit()} placeholder="ms" className="input-minimal text-3xl font-display" autoFocus />
        <button onClick={onSubmit} disabled={!value} className="btn-primary" style={{ opacity: value ? 1 : 0.3, borderColor: value ? 'var(--gold)' : 'var(--text-faint)', color: value ? 'var(--gold)' : 'var(--text-muted)' }}>Log</button>
      </div>
    );

    // ============================================
    // ONBOARDING - Jobs/Ive Philosophy
    // ============================================
    const Onboarding = ({ onComplete }) => {
      const [selectedDevice, setSelectedDevice] = useState(null);
      const [customDevice, setCustomDevice] = useState('');
      
      const devices = [
        { id: 'whoop', label: 'WHOOP' },
        { id: 'apple', label: 'Apple Watch' },
        { id: 'garmin', label: 'Garmin' },
        { id: 'oura', label: 'Oura' },
        { id: 'fitbit', label: 'Fitbit' },
        { id: 'polar', label: 'Polar' },
        { id: 'samsung', label: 'Samsung' },
        { id: 'other', label: 'Other' }
      ];

      const handleComplete = () => {
        const source = selectedDevice === 'other' 
          ? { id: 'custom', label: customDevice || 'Custom' }
          : devices.find(d => d.id === selectedDevice);
        onComplete(source);
      };

      return (
        <div className="min-h-screen flex flex-col justify-center p-10" style={{ background: 'var(--bg-primary)' }}>
          <div className="max-w-sm mx-auto w-full">
            <div className="space-y-8 animate-rise">
              <div className="text-center space-y-3">
                <p className="font-display text-2xl leading-relaxed" style={{ color: 'var(--text-primary)' }}>
                  Your body is talking.
                </p>
                <p className="text-sm" style={{ color: 'var(--text-muted)' }}>Where do you track HRV?</p>
              </div>
              <div className="space-y-2">
                {devices.map(device => (
                  <button key={device.id} onClick={() => setSelectedDevice(device.id)}
                    className="w-full py-3 px-4 rounded-xl text-left text-sm transition-all"
                    style={{
                      background: selectedDevice === device.id ? 'var(--bg-elevated)' : 'transparent',
                      border: `1px solid ${selectedDevice === device.id ? 'var(--gold)' : 'var(--text-faint)'}`,
                      color: selectedDevice === device.id ? 'var(--gold)' : 'var(--text-secondary)'
                    }}>
                    {device.label}
                  </button>
                ))}
              </div>
              {selectedDevice === 'other' && (
                <input type="text" value={customDevice} onChange={(e) => setCustomDevice(e.target.value)} placeholder="Device name" className="input-minimal text-sm" />
              )}
              {selectedDevice && (
                <button onClick={handleComplete} className="btn-primary animate-fade" style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}>
                  Let's begin
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // INFO MODAL
    // ============================================
    const InfoModal = ({ onClose, hrvSource }) => {
      const deviceId = hrvSource?.id || 'custom';
      const deviceLabel = hrvSource?.label || 'Your Device';
      
      const instructions = {
        whoop: ['Open WHOOP app', 'Tap on Recovery tab', 'Find "HRV" under your recovery score', 'Use the number in milliseconds (ms)'],
        apple: ['Open Health app', 'Tap Browse → Heart → Heart Rate Variability', 'Find your most recent sleep HRV', 'Use the number in milliseconds (ms)'],
        garmin: ['Open Garmin Connect app', 'Go to Health Stats → HRV', 'Find your overnight average', 'Use the number in milliseconds (ms)'],
        oura: ['Open Oura app', 'Tap Readiness tab', 'Scroll to "HRV Balance"', 'Use the average HRV in milliseconds'],
        fitbit: ['Open Fitbit app', 'Tap Health Metrics tile', 'Find "Heart Rate Variability"', 'Use daily average in milliseconds'],
        polar: ['Open Polar Flow app', 'Go to Nightly Recharge', 'Find ANS Charge HRV', 'Use RMSSD value in milliseconds'],
        samsung: ['Open Samsung Health', 'Go to Stress measurement', 'Take a reading (includes HRV)', 'Use HRV value in milliseconds'],
      };
      
      const steps = instructions[deviceId] || [`Check ${deviceLabel} app`, 'Look for Heart Rate Variability', 'Find morning reading', 'Use number in milliseconds (ms)'];
      
      return (
        <>
          <div className="modal-overlay" onClick={onClose} />
          <div className="modal-content flex items-end sm:items-center justify-center">
            <div className="w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 space-y-5 animate-rise" style={{ background: 'var(--bg-elevated)' }}>
              <div className="flex justify-between items-start">
                <h2 style={{ color: 'var(--text-primary)' }}>How GENYSYS Works</h2>
                <button onClick={onClose} className="text-2xl" style={{ color: 'var(--text-muted)' }}>×</button>
              </div>
              
              <p className="text-sm leading-relaxed" style={{ color: 'var(--text-secondary)' }}>
                Your nervous system tells us how recovered you are. We read it. We tell you what to do.
              </p>
              
              <div className="space-y-2">
                <div className="flex items-start gap-3">
                  <span className="font-bold text-sm" style={{ color: 'var(--rose)' }}>REST</span>
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>Light movement only. System needs recovery.</span>
                </div>
                <div className="flex items-start gap-3">
                  <span className="font-bold text-sm" style={{ color: 'var(--gold)' }}>BUILD</span>
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>Standard training. Execute your program.</span>
                </div>
                <div className="flex items-start gap-3">
                  <span className="font-bold text-sm" style={{ color: 'var(--green)' }}>PERFORM</span>
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>System primed. Push hard. Chase PRs.</span>
                </div>
              </div>
              
              <div className="divider" />
              
              <div className="space-y-2">
                <h3 className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>What is HRV?</h3>
                <p className="text-xs leading-relaxed" style={{ color: 'var(--text-muted)' }}>
                  Heart Rate Variability — the time between heartbeats, in milliseconds (ms). Higher usually means more recovered. Most people range 20-100ms.
                </p>
              </div>
              
              <div className="divider" />
              
              <div className="space-y-2">
                <h3 className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>Where to find HRV ({deviceLabel})</h3>
                <ol className="text-xs leading-relaxed space-y-1 list-decimal list-inside" style={{ color: 'var(--text-muted)' }}>
                  {steps.map((step, i) => <li key={i}>{step}</li>)}
                </ol>
              </div>
              
              <div className="divider" />
              
              <div className="space-y-2">
                <h3 className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>No wearable?</h3>
                <p className="text-xs leading-relaxed" style={{ color: 'var(--text-muted)' }}>
                  Download Welltory (free). Take a 1-minute reading with your phone camera each morning.
                </p>
              </div>
              
              <button onClick={onClose} className="btn-primary">Done</button>
            </div>
          </div>
        </>
      );
    };

    // ============================================
    // HISTORY MODAL
    // ============================================
    const HistoryModal = ({ isOpen, onClose, hrvHistory, onAdd, onDelete }) => {
      const [newValue, setNewValue] = useState('');
      const [newDate, setNewDate] = useState(getYesterdayLocal());
      
      if (!isOpen) return null;
      
      const handleAdd = () => {
        if (newValue && newDate && !hrvHistory.find(h => h.date === newDate)) {
          onAdd(parseInt(newValue), newDate);
          setNewValue('');
          // Fix: Use T12:00:00 to avoid timezone issues
          const prevDay = new Date(newDate + 'T12:00:00');
          prevDay.setDate(prevDay.getDate() - 1);
          setNewDate(getLocalDateString(prevDay));
        }
      };
      
      return (
        <>
          <div className="modal-overlay" onClick={onClose} />
          <div className="modal-content flex items-end justify-center">
            <div className="w-full max-w-md rounded-t-3xl p-6 space-y-6 animate-rise" style={{ background: 'var(--bg-elevated)' }}>
              <div className="flex justify-between items-center">
                <h3 style={{ color: 'var(--text-primary)' }}>Add Past HRV</h3>
                <div className="flex items-center gap-4">
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>{hrvHistory.length} entries</span>
                  <button onClick={onClose} className="text-2xl" style={{ color: 'var(--text-muted)' }}>×</button>
                </div>
              </div>
              
              <div className="flex gap-2">
                <input type="number" value={newValue} onChange={(e) => setNewValue(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleAdd()} placeholder="HRV" className="input-minimal w-24 text-sm" autoFocus />
                <input type="date" value={newDate} onChange={(e) => setNewDate(e.target.value)} className="input-minimal flex-1 text-sm" style={{ textAlign: 'left', paddingLeft: '16px' }} />
                <button onClick={handleAdd} className="px-4 rounded-xl text-sm" style={{ background: 'var(--bg-card)', border: '1px solid var(--text-faint)', color: 'var(--text-secondary)' }}>Add</button>
              </div>
              
              {hrvHistory.length > 0 && (
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {[...hrvHistory].reverse().slice(0, 14).map((entry) => (
                    <div key={entry.date} className="flex justify-between items-center py-2 text-sm" style={{ borderBottom: '1px solid rgba(63,63,70,0.3)' }}>
                      <span style={{ color: 'var(--text-muted)' }}>{entry.date}</span>
                      <div className="flex items-center gap-3">
                        <span style={{ color: 'var(--text-secondary)' }}>{entry.value} ms</span>
                        <button onClick={() => onDelete(entry.date)} className="text-lg" style={{ color: 'var(--text-muted)' }}>×</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
              
              <button onClick={onClose} className="btn-primary">Done</button>
            </div>
          </div>
        </>
      );
    };

    // ============================================
    // FEEDBACK MODAL
    // ============================================
    const FeedbackModal = ({ round, daysOnApp, onSubmit, onDismiss }) => {
      const [step, setStep] = useState(1);
      const [response, setResponse] = useState(null);
      const [text, setText] = useState('');
      const [email, setEmail] = useState('');
      
      const handleSubmit = () => {
        onSubmit({ round, response, text, email });
      };

      if (round === 1) {
        return (
          <>
            <div className="modal-overlay" />
            <div className="modal-content flex items-center justify-center p-10">
              <div className="max-w-sm w-full space-y-8 animate-rise">
                {step === 1 && (
                  <div className="text-center space-y-6">
                    <p className="text-sm" style={{ color: 'var(--text-muted)' }}>Day {daysOnApp}</p>
                    <p className="text-lg" style={{ color: 'var(--text-primary)' }}>Quick question.</p>
                    <p className="text-sm leading-relaxed" style={{ color: 'var(--text-secondary)' }}>Has GENYSYS changed how you think about training?</p>
                    <div className="space-y-2">
                      <button onClick={() => { setResponse('yes'); setStep(2); }} className="btn-primary">Yes, noticeably</button>
                      <button onClick={() => { setResponse('maybe'); setStep(2); }} className="btn-primary">Too early to tell</button>
                      <button onClick={() => { setResponse('no'); setStep(2); }} className="btn-primary">Not really</button>
                    </div>
                    <button onClick={onDismiss} className="btn-ghost text-xs">ask me later</button>
                  </div>
                )}
                {step === 2 && (
                  <div className="text-center space-y-6">
                    <p className="text-lg" style={{ color: 'var(--text-primary)' }}>What's one thing that would make this more valuable?</p>
                    <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="The one thing..." className="input-minimal h-24 resize-none text-sm" style={{ textAlign: 'left' }} />
                    <button onClick={() => setStep(3)} className="btn-primary">Continue</button>
                    <button onClick={() => setStep(3)} className="btn-ghost text-xs">Skip</button>
                  </div>
                )}
                {step === 3 && (
                  <div className="text-center space-y-6">
                    <p className="text-lg" style={{ color: 'var(--text-primary)' }}>Want early access to what's next?</p>
                    <p className="text-sm" style={{ color: 'var(--text-muted)' }}>Auto-sync. Deeper patterns. Predictions before you feel them.</p>
                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" className="input-minimal text-sm" />
                    <button onClick={handleSubmit} className="btn-primary" style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}>I'm in</button>
                    <button onClick={handleSubmit} className="btn-ghost text-xs">Just keep going</button>
                  </div>
                )}
              </div>
            </div>
          </>
        );
      }

      // Round 2 (Day 35-45)
      return (
        <>
          <div className="modal-overlay" />
          <div className="modal-content flex items-center justify-center p-10">
            <div className="max-w-sm w-full space-y-8 animate-rise">
              {step === 1 && (
                <div className="text-center space-y-6">
                  <p className="text-sm" style={{ color: 'var(--text-muted)' }}>Day {daysOnApp}</p>
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>You're still here.</p>
                  <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>That puts you ahead of 95% of people who try to train smarter.</p>
                  <button onClick={() => setStep(2)} className="btn-ghost">Continue →</button>
                </div>
              )}
              {step === 2 && (
                <div className="text-center space-y-6">
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>What would make this twice as valuable?</p>
                  <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="The one thing..." className="input-minimal h-24 resize-none text-sm" style={{ textAlign: 'left' }} />
                  <button onClick={() => setStep(3)} className="btn-primary">Continue</button>
                </div>
              )}
              {step === 3 && (
                <div className="text-center space-y-6">
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>Anyone in your life who needs this?</p>
                  <p className="text-xs" style={{ color: 'var(--text-muted)' }}>A training partner. Someone who never rests. A friend who's always overtrained.</p>
                  <input type="text" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Their email or name" className="input-minimal text-sm" />
                  <button onClick={handleSubmit} className="btn-primary">Done</button>
                  <button onClick={handleSubmit} className="btn-ghost text-xs">Skip</button>
                </div>
              )}
            </div>
          </div>
        </>
      );
    };

    // ============================================
    // MAIN APPLICATION
    // ============================================
    const App = () => {
      const [hrvHistory, setHrvHistory] = useState([]);
      const [complianceLog, setComplianceLog] = useState([]);
      const [firstUseDate, setFirstUseDate] = useState(null);
      const [hrvSource, setHrvSource] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      
      const [todayHRV, setTodayHRV] = useState('');
      const [isRevealed, setIsRevealed] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [showCompliancePrompt, setShowCompliancePrompt] = useState(false);
      const [pendingCompliance, setPendingCompliance] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackRound, setFeedbackRound] = useState(1);
      const [feedbackState, setFeedbackState] = useState({ round1: false, round2: false });

      // TEST MODE STATE
      const [testMode, setTestMode] = useState(true);
      const [showTestPanel, setShowTestPanel] = useState(true);
      const [simulatedDay, setSimulatedDay] = useState(null);
      const [testCompliance, setTestCompliance] = useState(0.7);
      const [csvLoaded, setCsvLoaded] = useState(false);

      // CSV file input ref
      const fileInputRef = React.useRef(null);

      // Handle CSV upload
      const handleCSVUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const { entries, timezones } = parseWHOOPCSV(e.target.result);
          if (entries.length > 0) {
            // Generate compliance log based on test compliance rate
            const testLog = generateTestComplianceLog(entries, testCompliance);
            
            setHrvHistory(entries);
            setComplianceLog(testLog);
            setFirstUseDate(entries[0]?.date || getTodayLocal());
            setHrvSource({ type: 'custom', label: 'WHOOP (CSV)' });
            setCsvLoaded(true);
            setSimulatedDay(entries.length - 1);
            
            // Save
            saveData({
              hrvHistory: entries,
              complianceLog: testLog,
              firstUseDate: entries[0]?.date,
              hrvSource: { type: 'custom', label: 'WHOOP (CSV)' }
            });
            
            console.log(`[TEST] Loaded ${entries.length} entries, generated ${testLog.length} compliance records`);
          }
        };
        reader.readAsText(file);
      };

      // Jump to specific day
      const jumpToDay = (day) => {
        const maxDay = hrvHistory.length - 1;
        setSimulatedDay(Math.min(day, maxDay));
        setIsRevealed(false);
      };

      // Regenerate compliance with new rate
      const regenerateCompliance = () => {
        const newLog = generateTestComplianceLog(hrvHistory, testCompliance);
        setComplianceLog(newLog);
        saveData({ complianceLog: newLog });
      };

      // Load data
      useEffect(() => {
        try {
          const saved = localStorage.getItem('genysys_v2_data');
          if (saved) {
            const data = JSON.parse(saved);
            setHrvHistory(data.hrvHistory || []);
            setComplianceLog(data.complianceLog || []);
            setFirstUseDate(data.firstUseDate);
            setHrvSource(data.hrvSource);
            setFeedbackState(data.feedbackState || { round1: false, round2: false });
            if (data.hrvSource?.label) Analytics.setDevice(data.hrvSource.label);
          }
        } catch (e) { console.error(e); }
        setIsLoading(false);
      }, []);

      const saveData = useCallback((updates = {}) => {
        const data = { hrvHistory, complianceLog, firstUseDate, hrvSource, feedbackState, ...updates };
        localStorage.setItem('genysys_v2_data', JSON.stringify(data));
      }, [hrvHistory, complianceLog, firstUseDate, hrvSource, feedbackState]);

      // Compliance prompt check (only after REST days)
      useEffect(() => {
        if (!hrvHistory.length || !firstUseDate) return;
        
        const yesterday = getYesterdayLocal();
        const yesterdayEntry = hrvHistory.find(h => h.date === yesterday);
        const yesterdayCompliance = complianceLog.find(c => c.date === yesterday);
        
        if (yesterdayEntry && !yesterdayCompliance) {
          const patterns = analyzePatterns(hrvHistory, complianceLog, firstUseDate);
          if (patterns) {
            const yesterdayZ = (yesterdayEntry.value - patterns.baseline) / patterns.mad;
            const yesterdayCommand = getCommandKey(yesterdayZ);
            
            // ONLY prompt after REST days
            if (yesterdayCommand === 'REST') {
              setPendingCompliance({ date: yesterday, command: 'REST' });
              setShowCompliancePrompt(true);
            }
          }
        }
      }, [hrvHistory, complianceLog, firstUseDate]);

      // Feedback check
      useEffect(() => {
        const daysOnApp = firstUseDate ? Math.floor((new Date() - new Date(firstUseDate)) / (1000 * 60 * 60 * 24)) + 1 : 1;
        
        if (!feedbackState.round1 && daysOnApp >= 7 && daysOnApp <= 14) {
          setTimeout(() => { setFeedbackRound(1); setShowFeedback(true); }, 2000);
        } else if (!feedbackState.round2 && daysOnApp >= 35 && daysOnApp <= 45) {
          setTimeout(() => { setFeedbackRound(2); setShowFeedback(true); }, 2000);
        }
      }, [firstUseDate, feedbackState]);

      // Derived state
      // COMPUTED VALUES (with simulation support)
      const effectiveDay = simulatedDay !== null ? simulatedDay : hrvHistory.length - 1;
      const effectiveHistory = simulatedDay !== null ? hrvHistory.slice(0, simulatedDay + 1) : hrvHistory;
      const simulatedToday = effectiveHistory.length > 0 ? effectiveHistory[effectiveHistory.length - 1]?.date : getTodayLocal();
      
      const today = simulatedDay !== null ? simulatedToday : getTodayLocal();
      const todayEntry = effectiveHistory.find(h => h.date === today);
      const patterns = useMemo(() => analyzePatterns(effectiveHistory, complianceLog, firstUseDate), [effectiveHistory, complianceLog, firstUseDate]);
      const daysOnApp = simulatedDay !== null ? simulatedDay + 1 : (firstUseDate ? Math.floor((new Date() - new Date(firstUseDate)) / (1000 * 60 * 60 * 24)) + 1 : 1);

      const result = useMemo(() => {
        if (!todayEntry || !patterns) {
          return { commandKey: 'LEARNING', isPreview: true, daysUntilFull: Math.max(0, 7 - effectiveHistory.length) };
        }
        const zScore = (todayEntry.value - patterns.baseline) / patterns.mad;
        return { commandKey: getCommandKey(zScore), zScore, isPreview: effectiveHistory.length < 7 };
      }, [todayEntry, patterns, effectiveHistory.length]);

      const observation = useMemo(() => generateObservation(result?.commandKey, patterns, daysOnApp, effectiveHistory, complianceLog), [result?.commandKey, patterns, daysOnApp, effectiveHistory, complianceLog]);
      const actions = useMemo(() => generateActions(result?.commandKey, patterns, effectiveHistory, complianceLog, daysOnApp), [result?.commandKey, patterns, effectiveHistory, complianceLog, daysOnApp]);
      const insight = useMemo(() => getImpossibleInsight(daysOnApp, patterns, complianceLog, effectiveHistory), [daysOnApp, patterns, complianceLog, effectiveHistory]);

      // Handlers
      const handleOnboardingComplete = (source) => {
        const today = getTodayLocal();
        setHrvSource(source);
        setFirstUseDate(today);
        saveData({ hrvSource: source, firstUseDate: today });
        Analytics.setDevice(source.label);
        Analytics.track('onboarding_complete', { device: source.label });
      };

      const handleLogHRV = () => {
        const value = parseInt(todayHRV);
        if (isNaN(value) || value < 1 || value > 300) return;
        const newHistory = [...hrvHistory.filter(h => h.date !== today), { date: today, value }];
        setHrvHistory(newHistory);
        setTodayHRV('');
        saveData({ hrvHistory: newHistory });
        Analytics.track(hrvHistory.length === 0 ? 'first_hrv_logged' : 'hrv_logged', { hrv: value });
      };

      const handleComplianceSelect = (followed) => {
        if (!pendingCompliance) return;
        const newLog = [...complianceLog, { ...pendingCompliance, followed }];
        setComplianceLog(newLog);
        saveData({ complianceLog: newLog });
        setShowCompliancePrompt(false);
        setPendingCompliance(null);
        Analytics.track('compliance_recorded', { command: pendingCompliance.command, followed });
      };

      const handleAddHistory = (value, date) => {
        const newHistory = [...hrvHistory, { date, value }].sort((a, b) => new Date(a.date) - new Date(b.date));
        setHrvHistory(newHistory);
        saveData({ hrvHistory: newHistory });
        Analytics.track('hrv_backfilled', { date, value });
      };

      const handleDeleteHistory = (date) => {
        const newHistory = hrvHistory.filter(h => h.date !== date);
        setHrvHistory(newHistory);
        saveData({ hrvHistory: newHistory });
      };

      const handleFeedbackSubmit = (data) => {
        const newState = { ...feedbackState, [`round${data.round}`]: true };
        setFeedbackState(newState);
        saveData({ feedbackState: newState });
        setShowFeedback(false);
        Analytics.track(`feedback_round${data.round}_submitted`, data);
      };

      const handleFeedbackDismiss = () => {
        setShowFeedback(false);
        Analytics.track(`feedback_round${feedbackRound}_dismissed`);
      };

      const resetAll = () => {
        if (confirm('Reset all data? This cannot be undone.')) {
          localStorage.removeItem('genysys_v2_data');
          localStorage.removeItem('genysys_analytics');
          setSimulatedDay(null);
          setCsvLoaded(false);
          setHrvHistory([]);
          setComplianceLog([]);
          setFirstUseDate(null);
          setHrvSource(null);
          window.location.reload();
        }
      };

      if (isLoading) return <div className="min-h-screen flex items-center justify-center" style={{ background: 'var(--bg-primary)' }}><div className="animate-fade" style={{ color: 'var(--text-muted)' }}>...</div></div>;
      if (!hrvSource) return <Onboarding onComplete={handleOnboardingComplete} />;
      if (showCompliancePrompt) return <CompliancePrompt onSelect={handleComplianceSelect} />;

      return (
        <div className="min-h-screen" style={{ background: 'var(--bg-primary)' }}>
          <div className="max-w-md mx-auto px-10 py-8 min-h-screen flex flex-col">
            
            <header className="flex justify-between items-center mb-8">
              <button onClick={() => setShowInfo(true)} className="text-xs tracking-widest" style={{ color: 'var(--gold)', opacity: 0.6 }}>GENYSYS</button>
              <span className="text-xs" style={{ color: simulatedDay !== null ? 'var(--amber)' : 'var(--text-muted)' }}>
                {simulatedDay !== null ? `Day ${daysOnApp} • ${new Date(today + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}` : new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
              </span>
            </header>

            <main className="flex-1 flex flex-col">
              {!todayEntry && (
                <div className="flex-1 flex items-center justify-center">
                  <div className="w-full max-w-xs">
                    <HRVInput value={todayHRV} onChange={setTodayHRV} onSubmit={handleLogHRV} hrvSource={hrvSource} />
                  </div>
                </div>
              )}

              {todayEntry && (
                <div className="flex-1">
                  <CommandWord command={result?.commandKey || 'LEARNING'} onClick={() => setIsRevealed(true)} isRevealed={isRevealed} />

                  {isRevealed && (
                    <div className="mt-8 space-y-6">
                      {observation && <Observation text={observation.text} />}
                      <Prescription actions={actions} />
                      {insight && <InsightBlock insight={insight} />}
                      
                      {/* Day 1-2 Promise Content (disappears after enough data) */}
                      {!insight && effectiveHistory.length < 7 && daysOnApp <= 2 && (
                        <div className="insight-block animate-rise delay-400 mt-8 mx-8">
                          <div className="label">{daysOnApp === 1 ? 'THE PROMISE' : 'WHAT YOU\'LL LEARN'}</div>
                          <div className="content">
                            {daysOnApp === 1 ? (
                              <>
                                Give me a week — I'll find your baseline.<br /><br />
                                Give me a month — I'll recognize your rhythms.<br /><br />
                                Give me a year — I'll see what even you can't:<br />
                                <em>what pushes you forward… and what sets you back.</em>
                              </>
                            ) : (
                              <>
                                Before you opened this,<br />
                                you already had a story about how you feel.<br /><br />
                                Tired. Energized. Ready. Wrecked.<br /><br />
                                The body doesn't run on stories.<br />
                                It runs on the night you just had.<br /><br />
                                For your whole life, you've been guessing.<br />
                                The body has been keeping score.
                              </>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {result?.isPreview && (
                        <div className="text-center mt-8 animate-rise delay-500">
                          <p className="text-xs" style={{ color: 'var(--text-muted)' }}>
                            {result.daysUntilFull > 0 ? `${result.daysUntilFull} day${result.daysUntilFull > 1 ? 's' : ''} until personalized guidance unlocks.` : 'Baseline forming.'}
                          </p>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </main>

            <footer className="pt-8 pb-4 flex justify-between text-xs" style={{ color: 'var(--text-muted)' }}>
              <button onClick={() => setShowHistory(true)} className="hover:opacity-70">+ Add history</button>
              <button onClick={resetAll} className="hover:opacity-70">Reset</button>
            </footer>
          </div>

          <HistoryModal isOpen={showHistory} onClose={() => setShowHistory(false)} hrvHistory={hrvHistory} onAdd={handleAddHistory} onDelete={handleDeleteHistory} />
          {showInfo && <InfoModal onClose={() => setShowInfo(false)} hrvSource={hrvSource} />}
          {showFeedback && <FeedbackModal round={feedbackRound} daysOnApp={daysOnApp} onSubmit={handleFeedbackSubmit} onDismiss={handleFeedbackDismiss} />}

          {/* TEST MODE UI */}
          <div className="test-badge">TEST MODE</div>
          <input type="file" ref={fileInputRef} accept=".csv" onChange={handleCSVUpload} />
          
          {showTestPanel && (
            <div className="test-panel">
              <div className="test-panel-header">
                <span style={{ color: 'var(--amber)', fontSize: '11px', fontWeight: '600', letterSpacing: '0.1em' }}>TEST CONTROLS</span>
                <button onClick={() => setShowTestPanel(false)} style={{ color: 'var(--amber)', fontSize: '16px', background: 'none', border: 'none', cursor: 'pointer' }}>×</button>
              </div>
              <div className="test-panel-content">
                
                {/* Data Loading */}
                <div className="test-section">
                  <div className="test-section-title">Load Data</div>
                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    <button className="btn-test" onClick={() => fileInputRef.current?.click()}>
                      📁 Upload CSV
                    </button>
                    {csvLoaded && <span style={{ color: 'var(--green)', fontSize: '11px', alignSelf: 'center' }}>✓ {hrvHistory.length} entries loaded</span>}
                  </div>
                </div>

                {/* Day Simulation */}
                {hrvHistory.length > 0 && (
                  <div className="test-section">
                    <div className="test-section-title">Simulate Day</div>
                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '12px' }}>
                      <input 
                        type="range" 
                        min="0" 
                        max={hrvHistory.length - 1} 
                        value={effectiveDay}
                        onChange={(e) => jumpToDay(parseInt(e.target.value))}
                        style={{ flex: 1, accentColor: 'var(--amber)' }}
                      />
                      <span style={{ color: 'var(--text-primary)', fontSize: '14px', minWidth: '60px' }}>Day {daysOnApp}</span>
                    </div>
                    <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                      {MILESTONES.filter(m => m <= hrvHistory.length).map(m => (
                        <button 
                          key={m} 
                          className={`btn-test ${daysOnApp === m ? 'active' : ''}`}
                          onClick={() => jumpToDay(m - 1)}
                        >
                          Day {m}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Compliance Rate */}
                {hrvHistory.length > 0 && (
                  <div className="test-section">
                    <div className="test-section-title">Test Compliance Rate</div>
                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                      <input 
                        type="range" 
                        min="0" 
                        max="100" 
                        value={testCompliance * 100}
                        onChange={(e) => setTestCompliance(parseInt(e.target.value) / 100)}
                        style={{ flex: 1, accentColor: 'var(--amber)' }}
                      />
                      <span style={{ color: 'var(--text-primary)', fontSize: '14px', minWidth: '40px' }}>{Math.round(testCompliance * 100)}%</span>
                      <button className="btn-test" onClick={regenerateCompliance}>Regenerate</button>
                    </div>
                  </div>
                )}

                {/* Current State Debug */}
                {patterns && (
                  <div className="test-section">
                    <div className="test-section-title">Current State</div>
                    <div className="test-grid">
                      <div className="test-stat">
                        <div className="test-stat-label">Command</div>
                        <div className="test-stat-value" style={{ color: result?.commandKey === 'REST' ? 'var(--rose)' : result?.commandKey === 'PERFORM' ? 'var(--green)' : 'var(--text-primary)' }}>{result?.commandKey}</div>
                      </div>
                      <div className="test-stat">
                        <div className="test-stat-label">Z-Score</div>
                        <div className="test-stat-value">{result?.zScore?.toFixed(2) || 'N/A'}</div>
                      </div>
                      <div className="test-stat">
                        <div className="test-stat-label">Baseline</div>
                        <div className="test-stat-value">{Math.round(patterns.baseline)}</div>
                      </div>
                      <div className="test-stat">
                        <div className="test-stat-label">Today HRV</div>
                        <div className="test-stat-value">{todayEntry?.value || 'N/A'}</div>
                      </div>
                      <div className="test-stat">
                        <div className="test-stat-label">Trend</div>
                        <div className="test-stat-value">{patterns.trend || 'stable'}</div>
                      </div>
                      <div className="test-stat">
                        <div className="test-stat-label">REST Crashes</div>
                        <div className="test-stat-value">{patterns.crashesAfterIgnoredRest?.length || 0}</div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Milestone Tracker */}
                {hrvHistory.length > 0 && (
                  <div className="test-section">
                    <div className="test-section-title">Story Arc Milestones</div>
                    {MILESTONES.map(m => {
                      const status = daysOnApp === m ? 'current' : daysOnApp > m ? 'reached' : 'future';
                      const insightAvailable = m <= hrvHistory.length;
                      return (
                        <div key={m} className={`milestone-item ${status}`}>
                          <span>Day {m}: {m === 7 ? 'Weekend Split' : m === 14 ? 'Day Pattern' : m === 21 ? 'Crash Timing' : m === 30 ? 'The Mirror' : m === 45 ? 'Vindication' : m === 60 ? 'Capacity Truth' : m === 90 ? 'The Switch' : m === 180 ? 'Still Here' : 'Full Translation'}</span>
                          <span>{status === 'current' ? '● NOW' : status === 'reached' ? '✓' : insightAvailable ? '○' : '—'}</span>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Observation Type */}
                {observation && (
                  <div className="test-section">
                    <div className="test-section-title">Current Observation</div>
                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)', background: 'rgba(0,0,0,0.3)', padding: '10px', borderRadius: '6px' }}>
                      <div style={{ color: 'var(--amber)', fontSize: '10px', marginBottom: '4px' }}>{observation.type?.toUpperCase()}</div>
                      <div>"{observation.text}"</div>
                    </div>
                  </div>
                )}

                {/* Insight Preview */}
                {insight && (
                  <div className="test-section">
                    <div className="test-section-title">Current Insight</div>
                    <div style={{ fontSize: '12px', color: 'var(--gold)', background: 'rgba(0,0,0,0.3)', padding: '10px', borderRadius: '6px' }}>
                      <div style={{ marginBottom: '4px', fontWeight: '600' }}>{insight.label}</div>
                      <div style={{ color: 'var(--text-muted)', fontSize: '11px' }}>{insight.lines?.slice(0, 3).join(' ')}{insight.lines?.length > 3 ? '...' : ''}</div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {!showTestPanel && (
            <button 
              onClick={() => setShowTestPanel(true)} 
              style={{ position: 'fixed', bottom: '16px', right: '16px', background: 'var(--amber)', color: '#000', border: 'none', borderRadius: '8px', padding: '8px 16px', fontSize: '11px', fontWeight: '600', cursor: 'pointer', zIndex: 100 }}
            >
              Show Test Panel
            </button>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
