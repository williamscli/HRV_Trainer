<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a2f1a">
  <title>GENYSYS — TEST MODE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js" crossorigin="anonymous"></script>
  <style>
    body { 
      background: linear-gradient(180deg, #2d3b2d 0%, #3d4f3d 20%, #4a5d4a 40%, #5a6b5a 60%, #6b7b6b 80%, #8a9a8a 100%);
      background-attachment: fixed;
      min-height: 100vh;
    }
    .glass { background: rgba(40, 50, 40, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .glass-light { background: rgba(60, 75, 60, 0.5); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.06); }
    .glass-dark { background: rgba(20, 30, 20, 0.7); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.05); }
    .mist-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, rgba(180,190,180,0.1) 0%, rgba(180,190,180,0) 30%, rgba(180,190,180,0) 70%, rgba(180,190,180,0.05) 100%); pointer-events: none; z-index: 1; }
    .content-layer { position: relative; z-index: 2; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    .fade-in-delay-1 { animation: fadeIn 0.6s ease-out 0.2s forwards; opacity: 0; }
    .fade-in-delay-2 { animation: fadeIn 0.6s ease-out 0.4s forwards; opacity: 0; }
    .fade-in-delay-3 { animation: fadeIn 0.6s ease-out 0.6s forwards; opacity: 0; }
    .pulse-slow { animation: pulse 3s ease-in-out infinite; }
    .float { animation: float 4s ease-in-out infinite; }
    * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ============================================
    // ANALYTICS CONFIGURATION
    // ============================================
    const ANALYTICS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxp_XAHJDYn8gRpbqaHrDjC1u1Dgyy3-i_JU6WS9R62XiFm26tJdhZP1EOi3ID8mgtg/exec';
    
    const ALLOWED_EVENTS = [
      'session_start', 'onboarding_complete', 'first_hrv_logged', 'hrv_logged',
      'hrv_backfilled', 'command_generated', 'compliance_recorded',
      'day_3_active', 'day_7_active', 'day_14_active', 'day_30_active', 'day_60_active', 'day_90_active',
      'milestone_reached', 'observation_shown',
      'feedback_round1_submitted', 'feedback_round1_dismissed', 
      'feedback_round2_submitted', 'feedback_round2_dismissed',
      'data_exported', 'data_reset', 'legacy_user_migrated'
    ];

    const generateUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };

    const getTimezone = () => {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (e) {
        return 'Unknown';
      }
    };

    const Analytics = {
      userId: null,
      timezone: null,
      device: null,
      firstUseDate: null,

      init() {
        let stored = localStorage.getItem('genysys_analytics');
        if (stored) {
          const data = JSON.parse(stored);
          this.userId = data.userId;
          this.timezone = data.timezone || getTimezone();
          this.firstUseDate = data.firstUseDate;
        } else {
          this.userId = generateUUID();
          this.timezone = getTimezone();
          const appData = localStorage.getItem('genysys_v2_test_data');
          if (appData) {
            try {
              const parsed = JSON.parse(appData);
              this.firstUseDate = parsed.firstUseDate || this.getTodayLocal();
            } catch (e) {
              this.firstUseDate = this.getTodayLocal();
            }
          } else {
            this.firstUseDate = this.getTodayLocal();
          }
          this.save();
        }
      },

      getTodayLocal() {
        const date = new Date();
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      },

      save() {
        localStorage.setItem('genysys_analytics', JSON.stringify({
          userId: this.userId,
          timezone: this.timezone,
          firstUseDate: this.firstUseDate
        }));
      },

      setDevice(device) { this.device = device; },

      getDaysActive() {
        if (!this.firstUseDate) return 0;
        return Math.floor((new Date() - new Date(this.firstUseDate)) / (1000 * 60 * 60 * 24));
      },

      track(eventName, properties = {}) {
        if (!ALLOWED_EVENTS.includes(eventName)) {
          console.warn('[Analytics] Unknown event:', eventName);
          return;
        }
        if (!this.userId) return;
        
        const payload = {
          timestamp: new Date().toISOString(),
          userId: this.userId,
          event: eventName,
          device: this.device || properties.device || 'unknown',
          daysActive: this.getDaysActive(),
          region: this.timezone,
          ...properties
        };

        console.log('[Analytics]', eventName, payload);

        if (ANALYTICS_ENDPOINT && ANALYTICS_ENDPOINT !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
          fetch(ANALYTICS_ENDPOINT, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).catch(err => console.log('Analytics error:', err));
        }
      }
    };

    Analytics.init();

    // ============================================
    // UTILITIES
    // ============================================
    const getLocalDateString = (date = new Date()) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const getTodayLocal = () => getLocalDateString();
    
    const getYesterdayLocal = () => {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return getLocalDateString(yesterday);
    };

    const getDayName = (dateStr) => {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      return days[new Date(dateStr).getDay()];
    };

    const getRelativeDay = (dateStr) => {
      const today = new Date(getTodayLocal());
      const target = new Date(dateStr);
      const diffDays = Math.floor((today - target) / (1000 * 60 * 60 * 24));
      if (diffDays === 0) return 'today';
      if (diffDays === 1) return 'yesterday';
      if (diffDays < 7) return getDayName(dateStr);
      if (diffDays < 14) return 'last ' + getDayName(dateStr);
      return `${diffDays} days ago`;
    };

    // ============================================
    // ALGORITHM (unchanged from validated version)
    // ============================================
    const THRESHOLDS = { REST: -1.0, PERFORM: 0.5, MIN_DAYS: 7, MIN_PREVIEW_DAYS: 3, MAD_FLOOR: 3.0 };

    const calculateMedian = (arr) => {
      const sorted = [...arr].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    };

    const calculateMAD = (arr, median) => {
      const deviations = arr.map(v => Math.abs(v - median)).sort((a, b) => a - b);
      return Math.max(calculateMedian(deviations) * 1.4826, THRESHOLDS.MAD_FLOOR);
    };

    const getCommandKey = (zScore) => {
      if (zScore === null) return 'LEARNING';
      if (zScore < THRESHOLDS.REST) return 'REST';
      if (zScore >= THRESHOLDS.PERFORM) return 'PERFORM';
      return 'BUILD';
    };

    // ============================================
    // PATTERN ENGINE
    // ============================================
    const analyzePatterns = (hrvHistory, complianceLog, firstUseDate) => {
      if (hrvHistory.length < 3) return null;

      const values = hrvHistory.map(h => h.value);
      const median = calculateMedian(values);
      const mad = calculateMAD(values, median);

      // Calculate z-scores for all entries
      const withZScores = hrvHistory.map(h => ({
        ...h,
        zScore: (h.value - median) / mad,
        command: getCommandKey((h.value - median) / mad)
      })).sort((a, b) => new Date(a.date) - new Date(b.date));

      // Find patterns
      const patterns = {
        baseline: median,
        mad,
        totalDays: hrvHistory.length,
        
        // Command distribution
        restDays: withZScores.filter(h => h.command === 'REST').length,
        buildDays: withZScores.filter(h => h.command === 'BUILD').length,
        performDays: withZScores.filter(h => h.command === 'PERFORM').length,
        
        // Crash analysis
        crashes: [],
        crashesAfterIgnoredRest: [],
        recoveriesAfterRest: [],
        
        // Trend
        trend: null,
        consecutiveBelowBaseline: 0,
        consecutiveAboveBaseline: 0,
        
        // Historical comparisons
        nearestMatch: null,
        lastPerformDate: null,
        daysSincePerform: null,
        
        // Volatility
        isVolatile: false,
        isStable: false,
      };

      // Analyze trend (last 3-5 days)
      const recent = withZScores.slice(-5);
      if (recent.length >= 3) {
        let rising = 0, falling = 0;
        for (let i = 1; i < recent.length; i++) {
          if (recent[i].zScore > recent[i-1].zScore) rising++;
          else if (recent[i].zScore < recent[i-1].zScore) falling++;
        }
        if (rising >= 3) patterns.trend = 'rising';
        else if (falling >= 3) patterns.trend = 'falling';
        else patterns.trend = 'stable';
      }

      // Count consecutive days below/above baseline
      const reversed = [...withZScores].reverse();
      for (const h of reversed) {
        if (h.zScore < 0) patterns.consecutiveBelowBaseline++;
        else break;
      }
      for (const h of reversed) {
        if (h.zScore > 0) patterns.consecutiveAboveBaseline++;
        else break;
      }

      // Find last PERFORM day
      const performDays = withZScores.filter(h => h.command === 'PERFORM');
      if (performDays.length > 0) {
        const lastPerform = performDays[performDays.length - 1];
        patterns.lastPerformDate = lastPerform.date;
        patterns.daysSincePerform = Math.floor(
          (new Date(getTodayLocal()) - new Date(lastPerform.date)) / (1000 * 60 * 60 * 24)
        );
      }

      // Analyze compliance outcomes
      if (complianceLog && complianceLog.length > 0) {
        complianceLog.forEach(log => {
          if (!log.command || !log.followed) return;
          
          const nextDate = new Date(log.date);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = getLocalDateString(nextDate);
          const nextDay = withZScores.find(h => h.date === nextDateStr);
          
          if (!nextDay) return;
          
          // REST ignored → crashed?
          if (log.command === 'REST' && log.followed === 'no') {
            if (nextDay.zScore < THRESHOLDS.REST) {
              patterns.crashesAfterIgnoredRest.push({
                ignoredDate: log.date,
                crashDate: nextDateStr,
                daysLost: 1
              });
            }
          }
          
          // REST followed → recovered?
          if (log.command === 'REST' && log.followed === 'yes') {
            if (nextDay.zScore >= THRESHOLDS.REST) {
              patterns.recoveriesAfterRest.push({
                restDate: log.date,
                readyDate: nextDateStr
              });
            }
          }
        });
      }

      // Calculate volatility
      const zScoreStd = Math.sqrt(
        withZScores.reduce((sum, h) => sum + Math.pow(h.zScore, 2), 0) / withZScores.length
      );
      patterns.isVolatile = zScoreStd > 1.5;
      patterns.isStable = zScoreStd < 0.8;

      // Find nearest historical match to today
      const today = hrvHistory.find(h => h.date === getTodayLocal());
      if (today) {
        const todayZ = (today.value - median) / mad;
        let nearest = null;
        let nearestDiff = Infinity;
        
        withZScores.forEach(h => {
          if (h.date === getTodayLocal()) return;
          const diff = Math.abs(h.zScore - todayZ);
          if (diff < nearestDiff && diff < 0.5) {
            nearestDiff = diff;
            nearest = h;
          }
        });
        
        if (nearest) {
          const nextDate = new Date(nearest.date);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = getLocalDateString(nextDate);
          const compliance = complianceLog?.find(c => c.date === nearest.date);
          const nextDay = withZScores.find(h => h.date === nextDateStr);
          
          patterns.nearestMatch = {
            date: nearest.date,
            zScore: nearest.zScore,
            command: nearest.command,
            pushed: compliance?.followed === 'no',
            rested: compliance?.followed === 'yes',
            nextDayCrashed: nextDay ? nextDay.zScore < THRESHOLDS.REST : null,
            nextDayRecovered: nextDay ? nextDay.zScore >= 0 : null
          };
        }
      }

      return patterns;
    };

    // ============================================
    // THE VOICE - Observation Generator
    // ============================================
    const generateObservation = (command, patterns, daysOnApp, lastObservationType, hrvHistory) => {
      if (!patterns) {
        if (daysOnApp < 1) {
          return { text: "I don't know you yet. Today I'm guessing.", type: 'learning' };
        }
        return { text: "I'm still learning your patterns.", type: 'learning' };
      }

      const observations = [];
      
      // === MILESTONE OBSERVATIONS (highest priority) ===
      if (daysOnApp === 7 && lastObservationType !== 'milestone_baseline') {
        return {
          text: "I've found your baseline. You're not average. Now I can see when you're above yourself—and when you're below.",
          type: 'milestone_baseline'
        };
      }
      
      if (daysOnApp === 30 && lastObservationType !== 'milestone_30') {
        const insight = patterns.isVolatile 
          ? "Your body runs hot and cold. Big swings. I've adjusted for your rhythm."
          : patterns.crashesAfterIgnoredRest.length >= 2
            ? "You push hardest when you're most fragile. I've seen it happen."
            : patterns.performDays > patterns.restDays
              ? "You recover faster than most. Your peaks come often."
              : "You need more recovery than average. That's not weakness—it's information.";
        return { text: `I've learned something about you. ${insight}`, type: 'milestone_30' };
      }
      
      if (daysOnApp === 60 && lastObservationType !== 'milestone_60') {
        return {
          text: `I know your rhythm now. ${patterns.performDays} peak days in ${patterns.totalDays}. I know when they're coming before you feel it.`,
          type: 'milestone_60'
        };
      }
      
      if (daysOnApp === 90 && lastObservationType !== 'milestone_90') {
        return {
          text: "I know you better than most coaches ever could. They see you a few hours a week. I've watched every single day.",
          type: 'milestone_90'
        };
      }

      // === DANGER OBSERVATIONS (REST days) ===
      if (command === 'REST') {
        if (patterns.crashesAfterIgnoredRest.length > 0 && lastObservationType !== 'ignored_crash') {
          const crash = patterns.crashesAfterIgnoredRest[patterns.crashesAfterIgnoredRest.length - 1];
          observations.push({
            text: `You've seen this before. ${getRelativeDay(crash.ignoredDate)}, you pushed through. You paid for it.`,
            type: 'ignored_crash',
            priority: 10
          });
        }
        
        if (patterns.nearestMatch && patterns.nearestMatch.pushed && patterns.nearestMatch.nextDayCrashed && lastObservationType !== 'historical_match') {
          observations.push({
            text: `The last time your body looked like this was ${getRelativeDay(patterns.nearestMatch.date)}. You pushed. You crashed.`,
            type: 'historical_match',
            priority: 9
          });
        }
        
        if (patterns.consecutiveBelowBaseline >= 2 && lastObservationType !== 'consecutive_low') {
          observations.push({
            text: `You've been below yourself for ${patterns.consecutiveBelowBaseline} days. Your body is asking for something.`,
            type: 'consecutive_low',
            priority: 8
          });
        }

        if (patterns.trend === 'falling' && lastObservationType !== 'falling_trend') {
          observations.push({
            text: "You're falling. I've been watching. Today is not the day to fight gravity.",
            type: 'falling_trend',
            priority: 7
          });
        }

        const restMessages = [
          { text: "Your body is building something. Don't interrupt it.", type: 'rest_building' },
          { text: "I know you feel fine. You felt fine last time too.", type: 'rest_feel_fine' },
          { text: "The strongest version of you is counting on what you do right now.", type: 'rest_future' },
        ];
        const unusedRest = restMessages.filter(m => m.type !== lastObservationType);
        if (unusedRest.length > 0) {
          observations.push({ ...unusedRest[Math.floor(Math.random() * unusedRest.length)], priority: 3 });
        }
      }

      // === PERFORM OBSERVATIONS ===
      if (command === 'PERFORM') {
        if (patterns.daysSincePerform && patterns.daysSincePerform >= 7 && lastObservationType !== 'perform_rare') {
          observations.push({
            text: `This is your first peak day in ${patterns.daysSincePerform} days. It's rare. Use it.`,
            type: 'perform_rare',
            priority: 10
          });
        }

        if (patterns.trend === 'rising' && patterns.consecutiveAboveBaseline >= 2 && lastObservationType !== 'rising_peak') {
          observations.push({
            text: `You've been rising for ${patterns.consecutiveAboveBaseline} days. Today it peaks.`,
            type: 'rising_peak',
            priority: 9
          });
        }

        if (patterns.recoveriesAfterRest.length > 0 && lastObservationType !== 'earned_peak') {
          observations.push({
            text: "You protected your rest. Now you reap what you guarded.",
            type: 'earned_peak',
            priority: 8
          });
        }

        const performMessages = [
          { text: "This is what you've been building toward.", type: 'perform_building' },
          { text: "Your body is saying yes. It doesn't say yes often.", type: 'perform_yes' },
          { text: "Windows close. This one's open.", type: 'perform_window' },
        ];
        const unusedPerform = performMessages.filter(m => m.type !== lastObservationType);
        if (unusedPerform.length > 0) {
          observations.push({ ...unusedPerform[Math.floor(Math.random() * unusedPerform.length)], priority: 3 });
        }
      }

      // === BUILD OBSERVATIONS ===
      if (command === 'BUILD') {
        if (patterns.trend === 'rising' && lastObservationType !== 'build_rising') {
          observations.push({
            text: "You're rising. Not there yet. Keep building.",
            type: 'build_rising',
            priority: 6
          });
        }

        if (patterns.trend === 'stable' && lastObservationType !== 'build_stable') {
          observations.push({
            text: "Nothing special about today. That's not an insult. Most of life is this.",
            type: 'build_stable',
            priority: 5
          });
        }

        const buildMessages = [
          { text: "The ones who show up on days like this are the ones who win.", type: 'build_show_up' },
          { text: "Not your peak. Not your valley. The kind of day that makes peaks possible.", type: 'build_foundation' },
          { text: "You're laying the foundation for something you can't see yet.", type: 'build_invisible' },
        ];
        const unusedBuild = buildMessages.filter(m => m.type !== lastObservationType);
        if (unusedBuild.length > 0) {
          observations.push({ ...unusedBuild[Math.floor(Math.random() * unusedBuild.length)], priority: 3 });
        }
      }

      // === LEARNING STATE ===
      if (command === 'LEARNING' || observations.length === 0) {
        const learningDay = hrvHistory.length;
        if (learningDay <= 2) {
          return { text: `Day ${learningDay}. I'm still guessing. Give me a few more days.`, type: 'learning_early' };
        }
        return { text: "I'm learning your patterns. Check back tomorrow.", type: 'learning' };
      }

      observations.sort((a, b) => b.priority - a.priority);
      return observations[0];
    };

    // ============================================
    // THE PROMISE
    // ============================================
    const generatePromise = (command, patterns) => {
      if (command === 'REST') {
        if (patterns?.trend === 'falling') {
          return "Protect today. Let the floor find you.";
        }
        if (patterns?.consecutiveBelowBaseline >= 3) {
          return "This is how you climb back.";
        }
        const restPromises = [
          "Tomorrow you'll have more.",
          "Trust what I've seen.",
          "Protect today. Rise tomorrow.",
          "Guard this. It's building something.",
        ];
        return restPromises[Math.floor(Math.random() * restPromises.length)];
      }
      
      if (command === 'PERFORM') {
        if (patterns?.daysSincePerform >= 14) {
          return "You've waited for this. Don't waste it.";
        }
        const performPromises = [
          "Everything you've protected is ready to be spent.",
          "You earned this.",
          "This is your day.",
          "Leave nothing unused.",
        ];
        return performPromises[Math.floor(Math.random() * performPromises.length)];
      }
      
      if (command === 'BUILD') {
        const buildPromises = [
          "Show up. That's enough.",
          "Progress isn't always visible.",
          "The work is the answer.",
          "Keep building.",
        ];
        return buildPromises[Math.floor(Math.random() * buildPromises.length)];
      }
      
      return "Tomorrow I'll know more.";
    };

    // ============================================
    // COLORS - Earthy, organic palette
    // ============================================
    const COMMAND_STYLES = {
      REST: { color: '#e8b89d', bg: 'rgba(232, 184, 157, 0.12)', border: 'rgba(232, 184, 157, 0.2)', glow: 'rgba(232, 184, 157, 0.1)' },
      BUILD: { color: '#c9b896', bg: 'rgba(201, 184, 150, 0.12)', border: 'rgba(201, 184, 150, 0.2)', glow: 'rgba(201, 184, 150, 0.1)' },
      PERFORM: { color: '#9dc4a8', bg: 'rgba(157, 196, 168, 0.12)', border: 'rgba(157, 196, 168, 0.2)', glow: 'rgba(157, 196, 168, 0.1)' },
      LEARNING: { color: '#a8b5a8', bg: 'rgba(168, 181, 168, 0.12)', border: 'rgba(168, 181, 168, 0.2)', glow: 'rgba(168, 181, 168, 0.1)' },
    };

    // Tagline Component
    const Tagline = () => (
      <div className="fixed bottom-6 left-0 right-0 text-center fade-in-delay-3" style={{ zIndex: 10 }}>
        <p className="text-white/40 text-sm tracking-wide mb-2">Your body is talking.</p>
        <svg className="mx-auto float" width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 22C12 22 12 16 12 14C12 12 10 10 8 10C6 10 4 12 4 14C4 16 6 18 8 18" stroke="#8b9b7a" strokeWidth="1.5" strokeLinecap="round"/>
          <path d="M12 22C12 22 12 16 12 14C12 12 14 10 16 10C18 10 20 12 20 14C20 16 18 18 16 18" stroke="#a8b89a" strokeWidth="1.5" strokeLinecap="round"/>
        </svg>
      </div>
    );

    // ============================================
    // FEEDBACK MODAL - The Invitation (glassmorphism)
    // ============================================
    const FeedbackModal = ({ 
      round, daysOnApp,
      step, setStep, 
      response, setResponse, 
      text, setText, 
      email, setEmail, 
      onSend, onDismiss 
    }) => (
      <div className="fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-6 z-50">
        <div className="max-w-sm w-full space-y-8">
          
          {/* Round 1 (Day 10-14): The Commitment */}
          {round === 1 && (
            <>
              {step === 1 && (
                <div className="text-center space-y-8 fade-in">
                  <div className="space-y-4">
                    <p className="text-white/30 text-sm tracking-wide">Day {daysOnApp}</p>
                    <p className="text-white text-xl leading-relaxed">Most people quit by now.</p>
                    <p className="text-white/60">You didn't.</p>
                  </div>
                  <button onClick={() => setStep(2)} className="text-white/40 hover:text-white text-sm transition">Continue →</button>
                </div>
              )}

              {step === 2 && (
                <div className="text-center space-y-6 fade-in">
                  <p className="text-white text-lg">What are you building toward?</p>
                  <div className="space-y-2">
                    {[
                      { key: 'competition', label: 'Competition' },
                      { key: 'longevity', label: 'Longevity' },
                      { key: 'consistency', label: 'Staying consistent' },
                      { key: 'feeling', label: 'Feeling better' },
                      { key: 'other', label: 'Something else' },
                    ].map(opt => (
                      <button key={opt.key} onClick={() => { setResponse(opt.key); setStep(opt.key === 'other' ? 3 : 4); }} className="w-full glass hover:bg-white/10 text-white/70 py-3 rounded-2xl text-sm transition-all duration-300">{opt.label}</button>
                    ))}
                  </div>
                  <button onClick={() => onDismiss(false)} className="text-white/20 text-xs">Skip</button>
                </div>
              )}

              {step === 3 && (
                <div className="text-center space-y-6 fade-in">
                  <p className="text-white text-lg">Tell me more.</p>
                  <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="What are you working toward..." className="w-full glass rounded-2xl px-4 py-3 text-white text-sm placeholder-white/30 focus:outline-none resize-none h-24" autoFocus />
                  <button onClick={() => setStep(4)} className="w-full bg-white/90 text-black font-medium py-3 rounded-2xl">Continue</button>
                </div>
              )}

              {step === 4 && (
                <div className="text-center space-y-6 fade-in">
                  <div className="space-y-3">
                    <p className="text-white text-lg">I'm building something too.</p>
                    <p className="text-white/40 text-sm">Auto-sync. Deeper patterns.<br/>Predictions before you feel them.</p>
                  </div>
                  <div className="space-y-3 pt-2">
                    <p className="text-white/50 text-sm">Want early access?</p>
                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email" className="w-full glass rounded-2xl px-4 py-3 text-white text-sm text-center placeholder-white/30 focus:outline-none" />
                  </div>
                  <div className="space-y-2">
                    <button onClick={onSend} className="w-full bg-white/90 text-black font-medium py-3 rounded-2xl">I'm in</button>
                    <button onClick={onSend} className="w-full text-white/40 text-sm py-2">Just keep going</button>
                  </div>
                </div>
              )}
            </>
          )}

          {/* Round 2 (Day 35-45): The Inner Circle */}
          {round === 2 && (
            <>
              {step === 1 && (
                <div className="text-center space-y-8 fade-in">
                  <div className="space-y-4">
                    <p className="text-white/30 text-sm tracking-wide">Day {daysOnApp}</p>
                    <p className="text-white text-xl leading-relaxed">You're still here.</p>
                    <p className="text-white/40 text-sm">That puts you ahead of 95% of people<br/>who try to train smarter.</p>
                  </div>
                  <button onClick={() => setStep(2)} className="text-white/40 hover:text-white text-sm transition">Continue →</button>
                </div>
              )}

              {step === 2 && (
                <div className="text-center space-y-6 fade-in">
                  <div className="space-y-2">
                    <p className="text-white text-lg">I'm building the next version.</p>
                    <p className="text-white/40 text-sm">What would make this twice as valuable?</p>
                  </div>
                  <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="The one thing..." className="w-full glass rounded-2xl px-4 py-3 text-white text-sm placeholder-white/30 focus:outline-none resize-none h-24" autoFocus />
                  <button onClick={() => setStep(3)} className="w-full bg-white/90 text-black font-medium py-3 rounded-2xl">Continue</button>
                  <button onClick={() => setStep(3)} className="text-white/20 text-xs">Skip</button>
                </div>
              )}

              {step === 3 && (
                <div className="text-center space-y-6 fade-in">
                  <div className="space-y-3">
                    <p className="text-white text-lg">One more thing.</p>
                    <p className="text-white/40 text-sm">Anyone in your life who needs this?</p>
                    <p className="text-white/25 text-xs">A training partner. Someone who never rests.<br/>A friend who's always overtrained.</p>
                  </div>
                  <div className="space-y-2">
                    <button onClick={() => { setResponse('yes'); setStep(4); }} className="w-full glass hover:bg-white/10 text-white/70 py-3 rounded-2xl text-sm transition-all">Yes, I know someone</button>
                    <button onClick={() => { setResponse('no'); onSend(); }} className="w-full text-white/40 text-sm py-2">Not right now</button>
                  </div>
                </div>
              )}

              {step === 4 && (
                <div className="text-center space-y-6 fade-in">
                  <p className="text-white text-lg">I'll make sure they get in.</p>
                  <input type="text" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Their email or name" className="w-full glass rounded-2xl px-4 py-3 text-white text-sm text-center placeholder-white/30 focus:outline-none" autoFocus />
                  <button onClick={onSend} className="w-full bg-white/90 text-black font-medium py-3 rounded-2xl">Done</button>
                  <button onClick={onSend} className="text-white/20 text-xs">Skip</button>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    );

    // ============================================
    // HRV SOURCE SELECTOR
    // ============================================
    const HRV_SOURCES = [
      { id: 'whoop', label: 'WHOOP' },
      { id: 'apple', label: 'Apple Watch' },
      { id: 'oura', label: 'Oura' },
      { id: 'garmin', label: 'Garmin' },
      { id: 'fitbit', label: 'Fitbit' },
      { id: 'welltory', label: 'Welltory' },
    ];

    // ============================================
    // TEST DATA GENERATORS
    // ============================================
    const generateTestData = (days, scenario = 'normal') => {
      const history = [];
      const compliance = [];
      const today = new Date();
      
      // Base HRV around 55 with natural variation
      let baseHRV = 55;
      
      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = getLocalDateString(date);
        
        let hrv;
        if (scenario === 'crashing') {
          // Simulates someone who ignores REST and crashes
          hrv = baseHRV + (Math.random() * 20 - 10) - (i < 3 ? 15 : 0);
        } else if (scenario === 'recovering') {
          // Simulates someone coming out of a low period
          hrv = baseHRV + (Math.random() * 10) + (days - i) * 0.5;
        } else if (scenario === 'volatile') {
          // Big swings
          hrv = baseHRV + (Math.random() * 40 - 20);
        } else if (scenario === 'stable') {
          // Very consistent
          hrv = baseHRV + (Math.random() * 6 - 3);
        } else {
          // Normal variation
          hrv = baseHRV + (Math.random() * 16 - 8);
        }
        
        history.push({ date: dateStr, value: Math.round(hrv) });
        
        // Add some compliance data
        if (i > 0 && Math.random() > 0.3) {
          const values = history.slice(0, -1).map(h => h.value);
          if (values.length >= 3) {
            const median = calculateMedian(values);
            const mad = calculateMAD(values, median);
            const z = (hrv - median) / mad;
            const command = getCommandKey(z);
            
            compliance.push({
              date: dateStr,
              command,
              followed: Math.random() > 0.3 ? 'yes' : 'no'
            });
          }
        }
      }
      
      return { history, compliance };
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      // Core state
      const [hrvHistory, setHrvHistory] = useState([]);
      const [complianceLog, setComplianceLog] = useState([]);
      const [firstUseDate, setFirstUseDate] = useState(null);
      const [hrvSource, setHrvSource] = useState(null);
      const [userName, setUserName] = useState('');
      const [isLoading, setIsLoading] = useState(true);
      
      // UI state
      const [todayHRV, setTodayHRV] = useState('');
      const [result, setResult] = useState(null);
      const [showAddHistory, setShowAddHistory] = useState(false);
      const [newEntry, setNewEntry] = useState('');
      const [newEntryDate, setNewEntryDate] = useState(getYesterdayLocal());
      
      // Observation tracking
      const [lastObservationType, setLastObservationType] = useState(null);
      const [lastObservationDate, setLastObservationDate] = useState(null);

      // Feedback state
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackRound, setFeedbackRound] = useState(1);
      const [feedbackStep, setFeedbackStep] = useState(1);
      const [feedbackResponse, setFeedbackResponse] = useState(null);
      const [feedbackText, setFeedbackText] = useState('');
      const [feedbackEmail, setFeedbackEmail] = useState('');
      const [feedbackRound1Complete, setFeedbackRound1Complete] = useState(false);
      const [feedbackRound1Response, setFeedbackRound1Response] = useState(null);
      const [feedbackRound1DismissedAt, setFeedbackRound1DismissedAt] = useState(null);
      const [feedbackRound2Complete, setFeedbackRound2Complete] = useState(false);

      // TEST MODE state
      const [showDebug, setShowDebug] = useState(false);
      const [simulatedDaysOnApp, setSimulatedDaysOnApp] = useState(null);

      // Load from localStorage
      useEffect(() => {
        try {
          const saved = localStorage.getItem('genysys_v2_test_data');
          if (saved) {
            const data = JSON.parse(saved);
            setHrvHistory(data.hrvHistory || []);
            setComplianceLog(data.complianceLog || []);
            setFirstUseDate(data.firstUseDate || null);
            setHrvSource(data.hrvSource || null);
            setUserName(data.userName || '');
            setLastObservationType(data.lastObservationType || null);
            setLastObservationDate(data.lastObservationDate || null);
            setFeedbackRound1Complete(data.feedbackRound1Complete || false);
            setFeedbackRound1Response(data.feedbackRound1Response || null);
            setFeedbackRound1DismissedAt(data.feedbackRound1DismissedAt || null);
            setFeedbackRound2Complete(data.feedbackRound2Complete || false);
          }
        } catch (e) { 
          console.log('No saved data'); 
        }
        setIsLoading(false);
      }, []);

      // Save to localStorage
      useEffect(() => {
        if (isLoading) return;
        localStorage.setItem('genysys_v2_test_data', JSON.stringify({
          hrvHistory, complianceLog, firstUseDate, hrvSource, userName,
          lastObservationType, lastObservationDate,
          feedbackRound1Complete, feedbackRound1Response, feedbackRound1DismissedAt, feedbackRound2Complete
        }));
      }, [hrvHistory, complianceLog, firstUseDate, hrvSource, userName, lastObservationType, lastObservationDate, feedbackRound1Complete, feedbackRound1Response, feedbackRound1DismissedAt, feedbackRound2Complete, isLoading]);

      // Set firstUseDate when they start
      useEffect(() => {
        if (hrvSource && !firstUseDate) {
          setFirstUseDate(getTodayLocal());
        }
      }, [hrvSource, firstUseDate]);

      // Calculate days on app (or use simulated)
      const daysOnApp = useMemo(() => {
        if (simulatedDaysOnApp !== null) return simulatedDaysOnApp;
        if (!firstUseDate) return 0;
        return Math.floor((new Date() - new Date(firstUseDate)) / (1000 * 60 * 60 * 24)) + 1;
      }, [firstUseDate, simulatedDaysOnApp]);

      // Auto-calculate if today's data exists
      useEffect(() => {
        if (isLoading || !hrvSource) return;
        const todayDate = getTodayLocal();
        const todayEntry = hrvHistory.find(h => h.date === todayDate);
        if (todayEntry) {
          setTodayHRV(todayEntry.value.toString());
          calculateResult(todayEntry.value, hrvHistory);
        }
      }, [isLoading, hrvHistory, hrvSource]);

      const calculateResult = (hrv, history) => {
        const todayDate = getTodayLocal();
        const historyWithoutToday = history.filter(h => h.date !== todayDate);
        const values = historyWithoutToday.map(h => h.value);
        
        const isPreview = values.length >= THRESHOLDS.MIN_PREVIEW_DAYS && values.length < THRESHOLDS.MIN_DAYS;
        
        if (values.length < THRESHOLDS.MIN_PREVIEW_DAYS) {
          setResult({ 
            commandKey: 'LEARNING', 
            daysNeeded: THRESHOLDS.MIN_PREVIEW_DAYS - values.length,
            isPreview: false 
          });
          return;
        }
        
        const median = calculateMedian(values);
        const mad = calculateMAD(values, median);
        const zScore = (hrv - median) / mad;
        const commandKey = getCommandKey(zScore);
        
        setResult({ 
          commandKey, 
          baseline: median, 
          mad, 
          zScore, 
          todayValue: hrv,
          isPreview,
          daysUntilFull: isPreview ? THRESHOLDS.MIN_DAYS - values.length : 0
        });

        const existingLog = complianceLog.findIndex(c => c.date === todayDate);
        if (existingLog >= 0) {
          setComplianceLog(complianceLog.map((c, i) => i === existingLog ? { ...c, command: commandKey } : c));
        } else {
          setComplianceLog([...complianceLog, { date: todayDate, command: commandKey, followed: null }]);
        }
      };

      const handleSubmitHRV = () => {
        const hrv = parseFloat(todayHRV);
        if (isNaN(hrv) || hrv <= 0) return;
        
        const todayDate = getTodayLocal();
        let newHistory = [...hrvHistory];
        const existingIndex = newHistory.findIndex(h => h.date === todayDate);
        
        if (existingIndex >= 0) {
          newHistory[existingIndex] = { value: hrv, date: todayDate };
        } else {
          newHistory.push({ value: hrv, date: todayDate });
        }
        
        newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        setHrvHistory(newHistory);
        calculateResult(hrv, newHistory);

        if (lastObservationDate !== todayDate) {
          setLastObservationType(null);
          setLastObservationDate(todayDate);
        }
      };

      const addHistoricalEntry = () => {
        const val = parseFloat(newEntry);
        if (isNaN(val) || val <= 0) return;
        
        let newHistory = [...hrvHistory];
        const existingIndex = newHistory.findIndex(h => h.date === newEntryDate);
        
        if (existingIndex >= 0) {
          newHistory[existingIndex] = { value: val, date: newEntryDate };
        } else {
          newHistory.push({ value: val, date: newEntryDate });
        }
        
        newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        setHrvHistory(newHistory);
        setNewEntry('');
        
        const prevDate = new Date(newEntryDate);
        prevDate.setDate(prevDate.getDate() - 1);
        setNewEntryDate(getLocalDateString(prevDate));
      };

      // Yesterday compliance
      const yesterdayDate = getYesterdayLocal();
      const yesterdayLog = complianceLog.find(c => c.date === yesterdayDate);
      const needsYesterdayCompliance = yesterdayLog?.command && 
        yesterdayLog.command !== 'LEARNING' && 
        yesterdayLog.followed === null;

      const recordCompliance = (followed) => {
        setComplianceLog(complianceLog.map(c => 
          c.date === yesterdayDate ? { ...c, followed } : c
        ));
      };

      // Pattern analysis
      const patterns = useMemo(() => 
        analyzePatterns(hrvHistory, complianceLog, firstUseDate),
        [hrvHistory, complianceLog, firstUseDate]
      );

      // Generate observation
      const observation = useMemo(() => {
        if (!result) return null;
        const obs = generateObservation(
          result.commandKey, 
          patterns, 
          daysOnApp, 
          lastObservationType,
          hrvHistory
        );
        return obs;
      }, [result, patterns, daysOnApp, lastObservationType, hrvHistory]);

      useEffect(() => {
        if (observation && observation.type !== lastObservationType) {
          setLastObservationType(observation.type);
        }
      }, [observation]);

      // Generate promise
      const promise = useMemo(() => {
        if (!result) return null;
        return generatePromise(result.commandKey, patterns);
      }, [result, patterns]);

      const hasTodayHRV = hrvHistory.some(h => h.date === getTodayLocal());
      const styles = result ? COMMAND_STYLES[result.commandKey] : COMMAND_STYLES.LEARNING;

      // ============================================
      // FEEDBACK SYSTEM
      // ============================================
      const shouldShowFeedback = () => {
        if (!feedbackRound1Complete && !feedbackRound1DismissedAt && daysOnApp >= 10 && daysOnApp <= 14) return 1;
        if (!feedbackRound2Complete && daysOnApp >= 35 && daysOnApp <= 45) {
          if (feedbackRound1Response === 'yes' || feedbackRound1Complete || daysOnApp >= 35) return 2;
        }
        return 0;
      };

      useEffect(() => {
        if (result && result.commandKey && result.commandKey !== 'LEARNING') {
          const round = shouldShowFeedback();
          if (round > 0) {
            const timer = setTimeout(() => {
              setFeedbackRound(round);
              setFeedbackStep(1);
              setFeedbackResponse(null);
              setFeedbackText('');
              setShowFeedback(true);
            }, 2000);
            return () => clearTimeout(timer);
          }
        }
      }, [result?.commandKey, daysOnApp]);

      const sendFeedback = () => {
        if (feedbackRound === 1) {
          setFeedbackRound1Complete(true);
          setFeedbackRound1Response(feedbackResponse);
        } else if (feedbackRound === 2) {
          setFeedbackRound2Complete(true);
        }
        setShowFeedback(false);
        setFeedbackStep(1);
        setFeedbackText('');
        setFeedbackEmail('');
      };

      const dismissFeedback = (dontAskAgain) => {
        if (feedbackRound === 1) {
          if (dontAskAgain) setFeedbackRound1Complete(true);
          else setFeedbackRound1DismissedAt(getTodayLocal());
        } else if (feedbackRound === 2) {
          setFeedbackRound2Complete(true);
        }
        setShowFeedback(false);
        setFeedbackStep(1);
      };

      // Reset function
      const resetAll = () => {
        localStorage.removeItem('genysys_v2_test_data');
        setHrvHistory([]);
        setComplianceLog([]);
        setFirstUseDate(null);
        setHrvSource(null);
        setUserName('');
        setResult(null);
        setTodayHRV('');
        setLastObservationType(null);
        setLastObservationDate(null);
        setSimulatedDaysOnApp(null);
        setFeedbackRound1Complete(false);
        setFeedbackRound1Response(null);
        setFeedbackRound1DismissedAt(null);
        setFeedbackRound2Complete(false);
      };

      // Load test scenario
      const loadTestScenario = (days, scenario) => {
        const { history, compliance } = generateTestData(days, scenario);
        setHrvHistory(history);
        setComplianceLog(compliance);
        setHrvSource({ id: 'test', label: 'Test Mode' });
        
        // Set first use date to simulate correct days on app
        const firstDate = new Date();
        firstDate.setDate(firstDate.getDate() - days + 1);
        setFirstUseDate(getLocalDateString(firstDate));
        
        // Calculate result for today
        const today = history.find(h => h.date === getTodayLocal());
        if (today) {
          setTodayHRV(today.value.toString());
          calculateResult(today.value, history);
        }
      };

      if (isLoading) {
        return (
          <div className="min-h-screen text-white flex items-center justify-center">
            <div className="mist-overlay"></div>
            <div className="content-layer text-white/40 pulse-slow">...</div>
          </div>
        );
      }

      // ============================================
      // DEBUG PANEL
      // ============================================
      const DebugPanel = () => (
        <div className="fixed bottom-0 left-0 right-0 bg-zinc-900 border-t border-zinc-800 p-4 z-50">
          <div className="max-w-lg mx-auto space-y-4">
            <div className="flex justify-between items-center">
              <span className="text-xs text-zinc-500 font-mono">TEST MODE</span>
              <button onClick={() => setShowDebug(false)} className="text-zinc-500 text-lg">×</button>
            </div>
            
            {/* Quick load scenarios */}
            <div className="space-y-2">
              <div className="text-xs text-zinc-600">Load Test Scenario:</div>
              <div className="flex flex-wrap gap-2">
                <button onClick={() => loadTestScenario(7, 'normal')} className="bg-zinc-800 px-3 py-1 rounded text-xs">Day 7 Normal</button>
                <button onClick={() => loadTestScenario(30, 'normal')} className="bg-zinc-800 px-3 py-1 rounded text-xs">Day 30 Normal</button>
                <button onClick={() => loadTestScenario(60, 'normal')} className="bg-zinc-800 px-3 py-1 rounded text-xs">Day 60 Normal</button>
                <button onClick={() => loadTestScenario(90, 'normal')} className="bg-zinc-800 px-3 py-1 rounded text-xs">Day 90 Normal</button>
                <button onClick={() => loadTestScenario(14, 'crashing')} className="bg-red-900/50 px-3 py-1 rounded text-xs">Crashing</button>
                <button onClick={() => loadTestScenario(14, 'recovering')} className="bg-green-900/50 px-3 py-1 rounded text-xs">Recovering</button>
                <button onClick={() => loadTestScenario(14, 'volatile')} className="bg-amber-900/50 px-3 py-1 rounded text-xs">Volatile</button>
              </div>
            </div>

            {/* Simulate days */}
            <div className="flex items-center gap-2">
              <span className="text-xs text-zinc-600">Simulate Day:</span>
              <input
                type="number"
                value={simulatedDaysOnApp || ''}
                onChange={(e) => setSimulatedDaysOnApp(e.target.value ? parseInt(e.target.value) : null)}
                placeholder="actual"
                className="w-20 bg-zinc-800 rounded px-2 py-1 text-xs"
              />
              <button 
                onClick={() => setSimulatedDaysOnApp(null)}
                className="text-xs text-zinc-500"
              >
                reset
              </button>
            </div>

            {/* Current state */}
            <div className="text-xs font-mono text-zinc-600 space-y-1">
              <div>Days: {daysOnApp} | HRV entries: {hrvHistory.length} | Compliance: {complianceLog.length}</div>
              <div>Command: {result?.commandKey || 'none'} | Z: {result?.zScore?.toFixed(2) || 'N/A'}</div>
              <div>Observation type: {observation?.type || 'none'}</div>
              <div>Patterns: trend={patterns?.trend || 'N/A'}, below={patterns?.consecutiveBelowBaseline || 0}, crashes={patterns?.crashesAfterIgnoredRest?.length || 0}</div>
              <div>Feedback: R1={feedbackRound1Complete ? 'done' : 'pending'} ({feedbackRound1Response || '-'}) | R2={feedbackRound2Complete ? 'done' : 'pending'}</div>
            </div>

            {/* Actions */}
            <div className="flex flex-wrap gap-2">
              <button onClick={resetAll} className="bg-red-900 px-3 py-1 rounded text-xs">Reset All</button>
              <button 
                onClick={() => setLastObservationType(null)} 
                className="bg-zinc-800 px-3 py-1 rounded text-xs"
              >
                Reset Observation
              </button>
              <button 
                onClick={() => { setFeedbackRound(1); setFeedbackStep(1); setShowFeedback(true); }} 
                className="bg-blue-900/50 px-3 py-1 rounded text-xs"
              >
                Test Feedback R1
              </button>
              <button 
                onClick={() => { setFeedbackRound(2); setFeedbackStep(1); setShowFeedback(true); }} 
                className="bg-blue-900/50 px-3 py-1 rounded text-xs"
              >
                Test Feedback R2
              </button>
              <button 
                onClick={() => { setFeedbackRound1Complete(false); setFeedbackRound1Response(null); setFeedbackRound1DismissedAt(null); setFeedbackRound2Complete(false); }} 
                className="bg-zinc-800 px-3 py-1 rounded text-xs"
              >
                Reset Feedback
              </button>
            </div>
          </div>
        </div>
      );

      // ============================================
      // FIRST SCREEN
      // ============================================
      if (!hrvSource) {
        return (
          <div className="min-h-screen text-white p-6 flex flex-col justify-center">
            <div className="mist-overlay"></div>
            <div className="content-layer max-w-sm mx-auto space-y-12">
              
              <div className="space-y-6 text-center fade-in">
                <p className="text-white/60 text-lg leading-relaxed">
                  I'm going to learn your body.
                </p>
                <p className="text-white text-xl leading-relaxed">
                  Not bodies in general. Yours.
                </p>
              </div>

              <div className="space-y-3 text-center text-white/40 fade-in-delay-1">
                <p>Give me a week and I'll know your baseline.</p>
                <p>Give me a month and I'll know your patterns.</p>
                <p>Give me a year and I'll know you better than anyone.</p>
              </div>

              <div className="space-y-4 fade-in-delay-2">
                <p className="text-white/30 text-sm text-center">Where does your HRV come from?</p>
                <div className="grid grid-cols-2 gap-2">
                  {HRV_SOURCES.map(source => (
                    <button
                      key={source.id}
                      onClick={() => setHrvSource(source)}
                      className="glass hover:bg-white/10 rounded-2xl py-3 px-4 text-sm text-white/70 transition-all duration-300"
                    >
                      {source.label}
                    </button>
                  ))}
                </div>
              </div>

            </div>

            {/* Test mode button */}
            <button
              onClick={() => setShowDebug(true)}
              className="fixed bottom-4 right-4 bg-amber-600 text-black text-xs font-bold px-3 py-2 rounded-lg z-20"
            >
              🧪 TEST
            </button>
            {showDebug && <DebugPanel />}
            <Tagline />
          </div>
        );
      }

      // ============================================
      // HRV INPUT
      // ============================================
      if (!hasTodayHRV) {
        return (
          <div className="min-h-screen text-white p-6 flex flex-col">
            <div className="mist-overlay"></div>
            <div className="content-layer max-w-sm mx-auto flex-1 flex flex-col justify-center space-y-8">
              
              <div className="text-center fade-in">
                <div className="text-white/30 text-sm tracking-wide">
                  {daysOnApp <= 1 ? "Day 1" : `Day ${daysOnApp}`}
                </div>
              </div>

              {needsYesterdayCompliance && (
                <div className="glass rounded-2xl p-5 space-y-4 fade-in">
                  <p className="text-white/60 text-center">
                    Yesterday I said <span style={{ color: COMMAND_STYLES[yesterdayLog.command].color }}>{yesterdayLog.command}</span>
                  </p>
                  <div className="flex gap-3">
                    <button
                      onClick={() => recordCompliance('yes')}
                      className="flex-1 glass-light hover:bg-white/10 rounded-xl py-3 text-sm text-white/80 transition-all duration-300"
                    >
                      I listened
                    </button>
                    <button
                      onClick={() => recordCompliance('no')}
                      className="flex-1 glass-light hover:bg-white/10 rounded-xl py-3 text-sm text-white/80 transition-all duration-300"
                    >
                      I didn't
                    </button>
                  </div>
                </div>
              )}

              <div className="space-y-4 fade-in-delay-1">
                <p className="text-white/60 text-center text-lg">
                  {daysOnApp <= 1 ? "What's your HRV this morning?" : "What's your HRV?"}
                </p>
                <div className="flex gap-3">
                  <input
                    type="number"
                    value={todayHRV}
                    onChange={(e) => setTodayHRV(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSubmitHRV()}
                    placeholder="HRV"
                    className="flex-1 glass rounded-2xl px-4 py-4 text-2xl text-center font-light text-white placeholder-white/30 focus:outline-none focus:ring-1 focus:ring-white/20 transition-all"
                    autoFocus
                  />
                  <button
                    onClick={handleSubmitHRV}
                    className="bg-white/90 text-black rounded-2xl px-6 py-4 font-medium hover:bg-white transition-all duration-300"
                  >
                    Go
                  </button>
                </div>
                <p className="text-white/20 text-xs text-center">
                  from {hrvSource.label}
                </p>
              </div>

              <button
                onClick={() => setShowAddHistory(true)}
                className="text-white/30 text-sm hover:text-white/50 transition-all"
              >
                + Add past days
              </button>

            </div>

            {/* Test button */}
            <button
              onClick={() => setShowDebug(true)}
              className="fixed bottom-4 right-4 bg-amber-600 text-black text-xs font-bold px-3 py-2 rounded-lg z-20"
            >
              🧪 TEST
            </button>
            {showDebug && <DebugPanel />}

            {showAddHistory && (
              <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center z-50">
                <div className="glass-dark rounded-t-3xl p-6 w-full max-w-md space-y-6">
                  <div className="flex justify-between items-center">
                    <h3 className="text-lg font-medium text-white">Add Past HRV</h3>
                    <button 
                      onClick={() => setShowAddHistory(false)}
                      className="text-white/40 hover:text-white text-2xl"
                    >
                      ×
                    </button>
                  </div>
                  
                  <p className="text-white/40 text-sm">
                    The more history I have, the faster I learn you.
                  </p>
                  
                  <div className="flex gap-2">
                    <input
                      type="number"
                      value={newEntry}
                      onChange={(e) => setNewEntry(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && addHistoricalEntry()}
                      placeholder="HRV"
                      className="w-24 glass rounded-xl px-3 py-3 text-center text-white placeholder-white/30 focus:outline-none"
                      autoFocus
                    />
                    <input
                      type="date"
                      value={newEntryDate}
                      onChange={(e) => setNewEntryDate(e.target.value)}
                      className="flex-1 glass rounded-xl px-3 py-3 text-white/60 focus:outline-none"
                    />
                    <button
                      onClick={addHistoricalEntry}
                      className="glass-light hover:bg-white/10 rounded-xl px-4 py-3 text-white/80 transition-all"
                    >
                      Add
                    </button>
                  </div>

                  {hrvHistory.length > 0 && (
                    <div className="space-y-2 max-h-48 overflow-y-auto">
                      {[...hrvHistory].reverse().slice(0, 14).map((entry, i) => (
                        <div key={entry.date} className="flex justify-between text-sm text-white/40 py-2 border-b border-white/5">
                          <span>{entry.date}</span>
                          <span className="font-mono">{entry.value} ms</span>
                        </div>
                      ))}
                    </div>
                  )}

                  <button
                    onClick={() => setShowAddHistory(false)}
                    className="w-full glass-light hover:bg-white/10 rounded-xl py-3 text-white/80 transition-all"
                  >
                    Done — {hrvHistory.length} days logged
                  </button>
                </div>
              </div>
            )}
            
            <Tagline />
          </div>
        );
      }

      // ============================================
      // MAIN VIEW
      // ============================================
      return (
        <div className="min-h-screen text-white p-6 flex flex-col">
          <div className="mist-overlay"></div>
          <div className="content-layer max-w-sm mx-auto flex-1 flex flex-col justify-center space-y-8">
            
            <div className="text-center">
              <span className="text-white/30 text-sm tracking-wide">Day {daysOnApp}</span>
            </div>

            {observation && (
              <div className="text-center space-y-2 fade-in">
                <p className="text-white/70 text-lg leading-relaxed px-4">
                  "{observation.text}"
                </p>
              </div>
            )}

            <div 
              className="glass rounded-3xl py-12 px-8 text-center fade-in-delay-1"
              style={{ 
                boxShadow: `0 8px 32px ${styles.glow || 'rgba(0,0,0,0.2)'}`,
                borderColor: styles.border
              }}
            >
              <div 
                className="text-6xl font-bold tracking-tight"
                style={{ color: styles.color }}
              >
                {result?.commandKey || 'LEARNING'}
              </div>
            </div>

            {promise && (
              <div className="text-center fade-in-delay-2">
                <p className="text-white/40 text-base italic">
                  {promise}
                </p>
              </div>
            )}

            {result?.isPreview && (
              <div className="text-center">
                <p className="text-white/20 text-xs">
                  Still calibrating — {result.daysUntilFull} more days
                </p>
              </div>
            )}

            {patterns && daysOnApp >= 14 && (
              <div className="text-center pt-8">
                <p className="text-white/15 text-xs">
                  {patterns.performDays} peaks · {patterns.restDays} protected · {patterns.totalDays} days watched
                </p>
              </div>
            )}

          </div>

          <div className="content-layer max-w-sm mx-auto w-full pt-8 flex justify-between text-white/20 text-xs">
            <button 
              onClick={() => setShowAddHistory(true)}
              className="hover:text-white/40 transition-all"
            >
              + Add history
            </button>
            <button 
              onClick={resetAll}
              className="hover:text-white/40 transition-all"
            >
              Reset
            </button>
          </div>

          {/* Test button */}
          <button
            onClick={() => setShowDebug(true)}
            className="fixed bottom-4 right-4 bg-amber-600 text-black text-xs font-bold px-3 py-2 rounded-lg z-20"
          >
            🧪 TEST
          </button>
          {showDebug && <DebugPanel />}

          {showAddHistory && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center z-50">
              <div className="glass-dark rounded-t-3xl p-6 w-full max-w-md space-y-6">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-medium text-white">Add Past HRV</h3>
                  <button 
                    onClick={() => setShowAddHistory(false)}
                    className="text-white/40 hover:text-white text-2xl"
                  >
                    ×
                  </button>
                </div>
                
                <div className="flex gap-2">
                  <input
                    type="number"
                    value={newEntry}
                    onChange={(e) => setNewEntry(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && addHistoricalEntry()}
                    placeholder="HRV"
                    className="w-24 glass rounded-xl px-3 py-3 text-center text-white placeholder-white/30 focus:outline-none"
                    autoFocus
                  />
                  <input
                    type="date"
                    value={newEntryDate}
                    onChange={(e) => setNewEntryDate(e.target.value)}
                    className="flex-1 glass rounded-xl px-3 py-3 text-white/60 focus:outline-none"
                  />
                  <button
                    onClick={addHistoricalEntry}
                    className="glass-light hover:bg-white/10 rounded-xl px-4 py-3 text-white/80 transition-all"
                  >
                    Add
                  </button>
                </div>

                {hrvHistory.length > 0 && (
                  <div className="space-y-2 max-h-48 overflow-y-auto">
                    {[...hrvHistory].reverse().slice(0, 14).map((entry, i) => (
                      <div key={entry.date} className="flex justify-between text-sm text-white/40 py-2 border-b border-white/5">
                        <span>{entry.date}</span>
                        <span className="font-mono">{entry.value} ms</span>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={() => setShowAddHistory(false)}
                  className="w-full glass-light hover:bg-white/10 rounded-xl py-3 text-white/80 transition-all"
                >
                  Done
                </button>
              </div>
            </div>
          )}

          {/* Feedback Modal */}
          {showFeedback && (
            <FeedbackModal
              round={feedbackRound}
              daysOnApp={daysOnApp}
              step={feedbackStep}
              setStep={setFeedbackStep}
              response={feedbackResponse}
              setResponse={setFeedbackResponse}
              text={feedbackText}
              setText={setFeedbackText}
              email={feedbackEmail}
              setEmail={setFeedbackEmail}
              onSend={sendFeedback}
              onDismiss={dismissFeedback}
            />
          )}
          
          <Tagline />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
