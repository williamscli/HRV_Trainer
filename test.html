<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0A0A0A">
  <title>GENYSYS</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js" crossorigin="anonymous"></script>
  
  <style>
    :root {
      --bg-primary: #0A0A0A;
      --bg-elevated: #111111;
      --bg-card: #161616;
      --text-primary: #F5F5F0;
      --text-secondary: #A1A1AA;
      --text-muted: #71717A;
      --text-faint: #3F3F46;
      --gold: #C9A962;
      --gold-dim: rgba(201, 169, 98, 0.12);
      --green: #6EE7B7;
      --green-dim: rgba(110, 231, 183, 0.08);
      --rose: #FDA4AF;
      --rose-dim: rgba(253, 164, 175, 0.08);
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
    
    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      line-height: 1.6;
    }
    
    .font-display { font-family: var(--font-display); font-weight: 300; letter-spacing: 0.02em; }
    
    @keyframes fadeRise {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes breathe { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.7; } }
    
    .animate-rise { animation: fadeRise 600ms cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .animate-fade { animation: fadeIn 400ms ease-out forwards; }
    .animate-breathe { animation: breathe 4s ease-in-out infinite; }
    
    .delay-100 { animation-delay: 100ms; opacity: 0; }
    .delay-200 { animation-delay: 200ms; opacity: 0; }
    .delay-300 { animation-delay: 300ms; opacity: 0; }
    .delay-400 { animation-delay: 400ms; opacity: 0; }
    .delay-600 { animation-delay: 600ms; opacity: 0; }
    .delay-800 { animation-delay: 800ms; opacity: 0; }
    .delay-1000 { animation-delay: 1000ms; opacity: 0; }
    .delay-1500 { animation-delay: 1500ms; opacity: 0; }
    
    .btn-primary {
      background: transparent;
      border: 1px solid var(--text-faint);
      color: var(--text-secondary);
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 15px;
      cursor: pointer;
      transition: all 150ms ease;
      width: 100%;
    }
    .btn-primary:active { background: var(--bg-elevated); border-color: var(--gold); color: var(--gold); }
    .btn-primary.active { background: var(--bg-elevated); border-color: var(--gold); color: var(--gold); }
    
    .btn-ghost {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 12px 20px;
      font-size: 14px;
      cursor: pointer;
      transition: color 150ms ease;
    }
    .btn-ghost:hover { color: var(--text-secondary); }
    
    .input-minimal {
      background: transparent;
      border: 1px solid var(--text-faint);
      border-radius: 12px;
      padding: 16px 20px;
      color: var(--text-primary);
      font-size: 17px;
      font-family: var(--font-body);
      width: 100%;
      text-align: center;
      outline: none;
      transition: border-color 150ms ease;
    }
    .input-minimal:focus { border-color: var(--gold); }
    .input-minimal::placeholder { color: var(--text-faint); }
    
    .divider { height: 1px; background: var(--text-faint); opacity: 0.25; margin: 24px 0; }
    
    /* Collapsible Insight Block - Scroll metaphor */
    .insight-scroll {
      margin: 0 24px 16px 24px;
      cursor: pointer;
    }
    
    /* Collapsed state - line with INSIGHT label */
    .insight-collapsed-line {
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 1;
      transform: scaleY(1);
      transition: all 400ms cubic-bezier(0.16, 1, 0.3, 1);
    }
    .insight-scroll.open .insight-collapsed-line {
      opacity: 0;
      transform: scaleY(0);
      height: 0;
      margin: 0;
      pointer-events: none;
    }
    .insight-collapsed-line-segment {
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--gold), var(--gold));
      opacity: 0.6;
    }
    .insight-collapsed-line-segment:first-child {
      background: linear-gradient(90deg, transparent, var(--gold));
    }
    .insight-collapsed-line-segment:last-child {
      background: linear-gradient(90deg, var(--gold), transparent);
    }
    .insight-collapsed-label {
      font-size: 10px;
      letter-spacing: 0.2em;
      color: var(--gold);
      opacity: 0.7;
      font-weight: 500;
    }
    
    /* Tap hint */
    .insight-tap-hint {
      text-align: center;
      margin-top: 8px;
      opacity: 0;
      transform: translateY(-4px);
      transition: all 300ms ease;
      pointer-events: none;
    }
    .insight-tap-hint.visible {
      opacity: 0.4;
      transform: translateY(0);
    }
    
    /* Content wrapper - handles the scroll animation */
    .insight-scroll-wrapper {
      display: grid;
      grid-template-rows: 0fr;
      opacity: 0;
      transform-origin: top center;
      transition: grid-template-rows 500ms cubic-bezier(0.16, 1, 0.3, 1),
                  opacity 400ms cubic-bezier(0.16, 1, 0.3, 1) 100ms;
    }
    .insight-scroll.open .insight-scroll-wrapper {
      grid-template-rows: 1fr;
      opacity: 1;
    }
    .insight-scroll-inner {
      overflow: hidden;
    }
    
    .insight-scroll-line {
      height: 1px;
      background: linear-gradient(90deg, var(--gold) 0%, transparent 100%);
      transition: all 300ms ease;
    }
    .insight-scroll-content {
      padding: 16px 0 16px 20px;
      border-left: 2px solid var(--gold);
      overflow: hidden;
    }
    .insight-scroll-label { 
      font-size: 11px; 
      letter-spacing: 0.15em; 
      text-transform: uppercase; 
      color: var(--text-muted); 
      margin-bottom: 6px; 
    }
    .insight-scroll-text { 
      font-family: var(--font-display); 
      font-style: italic; 
      font-size: 16px; 
      line-height: 1.7; 
      color: var(--text-secondary); 
    }
    
    /* Legacy insight block */
    .insight-block {
      border-left: 2px solid var(--gold);
      padding-left: 20px;
      margin-top: 32px;
    }
    .insight-label { font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
    .insight-content { font-family: var(--font-display); font-style: italic; font-size: 16px; line-height: 1.5; color: var(--text-secondary); }
    
    /* Event Log - collapsible section */
    .event-log {
      margin: 24px 24px 16px 24px;
      cursor: pointer;
      transition: all 300ms cubic-bezier(0.16, 1, 0.3, 1);
    }
    .event-log-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .event-log-label {
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 8px;
    }
    .event-log-line {
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, var(--gold) 0%, transparent 100%);
      transition: all 300ms ease;
    }
    .event-log-content {
      padding: 20px 0 16px 20px;
      border-left: 2px solid var(--gold);
      overflow: hidden;
      transition: all 300ms cubic-bezier(0.16, 1, 0.3, 1);
    }
    .event-log.collapsed .event-log-content {
      height: 0;
      padding: 0;
      opacity: 0;
      border-left-color: transparent;
    }
    .event-log-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    .event-log-btn {
      padding: 10px 18px;
      border: 1px solid var(--gold);
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 200ms ease;
    }
    .event-log-btn:hover {
      background: var(--gold);
      color: var(--bg-primary);
    }
    .event-log-btn.selected {
      background: var(--gold);
      color: var(--bg-primary);
    }
    .event-log-other {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--text-faint);
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      transition: border-color 200ms ease;
    }
    .event-log-other:focus {
      outline: none;
      border-color: var(--gold);
    }
    .event-log-other::placeholder {
      color: var(--text-faint);
    }
    .event-log-confirm {
      margin-top: 16px;
      padding: 10px 24px;
      background: var(--gold);
      color: var(--bg-primary);
      border: none;
      border-radius: 6px;
      font-size: 13px;
      letter-spacing: 0.05em;
      cursor: pointer;
      opacity: 0.4;
      transition: opacity 200ms ease;
    }
    .event-log-confirm.active {
      opacity: 1;
    }
    .event-log-confirm.active:hover {
      opacity: 0.85;
    }
    .event-log-success {
      color: var(--green);
      font-size: 13px;
      margin-top: 12px;
      opacity: 0;
      transition: opacity 300ms ease;
    }
    .event-log-success.show {
      opacity: 1;
    }
    
    .device-btn {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid var(--text-faint);
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      transition: all 150ms ease;
    }
    .device-btn:hover { border-color: var(--text-muted); }
    .device-btn.selected { border-color: var(--gold); color: var(--gold); background: var(--gold-dim); }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 100; }
    .modal-content { position: fixed; inset: 0; z-index: 101; overflow-y: auto; }
    
    ::-webkit-scrollbar { width: 0; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // ════════════════════════════════════════════════════════════════════════════
    // UTILITIES (must be before Analytics)
    // ════════════════════════════════════════════════════════════════════════════
    const getLocalDateString = (date = new Date()) => {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    };
    const getTodayLocal = () => getLocalDateString();
    const getYesterdayLocal = () => {
      const d = new Date(); d.setDate(d.getDate() - 1);
      return getLocalDateString(d);
    };

    const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });

    // ════════════════════════════════════════════════════════════════════════════
    // ANALYTICS
    // ════════════════════════════════════════════════════════════════════════════
    const ANALYTICS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxP8OImAXDl8fwUG1ksGSTvlFID9wZQ90es4f4Ry1FWQAVqcDa27rXeeyd19JBH_eBG/exec';
    const ALLOWED_EVENTS = [
      'session_start', 'onboarding_complete', 'first_hrv_logged', 'hrv_logged',
      'hrv_backfilled', 'command_generated', 'compliance_recorded', 'event_logged',
      'day_3_active', 'day_7_active', 'day_14_active', 'day_30_active', 'day_60_active', 'day_90_active',
      'milestone_reached', 'observation_shown',
      'feedback_submitted', 'feedback_round1_submitted', 'feedback_round1_dismissed', 
      'feedback_round2_submitted', 'feedback_round2_dismissed',
      'data_exported', 'data_reset', 'legacy_user_migrated'
    ];

    const Analytics = {
      userId: null,
      timezone: null,
      device: null,
      firstUseDate: null,

      init() {
        const stored = localStorage.getItem('genysys_analytics');
        if (stored) {
          const data = JSON.parse(stored);
          Object.assign(this, data);
        } else {
          this.userId = generateUUID();
          this.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          this.firstUseDate = getTodayLocal();
          this.save();
        }
      },

      save() {
        localStorage.setItem('genysys_analytics', JSON.stringify({
          userId: this.userId, timezone: this.timezone, firstUseDate: this.firstUseDate
        }));
      },

      setDevice(device) { this.device = device; },
      
      getDaysActive() {
        if (!this.firstUseDate) return 0;
        return Math.floor((new Date() - new Date(this.firstUseDate)) / (1000 * 60 * 60 * 24));
      },

      track(event, props = {}) {
        if (!ALLOWED_EVENTS.includes(event)) return;
        const payload = {
          timestamp: new Date().toISOString(),
          userId: this.userId,
          event,
          device: this.device || props.device || 'unknown',
          daysActive: this.getDaysActive(),
          region: this.timezone,
          ...props
        };
        console.log('[Analytics]', event, payload);
        if (ANALYTICS_ENDPOINT && !ANALYTICS_ENDPOINT.includes('YOUR_GOOGLE')) {
          fetch(ANALYTICS_ENDPOINT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }).catch(() => {});
        }
      }
    };
    Analytics.init();

    // ════════════════════════════════════════════════════════════════════════════
    // MORE UTILITIES
    // ════════════════════════════════════════════════════════════════════════════
    const getDayName = (dateStr) => ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][new Date(dateStr + 'T12:00:00').getDay()];
    const formatDateAnchor = (dateStr) => {
      if (!dateStr) return null;
      const d = new Date(dateStr + 'T12:00:00');
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const day = d.getDate();
      const suffix = [1,21,31].includes(day) ? 'st' : [2,22].includes(day) ? 'nd' : [3,23].includes(day) ? 'rd' : 'th';
      return `${months[d.getMonth()]} ${day}${suffix}`;
    };
    const daysBetween = (d1, d2) => Math.floor((new Date(d2) - new Date(d1)) / 86400000);

    // ════════════════════════════════════════════════════════════════════════════
    // ALGORITHM (Validated Control Stack)
    // ════════════════════════════════════════════════════════════════════════════
    const THRESHOLDS = { REST: -1.0, PERFORM: 0.5, MIN_DAYS: 7, MAD_FLOOR: 3.0 };

    const calculateMedian = (arr) => {
      const s = [...arr].sort((a, b) => a - b);
      const m = Math.floor(s.length / 2);
      return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
    };

    const calculateMAD = (arr, median) => {
      const devs = arr.map(v => Math.abs(v - median)).sort((a, b) => a - b);
      return Math.max(calculateMedian(devs) * 1.4826, THRESHOLDS.MAD_FLOOR);
    };

    const getCommand = (z) => {
      if (z === null) return 'LEARNING';
      if (z < THRESHOLDS.REST) return 'REST';
      if (z >= THRESHOLDS.PERFORM) return 'PERFORM';
      return 'BUILD';
    };

    // ════════════════════════════════════════════════════════════════════════════
    // PATTERN ENGINE
    // ════════════════════════════════════════════════════════════════════════════
    const analyzePatterns = (hrvHistory, compliance = [], timezones = []) => {
      if (hrvHistory.length < 3) return null;

      const values = hrvHistory.map(h => h.value);
      const baseline = calculateMedian(values);
      const mad = calculateMAD(values, baseline);

      const withZ = hrvHistory.map(h => ({
        ...h,
        z: (h.value - baseline) / mad,
        command: getCommand((h.value - baseline) / mad)
      })).sort((a, b) => new Date(a.date) - new Date(b.date));

      const p = {
        baseline, mad,
        totalDays: hrvHistory.length,
        restDays: withZ.filter(h => h.command === 'REST').length,
        buildDays: withZ.filter(h => h.command === 'BUILD').length,
        performDays: withZ.filter(h => h.command === 'PERFORM').length,
        trend: 'stable',
        consecutiveBelow: 0,
        consecutiveAbove: 0,
        crashesAfterSkip: [],
        risesAfterRest: [],
        recoveriesAfterRest: [],
        nearestMatch: null,
        daysSincePerform: null,
        daysSinceRest: null,
        weekendSplit: null,
        weakDay: null,
        strongDay: null,
        todayDowPattern: null,
        isVolatile: false,
        travelDetected: false,
        lastTimezone: null,
        declineTrend: null,
        baselineShift: null
      };

      // Trend analysis (last 5 days)
      const recent = withZ.slice(-5);
      if (recent.length >= 3) {
        let up = 0, down = 0;
        for (let i = 1; i < recent.length; i++) {
          if (recent[i].z > recent[i-1].z) up++;
          else if (recent[i].z < recent[i-1].z) down++;
        }
        p.trend = up >= 3 ? 'rising' : down >= 3 ? 'falling' : 'stable';
      }

      // Declining trend detection (4+ consecutive days declining)
      if (recent.length >= 4) {
        let declining = true;
        for (let i = 1; i < recent.length && declining; i++) {
          if (recent[i].value >= recent[i-1].value) declining = false;
        }
        if (declining) {
          p.declineTrend = {
            days: recent.length,
            values: recent.map(r => r.value),
            drop: recent[0].value - recent[recent.length - 1].value
          };
        }
      }

      // Consecutive tracking
      const rev = [...withZ].reverse();
      for (const h of rev) { if (h.z < 0) p.consecutiveBelow++; else break; }
      for (const h of rev) { if (h.z > 0) p.consecutiveAbove++; else break; }

      // Days since PERFORM/REST
      const performs = withZ.filter(h => h.command === 'PERFORM');
      const rests = withZ.filter(h => h.command === 'REST');
      if (performs.length) p.daysSincePerform = daysBetween(performs[performs.length - 1].date, getTodayLocal());
      if (rests.length) p.daysSinceRest = daysBetween(rests[rests.length - 1].date, getTodayLocal());

      // Compliance outcomes
      compliance.forEach(c => {
        const nextDate = new Date(c.date);
        nextDate.setDate(nextDate.getDate() + 1);
        const nextDay = withZ.find(h => h.date === getLocalDateString(nextDate));
        if (!nextDay) return;

        if (c.command === 'REST' && c.followed === 'no' && nextDay.z < THRESHOLDS.REST) {
          p.crashesAfterSkip.push({ skippedDate: c.date, crashDate: nextDay.date });
        }
        if (c.command === 'REST' && c.followed === 'yes' && nextDay.z >= -0.5) {
          p.risesAfterRest.push({ restDate: c.date, riseDate: nextDay.date });
          p.recoveriesAfterRest.push({ restDate: c.date, readyDate: nextDay.date });
        }
      });

      // Volatility
      const zStd = Math.sqrt(withZ.reduce((s, h) => s + h.z * h.z, 0) / withZ.length);
      p.isVolatile = zStd > 1.5;

      // Day-of-week patterns
      const dowStats = {};
      withZ.forEach(h => {
        const dow = new Date(h.date + 'T12:00:00').getDay();
        if (!dowStats[dow]) dowStats[dow] = { sum: 0, count: 0 };
        dowStats[dow].sum += h.z;
        dowStats[dow].count++;
      });

      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      let worst = { day: null, avg: Infinity }, best = { day: null, avg: -Infinity };
      Object.entries(dowStats).forEach(([dow, s]) => {
        if (s.count >= 2) {
          const avg = s.sum / s.count;
          if (avg < worst.avg) worst = { day: dayNames[dow], avg };
          if (avg > best.avg) best = { day: dayNames[dow], avg };
        }
      });
      if (worst.avg < -0.3) p.weakDay = worst;
      if (best.avg > 0.3) p.strongDay = best;
      p.dowStats = dowStats;

      // Today's day-of-week tendency
      const todayDow = new Date().getDay();
      if (dowStats[todayDow]?.count >= 2) {
        const avg = dowStats[todayDow].sum / dowStats[todayDow].count;
        if (Math.abs(avg) > 0.3) {
          p.todayDowPattern = { day: dayNames[todayDow], tendency: avg < 0 ? 'low' : 'high', avg };
        }
      }

      // Weekend split
      const weekdayVals = withZ.filter(h => { const d = new Date(h.date + 'T12:00:00').getDay(); return d >= 1 && d <= 5; }).map(h => h.value);
      const weekendVals = withZ.filter(h => { const d = new Date(h.date + 'T12:00:00').getDay(); return d === 0 || d === 6; }).map(h => h.value);
      if (weekdayVals.length >= 5 && weekendVals.length >= 2) {
        const wdMean = weekdayVals.reduce((a, b) => a + b, 0) / weekdayVals.length;
        const weMean = weekendVals.reduce((a, b) => a + b, 0) / weekendVals.length;
        if (Math.abs(weMean - wdMean) >= 5) {
          p.weekendSplit = { weekdayMean: Math.round(wdMean), weekendMean: Math.round(weMean), spread: Math.round(weMean - wdMean) };
        }
      }

      // Travel detection (day-to-day timezone change only)
      // Only triggers on the actual day of timezone change, not throughout a trip
      if (withZ.length >= 2) {
        const todayDate = withZ[withZ.length - 1].date;
        const yesterdayDate = withZ[withZ.length - 2].date;
        
        // Find timezone for today and yesterday
        const todayTz = timezones.find(t => t === todayDate || t.date === todayDate);
        const yesterdayTz = timezones.find(t => t === yesterdayDate || t.date === yesterdayDate);
        
        // Normalize timezone strings for comparison
        const normalizeTz = (tz) => {
          if (!tz) return null;
          const tzStr = typeof tz === 'string' ? tz : tz.timezone || tz;
          const offsetMatch = String(tzStr).match(/UTC([+-]\d{2}:\d{2})/);
          return offsetMatch ? offsetMatch[1] : String(tzStr).trim();
        };
        
        const todayNorm = normalizeTz(todayTz);
        const yesterdayNorm = normalizeTz(yesterdayTz);
        
        if (todayNorm && yesterdayNorm && todayNorm !== yesterdayNorm) {
          p.travelDetected = true;
          p.lastTimezone = todayNorm;
          console.log(`[Travel] Timezone changed: ${yesterdayNorm} → ${todayNorm}`);
        }
      }

      // Nearest historical match
      const today = hrvHistory.find(h => h.date === getTodayLocal());
      if (today) {
        const todayZ = (today.value - baseline) / mad;
        let nearest = null, nearestDiff = 0.6;
        withZ.forEach(h => {
          if (h.date === getTodayLocal()) return;
          const diff = Math.abs(h.z - todayZ);
          if (diff < nearestDiff) {
            nearestDiff = diff;
            const nextDate = new Date(h.date);
            nextDate.setDate(nextDate.getDate() + 1);
            const nextDay = withZ.find(x => x.date === getLocalDateString(nextDate));
            const comp = compliance.find(c => c.date === h.date);
            nearest = {
              date: h.date,
              command: h.command,
              pushed: comp?.followed === 'no',
              rested: comp?.followed === 'yes',
              nextCrashed: nextDay ? nextDay.z < THRESHOLDS.REST : null,
              nextRose: nextDay ? nextDay.z >= 0 : null
            };
          }
        });
        p.nearestMatch = nearest;
      }

      // Baseline shift (month-over-month comparison for Day 60 milestone)
      if (hrvHistory.length >= 55) {
        const month1 = hrvHistory.slice(0, 30).map(h => h.value);
        const month2 = hrvHistory.slice(30, 60).map(h => h.value);
        if (month1.length >= 25 && month2.length >= 25) {
          const month1Median = calculateMedian(month1);
          const month2Median = calculateMedian(month2);
          const shift = month2Median - month1Median;
          const shiftPercent = Math.round((shift / month1Median) * 100);
          if (Math.abs(shiftPercent) >= 5) {
            p.baselineShift = { from: Math.round(month1Median), to: Math.round(month2Median), percent: shiftPercent };
          }
        }
      }

      return p;
    };

    // ════════════════════════════════════════════════════════════════════════════
    // CONFIDENCE & MODE
    // ════════════════════════════════════════════════════════════════════════════
    const getConfidence = (hrvHistory, patterns) => {
      if (!patterns || hrvHistory.length < 14) return { level: 'low', score: 30 };

      let signal = 15, quality = 10, support = 5;
      const today = hrvHistory.find(h => h.date === getTodayLocal());

      if (today) {
        const robustZ = Math.abs((today.value - patterns.baseline) / patterns.mad);
        signal = robustZ < 0.7 ? 15 : robustZ < 1.5 ? 30 : 45;
      }

      if (hrvHistory.length >= 30) quality = 25;
      else if (hrvHistory.length >= 21) quality = 20;
      else if (hrvHistory.length >= 14) quality = 15;

      if (patterns.nearestMatch) {
        const today = hrvHistory.find(h => h.date === getTodayLocal());
        if (today) {
          const todayZ = (today.value - patterns.baseline) / patterns.mad;
          const similar = hrvHistory.filter(h => {
            if (h.date === getTodayLocal()) return false;
            const z = (h.value - patterns.baseline) / patterns.mad;
            return Math.abs(z - todayZ) < 0.8 && getCommand(z) === getCommand(todayZ);
          });
          support = similar.length >= 4 ? 20 : similar.length >= 2 ? 12 : 5;
        }
      }

      const total = signal + quality + support;
      let level = total >= 75 ? 'high' : total >= 50 ? 'medium' : 'low';
      if (patterns.isVolatile && level === 'high') level = 'medium';
      if (patterns.travelDetected) level = 'low';

      return { level, score: total };
    };

    const getMode = (confidence, compliance, daysOnApp) => {
      if (confidence.level === 'low' || daysOnApp < 14) return 'UNCERTAIN';

      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      const recentSkips = compliance.filter(c => new Date(c.date) >= weekAgo && c.followed === 'no').length;
      const yesterdayLog = compliance.find(c => c.date === getYesterdayLocal());
      const skippedYesterdayRest = yesterdayLog?.command === 'REST' && yesterdayLog?.followed === 'no';

      if (recentSkips >= 2 || skippedYesterdayRest) return 'PROTECTIVE';
      return 'DIRECTIVE';
    };

    // ════════════════════════════════════════════════════════════════════════════
    // CONTEXT BUILDER
    // ════════════════════════════════════════════════════════════════════════════
    const getContext = (command, patterns, compliance, hrvHistory, daysOnApp) => {
      const confidence = getConfidence(hrvHistory, patterns);
      const mode = getMode(confidence, compliance, daysOnApp);

      const ctx = {
        mode, confidence,
        type: 'default',
        isWarning: false,
        isAfterRest: false,
        isConsecutive: false,
        isTravel: patterns?.travelDetected || false,
        isMomentum: false,
        isEarned: false,
        isPeak: false,
        consecutiveRestDays: 0
      };

      // Count consecutive REST days
      if (command === 'REST' && patterns) {
        const sorted = [...hrvHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
        for (const h of sorted) {
          const z = (h.value - patterns.baseline) / patterns.mad;
          if (getCommand(z) === 'REST') ctx.consecutiveRestDays++;
          else break;
        }
      }

      // REST context
      if (command === 'REST') {
        if (ctx.isTravel) ctx.type = 'travel';
        else if (ctx.consecutiveRestDays >= 2) ctx.type = 'day2plus';
        else if (patterns?.trend === 'falling' || confidence.level === 'low') { ctx.isWarning = true; ctx.type = 'warning'; }
      }

      // BUILD context
      if (command === 'BUILD') {
        const yLog = compliance.find(c => c.date === getYesterdayLocal());
        if (yLog?.command === 'REST' && yLog?.followed === 'yes') { ctx.isAfterRest = true; ctx.type = 'after_rest'; }
        else if (patterns?.trend === 'rising' && patterns?.consecutiveAbove >= 3) { ctx.isMomentum = true; ctx.type = 'momentum'; }
        else if (patterns?.trend === 'falling' || confidence.level === 'low') { ctx.isWarning = true; ctx.type = 'warning'; }
      }

      // PERFORM context
      if (command === 'PERFORM') {
        const yLog = compliance.find(c => c.date === getYesterdayLocal());
        if (yLog?.command === 'PERFORM') { ctx.isConsecutive = true; ctx.type = 'consecutive'; }
        else if (patterns?.crashesAfterSkip?.length >= 2) { ctx.isWarning = true; ctx.type = 'warning'; }
        else {
          // Check if earned (REST followed in last 48h)
          const twoDaysAgo = new Date(); twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
          const recentRestFollowed = compliance.filter(c => 
            new Date(c.date) >= twoDaysAgo && c.command === 'REST' && c.followed === 'yes'
          ).length > 0;
          if (recentRestFollowed) { ctx.isEarned = true; ctx.type = 'earned'; }
        }
      }

      return ctx;
    };

    // ════════════════════════════════════════════════════════════════════════════
    // OBSERVATION GENERATOR (Full library from Communication System)
    // ════════════════════════════════════════════════════════════════════════════
    const generateObservation = (command, patterns, daysOnApp, hrvHistory, compliance, lastObsType) => {
      const seed = new Date().getFullYear() * 10000 + (new Date().getMonth() + 1) * 100 + new Date().getDate();
      const pick = (arr, exclude) => {
        const filtered = exclude ? arr.filter(o => o.type !== exclude) : arr;
        return filtered.length ? filtered[seed % filtered.length] : arr[0];
      };

      if (!patterns) {
        const remaining = Math.max(0, 3 - hrvHistory.length);
        if (remaining > 0) return { text: `${remaining} day${remaining > 1 ? 's' : ''} until commands unlock.`, type: 'learning' };
        return { text: "Your baseline is forming.", type: 'learning' };
      }

      const ctx = getContext(command, patterns, compliance, hrvHistory, daysOnApp);
      const { mode, confidence } = ctx;
      const crashCount = patterns.crashesAfterSkip?.length || 0;
      const canPersonalize = daysOnApp >= 14 && confidence.level !== 'low';
      const canDateAnchor = canPersonalize && confidence.level === 'high';

      // Compliance streak
      const getStreak = () => {
        let streak = 0;
        const sorted = [...compliance].sort((a, b) => new Date(b.date) - new Date(a.date));
        for (const c of sorted) { if (c.followed === 'yes') streak++; else break; }
        return streak;
      };
      const streak = getStreak();

      // ═══ MILESTONES ═══
      const milestones = {
        7: "A week. Now we build.",
        14: "Two weeks. I know your patterns.",
        21: "Three weeks. The rhythm is clear.",
        30: "One month. Most people quit by now. You didn't.",
        60: "Two months. Your data tells a real story now.",
        90: "Three months. The patterns are undeniable.",
        180: "Six months. You've outlasted 95% of trackers.",
        365: "One year. The full translation."
      };
      if (milestones[daysOnApp]) return { text: milestones[daysOnApp], type: `milestone_${daysOnApp}` };

      // ═══ STREAK CALLOUTS ═══
      if (canPersonalize && streak >= 10 && seed % 7 === 0) {
        return { text: `${streak} days listening. That's rare. That's real.`, type: 'streak' };
      }

      // ═══ REST OBSERVATIONS ═══
      if (command === 'REST') {
        // Date anchor warning
        if (canDateAnchor && patterns.nearestMatch?.nextCrashed) {
          const anchor = formatDateAnchor(patterns.nearestMatch.date);
          if (anchor) return { text: `This looks like ${anchor}. That day cost you.`, type: 'rest_anchor' };
        }

        // Proof with small numbers
        if (canPersonalize && crashCount >= 2) {
          return { text: `${crashCount} times you've pushed through REST. ${crashCount} times you paid.`, type: 'rest_proof' };
        }

        // Travel
        if (ctx.isTravel) return pick([
          { text: "Timezone shift detected. The body is recalibrating.", type: 'rest_travel' },
          { text: "Travel throws off the signal. Give it 48 hours.", type: 'rest_travel' }
        ], lastObsType);

        // Day 2+
        if (ctx.consecutiveRestDays >= 2) return pick([
          { text: `Day ${ctx.consecutiveRestDays}. The adaptation is deepening.`, type: 'rest_day2' },
          { text: "Still building. The foundation is almost set.", type: 'rest_day2' },
          { text: "Impatience is the enemy today. Stay the course.", type: 'rest_day2' }
        ], lastObsType);

        // Mode-based
        if (mode === 'DIRECTIVE') return pick([
          { text: "The work is done. Now the building happens.", type: 'rest_directive' },
          { text: "You stressed the system. Now it adapts.", type: 'rest_directive' },
          { text: "The stimulus is in. The body is responding.", type: 'rest_directive' },
          { text: "Not a setback. A setup.", type: 'rest_directive' },
          { text: "This isn't stopping. This is building.", type: 'rest_directive' },
          { text: "You're not sitting out. You're loading the spring.", type: 'rest_directive' }
        ], lastObsType);

        if (mode === 'PROTECTIVE') return pick([
          { text: "You feel fine. The trend says otherwise.", type: 'rest_protective' },
          { text: "The body doesn't send alerts. It just keeps sliding until it hands you the bill.", type: 'rest_protective' },
          { text: "The itch is loud. The signal says wait.", type: 'rest_protective' },
          { text: "I know you feel fine. The numbers don't agree.", type: 'rest_protective' },
          { text: "This is where you usually push. Don't.", type: 'rest_protective' }
        ], lastObsType);

        return pick([
          { text: "Signal is unclear. Default to less.", type: 'rest_uncertain' },
          { text: "When in doubt, do less.", type: 'rest_uncertain' },
          { text: "Tomorrow will be clearer.", type: 'rest_uncertain' }
        ], lastObsType);
      }

      // ═══ BUILD OBSERVATIONS ═══
      if (command === 'BUILD') {
        // Rarity callout
        if (canPersonalize && patterns.daysSincePerform >= 10) {
          return { text: `${patterns.daysSincePerform} days since green. BUILD is building toward it.`, type: 'build_rarity' };
        }

        // After rest
        if (ctx.isAfterRest) return pick([
          { text: "You rested. This is the return.", type: 'build_afterrest' },
          { text: "Yesterday's patience. Today's capacity.", type: 'build_afterrest' },
          { text: "That rest is showing up. Use it, don't spend it.", type: 'build_afterrest' }
        ], lastObsType);

        // Momentum
        if (ctx.isMomentum) return pick([
          { text: "Something's working. Don't change anything.", type: 'build_momentum' },
          { text: "Three days climbing. Today could be four.", type: 'build_momentum' },
          { text: "The trend is your friend right now.", type: 'build_momentum' }
        ], lastObsType);

        // Mode-based
        if (mode === 'DIRECTIVE') return pick([
          { text: "Room to work. Not room to be reckless.", type: 'build_directive' },
          { text: "Middle of your range. Solid work is available.", type: 'build_directive' },
          { text: "Enough for quality. Not enough for ego.", type: 'build_directive' },
          { text: "Not your best. Not your worst. Just work.", type: 'build_directive' },
          { text: "Some days are for PRs. Today is for reps.", type: 'build_directive' },
          { text: "Not every day is a story. Some are just sentences.", type: 'build_directive' }
        ], lastObsType);

        if (mode === 'PROTECTIVE') return pick([
          { text: "Still in range, but the direction matters.", type: 'build_protective' },
          { text: "The runway is getting shorter. Land smoothly.", type: 'build_protective' },
          { text: "Solid work available. Not a day to dig deep.", type: 'build_protective' },
          { text: "I almost gave you REST. Respect that.", type: 'build_protective' }
        ], lastObsType);

        return pick([
          { text: "Do what you planned. Nothing more, nothing less.", type: 'build_uncertain' },
          { text: "Uncertain signal means conservative play.", type: 'build_uncertain' }
        ], lastObsType);
      }

      // ═══ PERFORM OBSERVATIONS ═══
      if (command === 'PERFORM') {
        // Consecutive
        if (ctx.isConsecutive) return pick([
          { text: "Second straight day. Rare. Stay disciplined.", type: 'perform_consecutive' },
          { text: "Still green. But every PERFORM borrows from the future.", type: 'perform_consecutive' },
          { text: "Back-to-back green is rare. Today's skill is restraint.", type: 'perform_consecutive' }
        ], lastObsType);

        // Rarity callout
        if (canPersonalize && patterns.daysSincePerform >= 7) {
          return { text: `First green in ${patterns.daysSincePerform} days. The drought is over.`, type: 'perform_rarity' };
        }

        // Earned
        if (ctx.isEarned) return pick([
          { text: "You rested. This is the payoff.", type: 'perform_earned' },
          { text: "Two days of patience. Here's the payoff.", type: 'perform_earned' },
          { text: "This is what trust buys.", type: 'perform_earned' }
        ], lastObsType);

        // Date anchor warning
        if (canDateAnchor && patterns.nearestMatch?.pushed && patterns.nearestMatch?.nextCrashed) {
          const anchor = formatDateAnchor(patterns.nearestMatch.date);
          if (anchor) return { text: `You were here on ${anchor}. One peak—then leave.`, type: 'perform_anchor' };
        }

        // Mode-based
        if (mode === 'DIRECTIVE') return pick([
          { text: "The tank is full. This is what you've been building toward.", type: 'perform_directive' },
          { text: "Green light. No caveats.", type: 'perform_directive' },
          { text: "Capacity is peaking. Use it. You can't save it.", type: 'perform_directive' },
          { text: "All systems go. One effort.", type: 'perform_directive' }
        ], lastObsType);

        if (mode === 'PROTECTIVE') return pick([
          { text: "Green light. But the road still has turns.", type: 'perform_protective' },
          { text: "Capacity is high. Doesn't mean infinite.", type: 'perform_protective' },
          { text: "Yes means yes. It doesn't mean reckless.", type: 'perform_protective' }
        ], lastObsType);

        return pick([
          { text: "Green, but signal is noisy. Keep it controlled.", type: 'perform_uncertain' },
          { text: "The signal says yes. Stay controlled anyway.", type: 'perform_uncertain' }
        ], lastObsType);
      }

      return { text: "Baseline forming.", type: 'learning' };
    };

    // ════════════════════════════════════════════════════════════════════════════
    // ACTION GENERATOR (Full Glassman prescriptions)
    // ════════════════════════════════════════════════════════════════════════════
    const generateActions = (command, patterns, hrvHistory, compliance, daysOnApp) => {
      if (!patterns || hrvHistory.length < 7) return null;

      const ctx = getContext(command, patterns, compliance, hrvHistory, daysOnApp);
      const seed = new Date().getFullYear() * 10000 + (new Date().getMonth() + 1) * 100 + new Date().getDate();
      const pick = (arr) => arr[seed % arr.length];

      // ═══ REST ACTIONS ═══
      if (command === 'REST') {
        if (ctx.isTravel) return {
          primary: "Walk in sunlight for 20-30 minutes. That's your only job today.",
          effort: "Walking pace. Tourist pace. Minimal effort—barely working.",
          recovery: "Hydrate aggressively. Sleep when tired, even if it's the 'wrong' time. No caffeine after 2pm local.",
          guardrail: "Don't shake off jet lag with a workout. The bill comes in 48 hours."
        };

        if (ctx.consecutiveRestDays >= 2) return {
          primary: "Same as yesterday. 20-30 minutes easy movement, or nothing at all. The adaptation is deepening.",
          effort: "Nose-breath only. If it feels like exercise, it's too much.",
          recovery: "Another good night. The foundation is almost set.",
          guardrail: "Impatience is the enemy today. Stay the course."
        };

        if (ctx.isWarning) return {
          primary: "10-20 minute walk. 10 minutes stretching. That's the whole day.",
          effort: "Conversation pace. If you can't speak in full sentences, slow down.",
          recovery: "In bed 30-60 minutes earlier than usual tonight. This is the lever.",
          guardrail: "Restlessness is a feeling, not a command."
        };

        return {
          primary: "20-30 minutes easy movement. Walk, stretch, foam roll. Stop while it still feels easy.",
          effort: "Nose-breath only. If you need your mouth, slow down.",
          recovery: "Water before coffee. Protein at every meal. Protect an 8-hour sleep window.",
          guardrail: "No 'just a quick one.' That's how rest days become debt."
        };
      }

      // ═══ BUILD ACTIONS ═══
      if (command === 'BUILD') {
        if (ctx.isWarning) return {
          primary: "Same workout. Pull one lever back 20%: lighter load, fewer reps, or shorter time cap. Pick one.",
          effort: "Moderate effort. When form breaks, rack it. If it turns into survival, stop.",
          recovery: "In bed 30 minutes earlier than usual. Protein within 60 minutes.",
          guardrail: "A shortened session is a win. A crash is a week lost."
        };

        if (ctx.isAfterRest) return {
          primary: "Full programmed work. Finish feeling like you could do a little more—but don't.",
          effort: "Hard but controlled. Leave 20% in the tank. That's fuel for the streak.",
          recovery: "Don't undo yesterday's investment. Another good night tonight.",
          guardrail: "Feeling good doesn't mean 'go all out.' It means 'execute cleanly.'"
        };

        if (ctx.isMomentum) return {
          primary: "Keep doing what you're doing. Don't change anything. Don't add anything.",
          effort: "Hard but controlled. Same effort as yesterday. Don't escalate just because you can.",
          recovery: "Whatever you did yesterday, do it again. Consistency over intensity right now.",
          guardrail: "Don't celebrate momentum by killing it. The trend is your friend—protect it."
        };

        return {
          primary: "Programmed work only. Skip the finisher. Leave 10 minutes before you normally would.",
          effort: "Hard but controlled. Finish feeling like you could do a little more. When form breaks, rack it.",
          recovery: "Protein within 2 hours of training. Protect 7-8 hours sleep.",
          guardrail: "Don't turn a BUILD day into a PERFORM day. They have different purposes."
        };
      }

      // ═══ PERFORM ACTIONS ═══
      if (command === 'PERFORM') {
        if (ctx.isConsecutive) return {
          primary: "Shorter session than yesterday. 75% of the duration. 85% of the intensity.",
          effort: "Very hard, but lower than yesterday. If anything feels off in warm-up, convert to BUILD.",
          recovery: "Tonight is critical. 8+ hours. Extra protein. This is probably the last green for a while.",
          guardrail: "Three consecutive PERFORMs almost never end well. Stop while you're ahead."
        };

        if (ctx.isWarning) return {
          primary: "One hard effort in the first 15 minutes. Then coast. No encores.",
          effort: "Push hard once. Then immediately ease off. Set a time limit: ~45 minutes including warm-up.",
          recovery: "Double down on recovery tonight. What you do in the next 12 hours matters more than what you did in the gym.",
          guardrail: "This pattern has cost days before. Keep today clean so tomorrow stays alive."
        };

        if (ctx.isEarned) return {
          primary: "You rested. This is the return. Put your hardest work in the first 20 minutes.",
          effort: "Near-max effort available. Leave a rep in reserve. Full effort—you've earned the capacity.",
          recovery: "This is the payoff. Protect the next one. Refuel within 60 minutes. 8+ hours sleep.",
          guardrail: "Earned doesn't mean unlimited. One peak. Then protect the investment."
        };

        return {
          primary: "Your hard effort goes in the first 20 minutes. Heavy lift, benchmark, key interval—whatever it is, do it first. Then coast.",
          effort: "Near-max for one effort. Leave a rep in reserve. Then ease off. No second peaks.",
          recovery: "Refuel within 60 minutes: protein + carbs. Protect an 8-hour sleep window. This is where gains lock in.",
          guardrail: "Don't turn a great day into a two-day hangover. One peak. Then done."
        };
      }

      return null;
    };

    // ════════════════════════════════════════════════════════════════════════════
    // IMPOSSIBLE INSIGHTS (Milestones)
    // ════════════════════════════════════════════════════════════════════════════
    const getInsight = (daysOnApp, patterns, compliance, hrvHistory, currentCommand) => {
      // Day 2: The Difference (no data required - philosophy message)
      if (daysOnApp === 2) {
        return {
          label: 'WHY THIS IS DIFFERENT',
          isMilestone: false,
          lines: [
            'Every device tells you how you slept.',
            'How you recovered. Your readiness score.',
            '',
            '**None of them tell you what to do.**',
            '',
            'GENYSYS does. One signal. Every morning.',
            "And it's right.",
            '',
            "Your body's been sending signals your whole life.",
            'GENYSYS is the first thing that actually **translates** them.',
            '',
            'When it says **perform** — perform.',
            'When it says **rest** — rest.',
            '',
            'We tested this. When you **listen**, you win.',
            "When you don't, you **pay for it**.",
            'Not with some abstract number. With **days**.',
            'Days you could have trained.',
            'Days you lost to injury.',
            '',
            "**You're no longer guessing.**"
          ]
        };
      }

      if (!patterns) return null;

      // Day 7: Weekend Split - MILESTONE
      if (daysOnApp === 7 && patterns.weekendSplit) {
        const spread = Math.abs(patterns.weekendSplit.spread);
        if (spread < 2) return null; // Not meaningful enough to show
        
        return {
          label: 'ONE WEEK MILESTONE',
          isMilestone: true,
          lines: [
            `Monday through Friday: **${patterns.weekendSplit.weekdayMean}**.`,
            `Saturday and Sunday: **${patterns.weekendSplit.weekendMean}**.`,
            '',
            'You are **not the same person** on weekends.',
            '',
            "You've never noticed this.",
            'How could you?',
            "You can't feel a weekly average.",
            '',
            "But it's been true your whole life.",
            '**Now you know.**'
          ]
        };
      }

      // Day 10-12: Declining Trend Truth (context-independent)
      if (daysOnApp >= 10 && daysOnApp <= 12 && patterns.declineTrend) {
        const { values } = patterns.declineTrend;
        return {
          label: "WHAT YOU CAN'T FEEL",
          isMilestone: false,
          lines: [
            ...values.map((v, i) => `Day ${daysOnApp - values.length + i + 1}: **${v}**`),
            '',
            'You felt fine on each of those days.',
            '',
            "The body doesn't argue.",
            "It doesn't complain.",
            'It just **keeps score**.',
            '',
            'And then one morning it **hands you the bill**.'
          ]
        };
      }

      // Day 14: Day-of-week pattern - MILESTONE
      if (daysOnApp === 14 && (patterns.weakDay || patterns.strongDay)) {
        const lines = [];
        if (patterns.weakDay && patterns.strongDay) {
          lines.push(`Your lowest days: **${patterns.weakDay.day}s**.`);
          lines.push(`Your highest days: **${patterns.strongDay.day}s**.`);
        } else if (patterns.weakDay) {
          lines.push(`Your **${patterns.weakDay.day}s** consistently drag.`);
        } else {
          lines.push(`Your **${patterns.strongDay.day}s** consistently peak.`);
        }
        lines.push('', '**This is not random.**', 'This is your weekly rhythm.');
        return { 
          label: 'TWO WEEK MILESTONE', 
          isMilestone: true, 
          lines,
          visualization: 'heatmap',
          patterns
        };
      }

      // Day 21-25: First crash lesson - ONLY ON REST DAYS, requires crash data - MILESTONE
      if (daysOnApp >= 21 && daysOnApp <= 25 && currentCommand === 'REST' && patterns.crashesAfterSkip?.length >= 1) {
        return {
          label: 'THREE WEEK MILESTONE',
          isMilestone: true,
          lines: [
            'The **crash** did not happen today.',
            'It happened **three days ago**.',
            '',
            'Today is when your body',
            '**stopped hiding it** from you.',
            '',
            'The cause is always days before the symptom.',
            '',
            "Now you've **seen it once**.",
            "You'll recognize the setup next time."
          ]
        };
      }

      // Day 30: The Mirror - MILESTONE - with data validation
      if (daysOnApp === 30) {
        const restCommands = compliance.filter(c => c.command === 'REST');
        const restIssued = restCommands.length;
        const restFollowed = restCommands.filter(c => c.followed === 'yes').length;
        const restSkipped = restCommands.filter(c => c.followed === 'no').length;
        
        // Only show crash correlation if we have actual data
        const crashesAfterSkip = patterns.crashesAfterSkip?.length || 0;
        const risesAfterRest = patterns.risesAfterRest?.length || 0;
        
        const lines = [
          `REST commands issued: **${restIssued}**`,
          `Times you **listened**: ${restFollowed}`,
          `Times you **pushed through**: ${restSkipped}`,
          ''
        ];
        
        // Only add correlation claims if we have enough data to back them up
        if (restSkipped > 0 && crashesAfterSkip > 0) {
          const skipCrashRate = Math.round((crashesAfterSkip / restSkipped) * 100);
          if (skipCrashRate >= 30) {
            lines.push(`When REST was **skipped**: ${skipCrashRate}% led to crashes.`);
          }
        }
        
        if (restFollowed > 0 && risesAfterRest > 0) {
          const followRiseRate = Math.round((risesAfterRest / restFollowed) * 100);
          if (followRiseRate >= 30) {
            lines.push(`When REST was **followed**: ${followRiseRate}% led to climbs.`);
          }
        }
        
        if (lines.length > 4) {
          lines.push('', '**The pattern is already clear.**');
        } else {
          lines.push('The patterns are still forming.', '', 'Keep listening. The proof builds.');
        }

        return { label: 'ONE MONTH MILESTONE', isMilestone: true, lines };
      }

      // Day 45-50: THE TWIN DAYS - Visual comparison
      if (daysOnApp >= 45 && daysOnApp <= 50) {
        // Try to find twin days for the powerful visualization
        const twinData = findTwinDays(hrvHistory, compliance, patterns);
        
        if (twinData) {
          const formatDateShort = (d) => {
            const date = new Date(d + 'T12:00:00');
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
          };
          
          return {
            label: 'THE TWIN DAYS',
            isMilestone: true,
            lines: [
              `${formatDateShort(twinData.followed.date)} and ${formatDateShort(twinData.skipped.date)}.`,
              '',
              'Same HRV. Same command. Same crossroads.',
              '',
              'One decision. Two different weeks.',
              '',
              '**The signal was the same. The choice wasn\\'t.**'
            ],
            visualization: 'twins',
            twinData
          };
        }
        
        // Fallback to original if no twin days found
        if (currentCommand === 'REST' && patterns.recoveriesAfterRest?.length >= 2 && patterns.crashesAfterSkip?.length >= 1) {
          const recovery = patterns.recoveriesAfterRest[patterns.recoveriesAfterRest.length - 1];
          const crash = patterns.crashesAfterSkip[0];
          
          return {
            label: 'SAME PATTERN. DIFFERENT ENDING.',
            isMilestone: false,
            lines: [
              `**${crash.skippedDate}**: REST ignored.`,
              `**${crash.crashDate}**: Crashed.`,
              '',
              `**${recovery.restDate}**: REST followed.`,
              `**${recovery.readyDate}**: Ready to train.`,
              '',
              'Same setup.',
              'Different choice.',
              'Different outcome.',
              '',
              '**This is what control looks like.**'
            ]
          };
        }
      }

      // Day 60: Capacity truth - MILESTONE
      if (daysOnApp === 60 && patterns.baselineShift) {
        const { from, to, percent } = patterns.baselineShift;
        
        return {
          label: 'TWO MONTH MILESTONE',
          isMilestone: true,
          lines: [
            `Month one baseline: **${from} ms**.`,
            `Month two baseline: **${to} ms**.`,
            '',
            percent > 0 ? `**${Math.abs(percent)}% more capacity**` : `**${Math.abs(percent)}% less capacity**`,
            'than 2 months ago.',
            '',
            percent > 0 ? 'Not from training more.' : 'Something changed.',
            percent > 0 ? '**From resting better.**' : 'Worth investigating.',
            '',
            'The capacity was never gone.',
            'It was **buried under fatigue**',
            "you didn't know you were carrying."
          ]
        };
      }

      // Day 90: The Switch - MILESTONE - with data validation
      if (daysOnApp === 90) {
        const restSkipped = compliance.filter(c => c.command === 'REST' && c.followed === 'no').length;
        const restFollowed = compliance.filter(c => c.command === 'REST' && c.followed === 'yes').length;
        
        // Need at least 3 in each category to show meaningful stats
        if (restSkipped < 3 || restFollowed < 3) {
          return {
            label: 'NINETY DAY MILESTONE',
            isMilestone: true,
            lines: [
              "You've been **listening**.",
              '',
              'Not enough REST days were skipped',
              'to show you the cost.',
              '',
              "That's not a missing data point.",
              "**That's the whole point.**",
              '',
              'The goal was never to prove the crash.',
              'The goal was to **avoid it**.',
              '',
              'You did.'
            ]
          };
        }
        
        const crashRate = Math.round((patterns.crashesAfterSkip?.length || 0) / restSkipped * 100);
        const riseRate = Math.round((patterns.risesAfterRest?.length || 0) / restFollowed * 100);

        return {
          label: 'NINETY DAY MILESTONE',
          isMilestone: true,
          lines: [
            `When REST is **followed**: ${riseRate}% climb rate.`,
            `When REST is **skipped**: ${crashRate}% crash rate.`,
            '',
            "That's not a correlation.",
            "**That's a switch.**",
            '',
            'The body has been running this experiment',
            'your whole life.',
            '',
            '**Rest → rise.**',
            '**Push through → fall.**',
            '',
            'You just never had a translator',
            'to show you the results.',
            '',
            '**Now you do.**'
          ]
        };
      }

      // Day 180: Still here - MILESTONE
      if (daysOnApp === 180) {
        return {
          label: 'SIX MONTH MILESTONE',
          isMilestone: true,
          lines: [
            'You have **outlasted** most people',
            'who start tracking recovery.',
            '',
            "Most quit because they couldn't **rest**",
            'when the number said rest.',
            '',
            'The story was too loud.',
            '"I feel fine."',
            '"Rest is weakness."',
            '',
            'You heard the same story.',
            '**But, now you are tuned into the signal.**'
          ]
        };
      }

      // Day 365: The Full Translation - MILESTONE
      if (daysOnApp === 365) {
        const lines = ['Here is what I learned about you:', ''];
        
        if (patterns.recoveriesAfterRest?.length > (patterns.crashesAfterSkip?.length || 0)) {
          lines.push('When you **rest**, you **rise**.');
        }
        if (patterns.weakDay) lines.push(`Your **${patterns.weakDay.day}s** need protecting.`);
        if (patterns.strongDay) lines.push(`Your **${patterns.strongDay.day}s** are your peak.`);
        if (patterns.weekendSplit?.spread > 5) lines.push('**Weekends restore you.**');
        lines.push('');
        lines.push('None of this was hidden.');
        lines.push('Your rhythm was all there, every day, for your **entire life**.');
        lines.push('');
        lines.push('You just needed someone to read it to you');
        lines.push('until you learned to **read it yourself**.');
        lines.push('');
        lines.push('**You can read it now.**');
        lines.push('');
        lines.push('The numbers were never the treasure.');
        lines.push('The treasure was **learning how to use it**.');

        return { label: 'ONE YEAR MILESTONE', isMilestone: true, lines };
      }

      return null;
    };

    // ════════════════════════════════════════════════════════════════════════════
    // RECEIPT (Yesterday's outcome)
    // ════════════════════════════════════════════════════════════════════════════
    const getReceipt = (hrvHistory, compliance, patterns) => {
      if (!patterns || hrvHistory.length < 2) return null;

      const yesterday = getYesterdayLocal();
      const yLog = compliance.find(c => c.date === yesterday);
      if (!yLog) return null;

      const todayEntry = hrvHistory.find(h => h.date === getTodayLocal());
      if (!todayEntry) return null;

      const todayZ = (todayEntry.value - patterns.baseline) / patterns.mad;

      // REST followed → vindication or not
      if (yLog.command === 'REST' && yLog.followed === 'yes') {
        if (todayZ >= -0.5) {
          return { type: 'vindication', text: "You rested. Today you're climbing." };
        }
      }

      // REST skipped → observation
      if (yLog.command === 'REST' && yLog.followed === 'no') {
        if (todayZ < THRESHOLDS.REST) {
          return { type: 'consequence', text: "REST was skipped. Here's what followed." };
        }
      }

      return null;
    };

    // ════════════════════════════════════════════════════════════════════════════
    // UI COMPONENTS
    // ════════════════════════════════════════════════════════════════════════════

    // Command Display
    const CommandDisplay = ({ command, isRevealed, onClick }) => {
      const colors = { REST: '#FDA4AF', BUILD: '#C9A962', PERFORM: '#6EE7B7', LEARNING: '#71717A' };
      
      return (
        <div className={`text-center cursor-pointer transition-all duration-500 ${isRevealed ? 'py-4' : 'py-16'}`} onClick={onClick}>
          <h1 
            className={`font-display animate-rise transition-all duration-500 ${isRevealed ? 'text-3xl' : 'text-5xl'}`}
            style={{ color: colors[command] || colors.LEARNING }}
          >
            {command}
          </h1>
          {!isRevealed && (
            <p className="text-sm mt-8 animate-fade" style={{ color: 'var(--text-faint)' }}>
              tap to open
            </p>
          )}
        </div>
      );
    };

    // Receipt
    const Receipt = ({ receipt }) => {
      if (!receipt) return null;
      const isGood = receipt.type === 'vindication';
      return (
        <div className="text-center mb-4 animate-rise" style={{ color: isGood ? 'var(--green)' : 'var(--rose)', opacity: 0.8 }}>
          <p className="text-sm">{receipt.text}</p>
        </div>
      );
    };

    // Day-of-week warning
    const DowWarning = ({ pattern }) => {
      if (!pattern) return null;
      return (
        <div className="text-center mb-4 animate-rise delay-100">
          <p className="text-xs" style={{ color: pattern.tendency === 'low' ? 'var(--rose)' : 'var(--green)', opacity: 0.7 }}>
            {pattern.tendency === 'low' 
              ? `Your ${pattern.day}s tend to run low`
              : `${pattern.day}s are usually your strong day`}
          </p>
        </div>
      );
    };

    // Observation
    const Observation = ({ text }) => (
      <div className="text-center px-6 animate-rise delay-100">
        <p className="text-base leading-relaxed" style={{ color: 'var(--text-secondary)', lineHeight: 1.9 }}>{text}</p>
      </div>
    );

    // Prescription
    const Prescription = ({ actions }) => {
      if (!actions) return null;
      return (
        <div className="px-6 animate-rise delay-200">
          <div className="divider" />
          <div className="space-y-5">
            <PrescriptionItem text={actions.primary} />
            <PrescriptionItem text={actions.effort} muted />
            <PrescriptionItem text={actions.recovery} muted />
          </div>
          <div className="divider" />
          <div className="flex items-start gap-3 animate-rise delay-300">
            <span style={{ color: 'var(--rose)', fontSize: '14px', marginTop: '2px' }}>⚠</span>
            <p className="text-sm leading-relaxed" style={{ color: 'var(--rose)', opacity: 0.85 }}>{actions.guardrail}</p>
          </div>
        </div>
      );
    };

    const PrescriptionItem = ({ text, muted }) => (
      <div className="flex items-start gap-3">
        <span className="mt-2.5 block w-1.5 h-1.5 rounded-full flex-shrink-0" style={{ backgroundColor: 'var(--gold)' }} />
        <p className="text-sm leading-relaxed" style={{ color: muted ? 'var(--text-muted)' : 'var(--text-secondary)' }}>{text}</p>
      </div>
    );

    // Render text with **bold** markers
    const renderBoldText = (text) => {
      if (!text) return null;
      const parts = text.split(/(\*\*[^*]+\*\*)/g);
      return parts.map((part, i) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={i} style={{ color: 'var(--text-primary)', fontWeight: 500 }}>{part.slice(2, -2)}</strong>;
        }
        return part;
      });
    };

    // ════════════════════════════════════════════════════════════════════════════
    // WEEK HEATMAP - Day 14 Visualization
    // ════════════════════════════════════════════════════════════════════════════
    const WeekHeatmap = ({ patterns }) => {
      const [animate, setAnimate] = useState(false);
      
      useEffect(() => {
        const timer = setTimeout(() => setAnimate(true), 100);
        return () => clearTimeout(timer);
      }, []);
      
      if (!patterns?.dowStats) return null;
      
      const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      const fullDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      
      const getOpacity = (dow) => {
        if (!animate) return 0.1;
        const stats = patterns.dowStats?.[dow];
        if (!stats || !stats.count) return 0.2;
        const avg = stats.sum / stats.count;
        // Normalize: negative z-scores = lower opacity, positive = higher
        return Math.max(0.2, Math.min(1.0, 0.5 + avg * 0.25));
      };
      
      const isWeak = (dow) => patterns.weakDay && fullDays[dow] === patterns.weakDay.day;
      const isStrong = (dow) => patterns.strongDay && fullDays[dow] === patterns.strongDay.day;
      
      const getColor = (dow) => {
        if (isWeak(dow)) return 'var(--rose)';
        if (isStrong(dow)) return 'var(--green)';
        return 'var(--gold)';
      };
      
      return (
        <div className="mt-6 mb-4">
          <div className="flex justify-center gap-2 mb-4">
            {days.map((day, i) => (
              <div 
                key={i}
                className="flex flex-col items-center gap-2"
                style={{
                  transition: 'all 500ms ease-out',
                  transitionDelay: `${i * 80}ms`
                }}
              >
                <div 
                  className="w-9 h-9 rounded-lg"
                  style={{
                    background: getColor(i),
                    opacity: getOpacity(i),
                    transition: 'opacity 600ms ease-out',
                    transitionDelay: `${i * 80}ms`
                  }}
                />
                <span 
                  className="text-xs"
                  style={{ 
                    color: isWeak(i) || isStrong(i) ? getColor(i) : 'var(--text-muted)',
                    fontWeight: isWeak(i) || isStrong(i) ? 500 : 400
                  }}
                >
                  {day}
                </span>
              </div>
            ))}
          </div>
          
          {/* Legend */}
          <div className="flex justify-center gap-6 pt-3 border-t" style={{ borderColor: 'var(--text-faint)' }}>
            {patterns.weakDay && (
              <div className="flex items-center gap-2">
                <div className="w-2.5 h-2.5 rounded" style={{ background: 'var(--rose)' }} />
                <span className="text-xs" style={{ color: 'var(--rose)' }}>{patterns.weakDay.day}s drag</span>
              </div>
            )}
            {patterns.strongDay && (
              <div className="flex items-center gap-2">
                <div className="w-2.5 h-2.5 rounded" style={{ background: 'var(--green)' }} />
                <span className="text-xs" style={{ color: 'var(--green)' }}>{patterns.strongDay.day}s peak</span>
              </div>
            )}
          </div>
          
          <div className="text-center pt-3">
            <p className="text-xs italic" style={{ color: 'var(--text-muted)' }}>
              This pattern was there before I started watching.<br/>
              Now you can plan around it.
            </p>
          </div>
        </div>
      );
    };

    // ════════════════════════════════════════════════════════════════════════════
    // TWIN DAYS - Day 45-60 Visualization
    // ════════════════════════════════════════════════════════════════════════════
    const TwinDays = ({ twinData }) => {
      const [animate, setAnimate] = useState(false);
      
      useEffect(() => {
        const timer = setTimeout(() => setAnimate(true), 200);
        return () => clearTimeout(timer);
      }, []);
      
      if (!twinData) return null;
      
      const { followed, skipped } = twinData;
      
      const formatDate = (dateStr) => {
        const d = new Date(dateStr + 'T12:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };
      
      return (
        <div className="mt-6 mb-4">
          <div className="grid grid-cols-2 gap-3">
            {/* Left: The day they listened */}
            <div 
              className="p-4 rounded-xl border"
              style={{ 
                borderColor: 'var(--green)',
                opacity: animate ? 1 : 0,
                transform: animate ? 'translateY(0)' : 'translateY(10px)',
                transition: 'all 500ms ease-out'
              }}
            >
              <div className="text-xs mb-1" style={{ color: 'var(--text-muted)' }}>
                {formatDate(followed.date)}
              </div>
              <div className="text-xs mb-3" style={{ color: 'var(--text-faint)' }}>
                HRV: {followed.hrv} ms
              </div>
              
              <div className="text-center mb-3">
                <span className="text-xl" style={{ color: 'var(--green)' }}>✓</span>
                <div className="text-xs mt-1" style={{ color: 'var(--green)' }}>Rested</div>
              </div>
              
              {/* Mini outcome chart - rising */}
              <div className="flex items-end justify-center gap-2 h-12 mb-2">
                <div 
                  className="w-6 rounded-t"
                  style={{ 
                    background: 'var(--text-faint)',
                    height: animate ? '50%' : '20%',
                    transition: 'height 600ms ease-out 300ms'
                  }}
                />
                <div 
                  className="w-6 rounded-t"
                  style={{ 
                    background: 'var(--green)',
                    height: animate ? '100%' : '20%',
                    transition: 'height 600ms ease-out 500ms'
                  }}
                />
              </div>
              
              <div className="text-center">
                <span className="text-base font-medium" style={{ color: 'var(--green)' }}>
                  +{followed.outcome} ms
                </span>
                <div className="text-xs mt-1" style={{ color: 'var(--text-muted)' }}>
                  Back to BUILD
                </div>
              </div>
            </div>
            
            {/* Right: The day they pushed */}
            <div 
              className="p-4 rounded-xl border"
              style={{ 
                borderColor: 'var(--rose)',
                opacity: animate ? 1 : 0,
                transform: animate ? 'translateY(0)' : 'translateY(10px)',
                transition: 'all 500ms ease-out 150ms'
              }}
            >
              <div className="text-xs mb-1" style={{ color: 'var(--text-muted)' }}>
                {formatDate(skipped.date)}
              </div>
              <div className="text-xs mb-3" style={{ color: 'var(--text-faint)' }}>
                HRV: {skipped.hrv} ms
              </div>
              
              <div className="text-center mb-3">
                <span className="text-xl" style={{ color: 'var(--rose)' }}>✕</span>
                <div className="text-xs mt-1" style={{ color: 'var(--rose)' }}>Pushed</div>
              </div>
              
              {/* Mini outcome chart - declining */}
              <div className="flex items-end justify-center gap-2 h-12 mb-2">
                <div 
                  className="w-6 rounded-t"
                  style={{ 
                    background: 'var(--text-faint)',
                    height: animate ? '80%' : '20%',
                    transition: 'height 600ms ease-out 300ms'
                  }}
                />
                <div 
                  className="w-6 rounded-t"
                  style={{ 
                    background: 'var(--rose)',
                    height: animate ? '25%' : '20%',
                    transition: 'height 600ms ease-out 500ms'
                  }}
                />
              </div>
              
              <div className="text-center">
                <span className="text-base font-medium" style={{ color: 'var(--rose)' }}>
                  {skipped.outcome} ms
                </span>
                <div className="text-xs mt-1" style={{ color: 'var(--text-muted)' }}>
                  Days lost
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Helper to find twin days for visualization
    const findTwinDays = (hrvHistory, compliance, patterns) => {
      if (!patterns || compliance.length < 4) return null;
      
      // Get all REST compliance entries with outcomes
      const restEntries = compliance.filter(c => c.command === 'REST').map(c => {
        const entry = hrvHistory.find(h => h.date === c.date);
        if (!entry) return null;
        
        // Find next day's HRV
        const nextDate = new Date(c.date);
        nextDate.setDate(nextDate.getDate() + 1);
        const nextEntry = hrvHistory.find(h => h.date === getLocalDateString(nextDate));
        if (!nextEntry) return null;
        
        return {
          date: c.date,
          hrv: entry.value,
          followed: c.followed === 'yes',
          outcome: nextEntry.value - entry.value
        };
      }).filter(Boolean);
      
      // Find a pair: one followed (positive outcome), one skipped (negative outcome)
      const followed = restEntries.filter(e => e.followed && e.outcome > 5);
      const skipped = restEntries.filter(e => !e.followed && e.outcome < -5);
      
      if (!followed.length || !skipped.length) return null;
      
      // Find best pair with similar HRV (within 5ms) and at least 14 days apart
      let bestPair = null;
      let smallestDiff = Infinity;
      
      for (const f of followed) {
        for (const s of skipped) {
          const hrvDiff = Math.abs(f.hrv - s.hrv);
          const daysDiff = Math.abs(daysBetween(f.date, s.date));
          
          if (hrvDiff <= 5 && daysDiff >= 14 && hrvDiff < smallestDiff) {
            smallestDiff = hrvDiff;
            bestPair = { followed: f, skipped: s };
          }
        }
      }
      
      return bestPair;
    };

    // Collapsible Insight Scroll - appears above observation when open
    const InsightScroll = ({ insight }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [showTapHint, setShowTapHint] = useState(true);
      
      // Show "tap to open" on mount, fade after 3s
      useEffect(() => {
        if (!isOpen) {
          setShowTapHint(true);
          const timer = setTimeout(() => setShowTapHint(false), 3000);
          return () => clearTimeout(timer);
        } else {
          setShowTapHint(false);
        }
      }, [isOpen]);
      
      if (!insight) return null;
      
      const isMilestone = insight.isMilestone;
      
      return (
        <div 
          className={`insight-scroll animate-rise ${isOpen ? 'open' : 'collapsed'}`}
          onClick={() => setIsOpen(!isOpen)}
        >
          {/* Collapsed state: line with INSIGHT label */}
          <div className="insight-collapsed-line">
            <div className="insight-collapsed-line-segment" />
            <span className="insight-collapsed-label">INSIGHT</span>
            <div className="insight-collapsed-line-segment" />
          </div>
          
          {/* Open state: full content - always rendered for animation */}
          <div className="insight-scroll-wrapper">
            <div className="insight-scroll-inner">
              <div className="insight-scroll-line" />
              <div className="insight-scroll-content">
                <div 
                  className="insight-scroll-label"
                  style={isMilestone ? { color: 'var(--gold)' } : {}}
                >
                  {insight.label}
                </div>
                <div className="insight-scroll-text">
                  {insight.lines.map((line, i) => (
                    <React.Fragment key={i}>
                      {renderBoldText(line)}
                      {i < insight.lines.length - 1 && <br/>}
                    </React.Fragment>
                  ))}
                </div>
                
                {/* Visualizations */}
                {insight.visualization === 'heatmap' && insight.patterns && (
                  <WeekHeatmap patterns={insight.patterns} />
                )}
                {insight.visualization === 'twins' && insight.twinData && (
                  <TwinDays twinData={insight.twinData} />
                )}
                
                <div className="text-center mt-4">
                  <span className="text-xs" style={{ color: 'var(--text-muted)', opacity: 0.5 }}>tap to close</span>
                </div>
              </div>
              <div className="insight-scroll-line" />
            </div>
          </div>
          
          {/* Tap hint for collapsed state */}
          <div className={`insight-tap-hint ${showTapHint && !isOpen ? 'visible' : ''}`}>
            <span className="text-xs" style={{ color: 'var(--text-muted)' }}>tap to open</span>
          </div>
        </div>
      );
    };

    // Legacy Insight Block (fallback)
    const InsightBlock = ({ insight }) => {
      if (!insight) return null;
      return (
        <div className="insight-block animate-rise delay-400 mx-6">
          <div className="insight-label">{insight.label}</div>
          <div className="insight-content">
            {insight.lines.map((line, i) => <React.Fragment key={i}>{line}<br/></React.Fragment>)}
          </div>
        </div>
      );
    };

    // Event Log - collapsible section for logging life events
    const EventLog = ({ onLog, eventLog }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [showTapHint, setShowTapHint] = useState(true);
      const [selected, setSelected] = useState([]);
      const [otherText, setOtherText] = useState('');
      const [showSuccess, setShowSuccess] = useState(false);
      
      const today = getTodayLocal();
      
      // Load today's events on mount and when eventLog changes
      useEffect(() => {
        const todayEvent = eventLog.find(e => e.date === today);
        if (todayEvent && todayEvent.type) {
          const events = todayEvent.type.split(', ').map(e => e.trim());
          const knownTypes = ['alcohol', 'illness', 'injury'];
          const knownSelected = events.filter(e => knownTypes.includes(e));
          const otherEvents = events.filter(e => !knownTypes.includes(e));
          setSelected(knownSelected);
          setOtherText(otherEvents.join(', '));
        } else {
          setSelected([]);
          setOtherText('');
        }
      }, [eventLog, today]);
      
      // Show tap hint immediately when collapsed, fade after 3s
      useEffect(() => {
        if (!isOpen) {
          setShowTapHint(true);
          const timer = setTimeout(() => setShowTapHint(false), 3000);
          return () => clearTimeout(timer);
        } else {
          setShowTapHint(false);
        }
      }, [isOpen]);
      
      const handleToggle = (e) => {
        if (e.target.closest('.event-log-btn') || e.target.closest('.event-log-other') || e.target.closest('.event-log-confirm')) {
          return;
        }
        setIsOpen(!isOpen);
      };
      
      const handleSelect = (type) => {
        setSelected(prev => 
          prev.includes(type) 
            ? prev.filter(t => t !== type)
            : [...prev, type]
        );
      };
      
      const handleConfirm = () => {
        const events = [...selected];
        if (otherText.trim()) {
          events.push(otherText.trim());
        }
        
        const eventString = events.length > 0 ? events.join(', ') : '';
        onLog(eventString);
        setShowSuccess(true);
        
        setTimeout(() => {
          setShowSuccess(false);
          setIsOpen(false);
        }, 1500);
      };
      
      // Check if current state differs from saved state
      const todayEvent = eventLog.find(e => e.date === today);
      const savedEvents = todayEvent?.type ? todayEvent.type.split(', ').map(e => e.trim()) : [];
      const currentEvents = [...selected, ...(otherText.trim() ? [otherText.trim()] : [])];
      const hasChanges = JSON.stringify(savedEvents.sort()) !== JSON.stringify(currentEvents.sort());
      
      const canConfirm = hasChanges;
      const hasEvents = selected.length > 0 || otherText.trim().length > 0;
      
      return (
        <div 
          className={`event-log animate-rise delay-300 ${isOpen ? '' : 'collapsed'}`}
          onClick={handleToggle}
        >
          <div className="event-log-header">
            <div className="event-log-label">
              Log an event
              {hasEvents && !isOpen && <span style={{ color: 'var(--text-muted)', marginLeft: '8px' }}>•</span>}
            </div>
            <div className="event-log-line" />
          </div>
          
          <div className="event-log-content">
            <div className="event-log-buttons">
              <button 
                className={`event-log-btn ${selected.includes('alcohol') ? 'selected' : ''}`}
                onClick={() => handleSelect('alcohol')}
              >
                Alcohol
              </button>
              <button 
                className={`event-log-btn ${selected.includes('illness') ? 'selected' : ''}`}
                onClick={() => handleSelect('illness')}
              >
                Illness
              </button>
              <button 
                className={`event-log-btn ${selected.includes('injury') ? 'selected' : ''}`}
                onClick={() => handleSelect('injury')}
              >
                Injury
              </button>
            </div>
            
            <input
              type="text"
              className="event-log-other"
              placeholder="Other..."
              value={otherText}
              onChange={(e) => setOtherText(e.target.value)}
              onClick={(e) => e.stopPropagation()}
            />
            
            <button 
              className={`event-log-confirm ${canConfirm ? 'active' : ''}`}
              onClick={canConfirm ? handleConfirm : undefined}
              disabled={!canConfirm}
            >
              {hasEvents ? 'Update' : 'Clear'}
            </button>
            
            <p className={`event-log-success ${showSuccess ? 'show' : ''}`}>
              ✓ {hasEvents ? 'Event logged' : 'Cleared'}
            </p>
            
            <div className="text-center mt-4">
              <span className="text-xs" style={{ color: 'var(--text-muted)', opacity: 0.5 }}>tap to close</span>
            </div>
          </div>
          
          {!isOpen && showTapHint && (
            <div className="text-center mt-2">
              <span className="text-xs" style={{ color: 'var(--text-muted)', opacity: 0.4 }}>tap to open</span>
            </div>
          )}
        </div>
      );
    };

    // Compliance Prompt
    const CompliancePrompt = ({ onSelect }) => (
      <div className="fixed inset-0 flex items-center justify-center p-10" style={{ background: 'var(--bg-primary)' }}>
        <div className="text-center space-y-12 animate-rise max-w-xs w-full">
          <p className="font-display text-2xl italic" style={{ color: 'var(--text-secondary)' }}>
            Yesterday was...
          </p>
          <div className="flex gap-4">
            <button onClick={() => onSelect('yes')} className="btn-primary flex-1">Rested</button>
            <button onClick={() => onSelect('no')} className="btn-primary flex-1">Trained</button>
          </div>
        </div>
      </div>
    );

    // HRV Input
    const HRVInput = ({ value, onChange, onSubmit, hrvSource }) => (
      <div className="space-y-8 animate-rise max-w-xs mx-auto">
        <div className="text-center">
          <p className="text-sm" style={{ color: 'var(--text-muted)' }}>{hrvSource?.label || 'Your'} HRV this morning</p>
        </div>
        <input
          type="number"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          onKeyDown={(e) => e.key === 'Enter' && onSubmit()}
          placeholder="ms"
          className="input-minimal text-4xl font-display"
          autoFocus
        />
        <button
          onClick={onSubmit}
          disabled={!value}
          className="btn-primary"
          style={{ opacity: value ? 1 : 0.3, borderColor: value ? 'var(--gold)' : undefined, color: value ? 'var(--gold)' : undefined }}
        >
          Log
        </button>
      </div>
    );

    // ════════════════════════════════════════════════════════════════════════════
    // ONBOARDING
    // ════════════════════════════════════════════════════════════════════════════
    const Onboarding = ({ onComplete }) => {
      const [selectedDevice, setSelectedDevice] = useState(null);
      const [customDevice, setCustomDevice] = useState('');

      const devices = [
        { id: 'whoop', label: 'WHOOP' },
        { id: 'apple', label: 'Apple Watch' },
        { id: 'garmin', label: 'Garmin' },
        { id: 'oura', label: 'Oura' },
        { id: 'fitbit', label: 'Fitbit' },
        { id: 'polar', label: 'Polar' },
        { id: 'samsung', label: 'Samsung' },
        { id: 'other', label: 'Other' }
      ];

      const handleComplete = () => {
        const source = selectedDevice === 'other' 
          ? { id: 'custom', label: customDevice || 'Custom' }
          : devices.find(d => d.id === selectedDevice);
        onComplete(source, []);
      };

      return (
        <div className="min-h-screen flex flex-col justify-center p-10" style={{ background: 'var(--bg-primary)' }}>
          <div className="max-w-sm mx-auto w-full">
            <div className="space-y-8 animate-rise">
              <div className="text-center space-y-3">
                <p className="font-display text-2xl leading-relaxed" style={{ color: 'var(--text-primary)' }}>
                  Your body is talking.
                </p>
                <p className="text-sm" style={{ color: 'var(--text-muted)' }}>Where do you track HRV?</p>
              </div>
              <div className="space-y-2">
                {devices.map(device => (
                  <button
                    key={device.id}
                    onClick={() => setSelectedDevice(device.id)}
                    className={`device-btn ${selectedDevice === device.id ? 'selected' : ''}`}
                  >
                    {device.label}
                  </button>
                ))}
              </div>
              {selectedDevice === 'other' && (
                <input
                  type="text"
                  value={customDevice}
                  onChange={(e) => setCustomDevice(e.target.value)}
                  placeholder="Device name"
                  className="input-minimal text-sm"
                  style={{ textAlign: 'left', paddingLeft: '16px' }}
                />
              )}
              {selectedDevice && (
                <button onClick={handleComplete} className="btn-primary animate-fade" style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}>
                  Let's begin
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ════════════════════════════════════════════════════════════════════════════
    // INFO MODAL
    // ════════════════════════════════════════════════════════════════════════════
    const InfoModal = ({ isOpen, onClose, hrvSource }) => {
      if (!isOpen) return null;

      const deviceInstructions = {
        whoop: ['Open WHOOP app', 'Check your Recovery tab', 'Find "HRV" in milliseconds', 'Use the overnight average'],
        apple: ['Open Health app', 'Browse → Heart → Heart Rate Variability', 'Find most recent reading', 'Use the value in ms'],
        garmin: ['Open Garmin Connect', 'Go to Health Stats → HRV', 'Find overnight HRV', 'Use the value in ms'],
        oura: ['Open Oura app', 'Tap Readiness tab', 'Scroll to HRV Balance', 'Use the average in ms'],
        fitbit: ['Open Fitbit app', 'Tap Health Metrics', 'Find Heart Rate Variability', 'Use the daily average'],
        polar: ['Open Polar Flow', 'Go to Nightly Recharge', 'Find ANS Charge / HRV', 'Use the RMSSD value'],
        samsung: ['Open Samsung Health', 'Go to Stress measurement', 'Take a reading', 'Use the HRV value'],
      };

      const instructions = deviceInstructions[hrvSource?.id] || [
        `Check ${hrvSource?.label || 'your device'} app`,
        'Look for HRV or Heart Rate Variability',
        'Find the morning/overnight reading',
        'Use the value in milliseconds (ms)'
      ];

      return (
        <>
          <div className="modal-overlay" onClick={onClose} />
          <div className="modal-content flex items-center justify-center p-4">
            <div className="max-w-sm w-full rounded-2xl p-6 space-y-6 max-h-[85vh] overflow-y-auto" style={{ background: 'var(--bg-elevated)' }}>
              <div className="flex justify-between items-start">
                <h2 style={{ color: 'var(--text-primary)' }}>How GENYSYS Works</h2>
                <button onClick={onClose} className="text-2xl" style={{ color: 'var(--text-muted)' }}>×</button>
              </div>

              <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                Your nervous system tells us how recovered you are. We read it. We tell you what to do.
              </p>

              <div className="space-y-3">
                <div className="flex gap-3">
                  <span className="font-medium text-sm" style={{ color: '#FDA4AF', width: '70px' }}>REST</span>
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>Light movement only. System needs recovery.</span>
                </div>
                <div className="flex gap-3">
                  <span className="font-medium text-sm" style={{ color: '#C9A962', width: '70px' }}>BUILD</span>
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>Standard training. Execute your program.</span>
                </div>
                <div className="flex gap-3">
                  <span className="font-medium text-sm" style={{ color: '#6EE7B7', width: '70px' }}>PERFORM</span>
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>System primed. Push hard. Chase PRs.</span>
                </div>
              </div>

              <div className="divider" />

              <div>
                <h3 className="text-sm font-medium mb-2" style={{ color: 'var(--text-secondary)' }}>
                  Finding your HRV ({hrvSource?.label || 'Your device'})
                </h3>
                <ol className="text-xs space-y-1 list-decimal list-inside" style={{ color: 'var(--text-muted)' }}>
                  {instructions.map((step, i) => <li key={i}>{step}</li>)}
                </ol>
              </div>

              <div className="divider" />

              <div>
                <h3 className="text-sm font-medium mb-2" style={{ color: 'var(--text-secondary)' }}>What is HRV?</h3>
                <p className="text-xs" style={{ color: 'var(--text-muted)' }}>
                  Heart Rate Variability — the time variation between heartbeats, measured in milliseconds. Higher usually means more recovered. Most people range from 20-100ms.
                </p>
              </div>

              <p className="text-xs text-center pt-2" style={{ color: 'var(--text-faint)' }}>
                GENYSYS Beta — Your feedback shapes what we build.
              </p>
            </div>
          </div>
        </>
      );
    };

    // ════════════════════════════════════════════════════════════════════════════
    // HISTORY MODAL
    // ════════════════════════════════════════════════════════════════════════════
    const HistoryModal = ({ isOpen, onClose, hrvHistory, onAdd, onDelete }) => {
      const [newHrv, setNewHrv] = useState('');
      const [newDate, setNewDate] = useState(getYesterdayLocal());

      if (!isOpen) return null;

      const handleAdd = () => {
        if (newHrv && newDate && !hrvHistory.find(h => h.date === newDate)) {
          onAdd(parseInt(newHrv), newDate);
          setNewHrv('');
          // Fix: Use T12:00:00 to avoid timezone issues
          const prev = new Date(newDate + 'T12:00:00');
          prev.setDate(prev.getDate() - 1);
          setNewDate(getLocalDateString(prev));
        }
      };

      return (
        <>
          <div className="modal-overlay" onClick={onClose} />
          <div className="modal-content flex items-end justify-center">
            <div className="w-full max-w-md rounded-t-2xl p-6 space-y-6 animate-rise" style={{ background: 'var(--bg-elevated)' }}>
              <div className="flex justify-between items-center">
                <h3 style={{ color: 'var(--text-primary)' }}>Add Past HRV</h3>
                <div className="flex items-center gap-4">
                  <span className="text-sm" style={{ color: 'var(--text-muted)' }}>{hrvHistory.length} entries</span>
                  <button onClick={onClose} className="text-2xl" style={{ color: 'var(--text-muted)' }}>×</button>
                </div>
              </div>

              <div className="flex gap-2">
                <input
                  type="number"
                  value={newHrv}
                  onChange={(e) => setNewHrv(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleAdd()}
                  placeholder="HRV"
                  className="input-minimal w-20 text-sm"
                  autoFocus
                />
                <input
                  type="date"
                  value={newDate}
                  onChange={(e) => setNewDate(e.target.value)}
                  className="input-minimal flex-1 text-sm"
                  style={{ textAlign: 'left', paddingLeft: '12px' }}
                />
                <button onClick={handleAdd} className="px-4 rounded-xl text-sm" style={{ background: 'var(--bg-card)', border: '1px solid var(--text-faint)', color: 'var(--text-secondary)' }}>
                  Add
                </button>
              </div>

              {hrvHistory.length > 0 && (
                <div className="space-y-1 max-h-48 overflow-y-auto">
                  {[...hrvHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 14).map(e => (
                    <div key={e.date} className="flex justify-between items-center py-2 text-sm" style={{ borderBottom: '1px solid var(--text-faint)', opacity: 0.3 }}>
                      <span style={{ color: 'var(--text-muted)' }}>{e.date}</span>
                      <div className="flex items-center gap-3">
                        <span style={{ color: 'var(--text-secondary)' }}>{e.value} ms</span>
                        <button onClick={() => onDelete(e.date)} className="text-lg" style={{ color: 'var(--text-muted)' }}>×</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <button onClick={onClose} className="btn-primary">Done</button>
            </div>
          </div>
        </>
      );
    };

    // ════════════════════════════════════════════════════════════════════════════
    // FEEDBACK MODAL
    // ════════════════════════════════════════════════════════════════════════════
    // ════════════════════════════════════════════════════════════════════════════
    // FEEDBACK SURVEY - Day 14 & Day 30
    // Refined Jony Ive / Alan Dye aesthetics - feels like an opportunity, not a beg
    // ════════════════════════════════════════════════════════════════════════════
    const FeedbackModal = ({ isOpen, onClose, daysOnApp, onSubmit }) => {
      const [step, setStep] = useState(1);
      const [goal, setGoal] = useState(null);
      const [goalText, setGoalText] = useState('');
      const [feedback, setFeedback] = useState('');
      const [email, setEmail] = useState('');

      if (!isOpen) return null;
      
      // Round 1: days 7-14, Round 2: days 35-45
      const isRound1 = daysOnApp >= 7 && daysOnApp <= 14;
      const isRound2 = daysOnApp >= 35 && daysOnApp <= 45;

      const handleSubmit = () => {
        onSubmit({ 
          round: isRound1 ? 1 : 2,
          goal, 
          goalText, 
          feedback, 
          email: email.trim(),
          daysOnApp 
        });
        onClose();
      };

      const handleSkip = () => {
        onSubmit({ round: isRound1 ? 1 : 2, skipped: true, daysOnApp });
        onClose();
      };

      // Round 1 Survey: Understanding your goals
      if (isRound1) {
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
            <div className="absolute inset-0 bg-black/85" />
            <div className="relative max-w-sm w-full space-y-8 animate-rise">
              
              {step === 1 && (
                <div className="text-center space-y-8">
                  <div className="space-y-3">
                    <p className="text-xs tracking-widest" style={{ color: 'var(--gold)', opacity: 0.7 }}>DAY {daysOnApp}</p>
                    <p className="text-xl" style={{ color: 'var(--text-primary)' }}>
                      Most people quit by now.
                    </p>
                    <p style={{ color: 'var(--text-muted)' }}>
                      You didn't.
                    </p>
                  </div>
                  
                  <button
                    onClick={() => setStep(2)}
                    className="text-sm transition-opacity hover:opacity-70"
                    style={{ color: 'var(--text-faint)' }}
                  >
                    Continue →
                  </button>
                </div>
              )}

              {step === 2 && (
                <div className="text-center space-y-6">
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>
                    What are you building toward?
                  </p>
                  
                  <div className="space-y-2">
                    {[
                      { key: 'competition', label: 'Competition' },
                      { key: 'longevity', label: 'Longevity' },
                      { key: 'consistency', label: 'Staying consistent' },
                      { key: 'feeling', label: 'Feeling better' },
                      { key: 'other', label: 'Something else' },
                    ].map(opt => (
                      <button
                        key={opt.key}
                        onClick={() => { 
                          setGoal(opt.key); 
                          setStep(opt.key === 'other' ? 3 : 4); 
                        }}
                        className="w-full py-3 px-4 rounded-xl text-sm transition-all hover:opacity-80"
                        style={{ 
                          background: 'var(--bg-card)', 
                          color: 'var(--text-secondary)',
                          border: '1px solid var(--text-faint)'
                        }}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                  
                  <button 
                    onClick={handleSkip}
                    className="text-xs transition-opacity hover:opacity-70"
                    style={{ color: 'var(--text-faint)' }}
                  >
                    Skip
                  </button>
                </div>
              )}

              {step === 3 && (
                <div className="text-center space-y-6">
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>
                    Tell me more.
                  </p>
                  
                  <textarea
                    value={goalText}
                    onChange={(e) => setGoalText(e.target.value)}
                    placeholder="What are you working toward..."
                    className="input-minimal text-sm h-24 resize-none"
                    style={{ textAlign: 'left', padding: '12px 16px' }}
                    autoFocus
                  />

                  <button
                    onClick={() => setStep(4)}
                    className="btn-primary"
                    style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}
                  >
                    Continue
                  </button>
                </div>
              )}

              {step === 4 && (
                <div className="text-center space-y-6">
                  <div className="space-y-3">
                    <p className="text-lg" style={{ color: 'var(--text-primary)' }}>
                      I'm building something too.
                    </p>
                    <p className="text-sm leading-relaxed" style={{ color: 'var(--text-muted)' }}>
                      Auto-sync. Deeper patterns.<br/>
                      Predictions before you feel them.
                    </p>
                  </div>
                  
                  <div className="space-y-3 pt-2">
                    <p className="text-sm" style={{ color: 'var(--text-faint)' }}>Want early access?</p>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      placeholder="Email"
                      className="input-minimal text-sm"
                      style={{ textAlign: 'center' }}
                    />
                  </div>

                  <div className="space-y-2">
                    <button
                      onClick={handleSubmit}
                      className="btn-primary"
                      style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}
                    >
                      {email.trim() ? "I'm in" : "Continue"}
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Round 2 Survey: Product feedback (days 35-45)
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
          <div className="absolute inset-0 bg-black/85" />
          <div className="relative max-w-sm w-full space-y-8 animate-rise">
            
            {step === 1 && (
              <div className="text-center space-y-8">
                <div className="space-y-3">
                  <p className="text-xs tracking-widest" style={{ color: 'var(--gold)', opacity: 0.7 }}>DAY {daysOnApp}</p>
                  <p className="text-xl" style={{ color: 'var(--text-primary)' }}>
                    You're still here.
                  </p>
                  <p className="text-sm leading-relaxed" style={{ color: 'var(--text-muted)' }}>
                    That puts you ahead of 95% of people<br/>
                    who try to train smarter.
                  </p>
                </div>
                
                <button
                  onClick={() => setStep(2)}
                  className="text-sm transition-opacity hover:opacity-70"
                  style={{ color: 'var(--text-faint)' }}
                >
                  Continue →
                </button>
              </div>
            )}

            {step === 2 && (
              <div className="text-center space-y-6">
                <div className="space-y-2">
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>
                    I'm building the next version.
                  </p>
                  <p className="text-sm" style={{ color: 'var(--text-muted)' }}>
                    What would make this twice as valuable?
                  </p>
                </div>
                
                <textarea
                  value={feedback}
                  onChange={(e) => setFeedback(e.target.value)}
                  placeholder="The one thing..."
                  className="input-minimal text-sm h-24 resize-none"
                  style={{ textAlign: 'left', padding: '12px 16px' }}
                  autoFocus
                />

                <button
                  onClick={() => setStep(3)}
                  className="btn-primary"
                  style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}
                >
                  Continue
                </button>
                
                <button 
                  onClick={() => setStep(3)}
                  className="block mx-auto text-xs transition-opacity hover:opacity-70"
                  style={{ color: 'var(--text-faint)' }}
                >
                  Skip
                </button>
              </div>
            )}

            {step === 3 && (
              <div className="text-center space-y-6">
                <div className="space-y-3">
                  <p className="text-lg" style={{ color: 'var(--text-primary)' }}>
                    One more thing.
                  </p>
                  <p className="text-sm leading-relaxed" style={{ color: 'var(--text-muted)' }}>
                    Anyone in your life who needs this?
                  </p>
                  <p className="text-xs leading-relaxed" style={{ color: 'var(--text-faint)' }}>
                    A training partner. Someone who never rests.<br/>
                    A friend who's always overtrained.
                  </p>
                </div>

                <div className="space-y-2">
                  <button
                    onClick={() => setStep(4)}
                    className="w-full py-3 px-4 rounded-xl text-sm transition-all hover:opacity-80"
                    style={{ 
                      background: 'var(--bg-card)', 
                      color: 'var(--text-secondary)',
                      border: '1px solid var(--text-faint)'
                    }}
                  >
                    Yes, I know someone
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="w-full text-sm py-2 transition-opacity hover:opacity-70"
                    style={{ color: 'var(--text-faint)' }}
                  >
                    Not right now
                  </button>
                </div>
              </div>
            )}

            {step === 4 && (
              <div className="text-center space-y-6">
                <p className="text-lg" style={{ color: 'var(--text-primary)' }}>
                  Send them this link.
                </p>
                
                <div 
                  className="py-3 px-4 rounded-xl text-sm"
                  style={{ 
                    background: 'var(--bg-card)', 
                    color: 'var(--gold)',
                    border: '1px solid var(--gold)'
                  }}
                >
                  genysys.app
                </div>
                
                <p className="text-xs leading-relaxed" style={{ color: 'var(--text-muted)' }}>
                  The best testimonial is someone<br/>
                  who shows up every day.
                </p>

                <button
                  onClick={handleSubmit}
                  className="btn-primary"
                  style={{ borderColor: 'var(--gold)', color: 'var(--gold)' }}
                >
                  Done
                </button>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ════════════════════════════════════════════════════════════════════════════
    // MAIN APP
    // ════════════════════════════════════════════════════════════════════════════
    const App = () => {
      const [hrvHistory, setHrvHistory] = useState([]);
      const [compliance, setCompliance] = useState([]);
      const [timezones, setTimezones] = useState([]);
      const [firstUseDate, setFirstUseDate] = useState(null);
      const [hrvSource, setHrvSource] = useState(null);
      const [isLoading, setIsLoading] = useState(true);

      const [todayHRV, setTodayHRV] = useState('');
      const [isRevealed, setIsRevealed] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [showFeedback, setShowFeedback] = useState(false);
      const [showCompliance, setShowCompliance] = useState(false);
      const [pendingCompliance, setPendingCompliance] = useState(null);
      const [lastObsType, setLastObsType] = useState(null);
      const [feedbackShownAt, setFeedbackShownAt] = useState([]);
      const [eventLog, setEventLog] = useState([]);

      // Load - with migration from old field names
      useEffect(() => {
        try {
          const saved = localStorage.getItem('genysys_v2_data');
          if (saved) {
            const data = JSON.parse(saved);
            
            // Migration: hrvHistory is primary, fall back to old 'history' key
            const migratedHistory = data.hrvHistory || data.history || [];
            const migratedCompliance = data.complianceLog || data.compliance || [];
            const migratedTimezones = data.timezones || [];
            const migratedFirstUseDate = data.firstUseDate;
            const migratedHrvSource = data.hrvSource;
            const migratedLastObsType = data.lastObservationType || data.lastObsType || null;
            const migratedEventLog = data.eventLog || [];
            
            // Migration: convert old feedback structure to new
            let migratedFeedbackShownAt = data.feedbackShownAt || [];
            if (!data.feedbackShownAt) {
              // Old structure had feedbackRound1Complete, feedbackRound2Complete
              if (data.feedbackRound1Complete) migratedFeedbackShownAt.push(14);
              if (data.feedbackRound2Complete) migratedFeedbackShownAt.push(30);
            }
            
            setHrvHistory(migratedHistory);
            setCompliance(migratedCompliance);
            setTimezones(migratedTimezones);
            setFirstUseDate(migratedFirstUseDate);
            setHrvSource(migratedHrvSource);
            setLastObsType(migratedLastObsType);
            setFeedbackShownAt(migratedFeedbackShownAt);
            setEventLog(migratedEventLog);
            
            // If we found data with old key names, save in new format immediately
            if (data.history || data.compliance || data.lastObsType) {
              console.log('GENYSYS: Migrated data to new format');
              const newData = {
                hrvHistory: migratedHistory,
                complianceLog: migratedCompliance,
                timezones: migratedTimezones,
                firstUseDate: migratedFirstUseDate,
                hrvSource: migratedHrvSource,
                lastObservationType: migratedLastObsType,
                feedbackShownAt: migratedFeedbackShownAt,
                feedbackRound1Complete: migratedFeedbackShownAt.includes(14),
                feedbackRound2Complete: migratedFeedbackShownAt.includes(30),
                eventLog: migratedEventLog
              };
              localStorage.setItem('genysys_v2_data', JSON.stringify(newData));
            }
          }
        } catch (e) { console.error(e); }
        setIsLoading(false);
      }, []);

      // Save
      const save = useCallback((updates = {}) => {
        // Primary field names match project/old version for consistency
        const data = { 
          hrvHistory, 
          complianceLog: compliance, 
          timezones, 
          firstUseDate, 
          hrvSource, 
          lastObservationType: lastObsType, 
          feedbackShownAt, 
          feedbackRound1Complete: feedbackShownAt.includes(14),
          feedbackRound2Complete: feedbackShownAt.includes(30),
          eventLog,
          ...updates 
        };
        localStorage.setItem('genysys_v2_data', JSON.stringify(data));
      }, [hrvHistory, compliance, timezones, firstUseDate, hrvSource, lastObsType, feedbackShownAt, eventLog]);

      // Derived state
      const today = getTodayLocal();
      const todayEntry = hrvHistory.find(h => h.date === today);
      const patterns = useMemo(() => analyzePatterns(hrvHistory, compliance, timezones), [hrvHistory, compliance, timezones]);
      const daysOnApp = firstUseDate ? daysBetween(firstUseDate, today) + 1 : hrvHistory.length || 1;

      const result = useMemo(() => {
        if (!todayEntry || !patterns) return { command: 'LEARNING', isPreview: true, daysUntilFull: Math.max(0, 7 - hrvHistory.length) };
        const z = (todayEntry.value - patterns.baseline) / patterns.mad;
        const isPreview = hrvHistory.length < 7;
        return { command: getCommand(z), z, isPreview, daysUntilFull: isPreview ? Math.max(0, 7 - hrvHistory.length) : 0 };
      }, [todayEntry, patterns, hrvHistory.length]);

      const observation = useMemo(() => generateObservation(result.command, patterns, daysOnApp, hrvHistory, compliance, lastObsType), [result.command, patterns, daysOnApp, hrvHistory, compliance, lastObsType]);
      const actions = useMemo(() => generateActions(result.command, patterns, hrvHistory, compliance, daysOnApp), [result.command, patterns, hrvHistory, compliance, daysOnApp]);
      const insight = useMemo(() => getInsight(daysOnApp, patterns, compliance, hrvHistory, result.command), [daysOnApp, patterns, compliance, hrvHistory, result.command]);
      const receipt = useMemo(() => getReceipt(hrvHistory, compliance, patterns), [hrvHistory, compliance, patterns]);

      // Check for compliance prompt (only after REST days)
      useEffect(() => {
        if (!hrvHistory.length || !patterns) return;
        const yesterday = getYesterdayLocal();
        const yEntry = hrvHistory.find(h => h.date === yesterday);
        const yCompliance = compliance.find(c => c.date === yesterday);
        if (yEntry && !yCompliance) {
          const yZ = (yEntry.value - patterns.baseline) / patterns.mad;
          if (getCommand(yZ) === 'REST') {
            setPendingCompliance({ date: yesterday, command: 'REST' });
            setShowCompliance(true);
          }
        }
      }, [hrvHistory, compliance, patterns]);

      // Feedback trigger (Round 1: day 7-14, Round 2: day 35-45)
      useEffect(() => {
        const round1Range = daysOnApp >= 7 && daysOnApp <= 14;
        const round2Range = daysOnApp >= 35 && daysOnApp <= 45;
        
        if (round1Range && !feedbackShownAt.includes(1) && !feedbackShownAt.some(d => d >= 7 && d <= 14)) {
          setTimeout(() => setShowFeedback(true), 2000);
        } else if (round2Range && !feedbackShownAt.includes(2) && !feedbackShownAt.some(d => d >= 35 && d <= 45)) {
          setTimeout(() => setShowFeedback(true), 2000);
        }
      }, [daysOnApp, feedbackShownAt]);

      // Handlers
      const handleOnboardingComplete = (source, initialHistory) => {
        const today = getTodayLocal();
        setHrvSource(source);
        setFirstUseDate(today);
        if (initialHistory?.length) {
          setHrvHistory(initialHistory);
        }
        save({ hrvSource: source, firstUseDate: today, hrvHistory: initialHistory || [] });
        Analytics.track('onboarding_complete', { device: source.label, initialDays: initialHistory?.length || 0 });
      };

      const handleLogHRV = () => {
        const value = parseInt(todayHRV);
        if (isNaN(value) || value < 1 || value > 300) return;
        const newHistory = [...hrvHistory.filter(h => h.date !== today), { date: today, value }];
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const newTimezones = [...timezones.slice(-30), tz];
        setHrvHistory(newHistory);
        setTimezones(newTimezones);
        setTodayHRV('');
        setIsRevealed(false);
        save({ hrvHistory: newHistory, timezones: newTimezones });
        Analytics.track(hrvHistory.length === 0 ? 'first_hrv_logged' : 'hrv_logged', { hrv: value });
      };

      const handleCompliance = (followed) => {
        if (!pendingCompliance) return;
        const newCompliance = [...compliance, { ...pendingCompliance, followed }];
        setCompliance(newCompliance);
        save({ complianceLog: newCompliance });
        setShowCompliance(false);
        setPendingCompliance(null);
        Analytics.track('compliance_recorded', { command: pendingCompliance.command, followed });
      };

      const handleAddHistory = (value, date) => {
        if (hrvHistory.find(h => h.date === date)) return;
        const newHistory = [...hrvHistory, { date, value }].sort((a, b) => new Date(a.date) - new Date(b.date));
        setHrvHistory(newHistory);
        save({ hrvHistory: newHistory });
        Analytics.track('hrv_backfilled', { date, value });
      };

      const handleDeleteHistory = (date) => {
        const newHistory = hrvHistory.filter(h => h.date !== date);
        setHrvHistory(newHistory);
        save({ hrvHistory: newHistory });
      };

      const handleEventLog = (eventType) => {
        const today = getTodayLocal();
        // Update or add today's event (replace if exists)
        const existingIndex = eventLog.findIndex(e => e.date === today);
        let newEventLog;
        
        if (eventType === '') {
          // Clear today's event
          newEventLog = eventLog.filter(e => e.date !== today);
        } else if (existingIndex >= 0) {
          // Update existing
          newEventLog = [...eventLog];
          newEventLog[existingIndex] = { date: today, type: eventType, timestamp: new Date().toISOString() };
        } else {
          // Add new
          newEventLog = [...eventLog, { date: today, type: eventType, timestamp: new Date().toISOString() }];
        }
        
        setEventLog(newEventLog);
        save({ eventLog: newEventLog });
        Analytics.track('event_logged', { type: eventType, date: today });
      };

      const handleFeedback = (feedback) => {
        const newShown = [...feedbackShownAt, daysOnApp];
        setFeedbackShownAt(newShown);
        save({ feedbackShownAt: newShown });
        if (feedback.skipped) {
          Analytics.track(`feedback_round${feedback.round}_dismissed`);
        } else {
          Analytics.track(`feedback_round${feedback.round}_submitted`, feedback);
        }
      };

      const resetAll = () => {
        if (confirm('Reset all data? This cannot be undone.')) {
          localStorage.removeItem('genysys_v2_data');
          setHrvHistory([]); setCompliance([]); setTimezones([]);
          setFirstUseDate(null); setHrvSource(null);
          setIsRevealed(false);
          Analytics.track('data_reset');
        }
      };

      // Update lastObsType when observation changes
      useEffect(() => {
        if (observation?.type && observation.type !== lastObsType) {
          setLastObsType(observation.type);
          save({ lastObservationType: observation.type });
        }
      }, [observation?.type]);

      if (isLoading) {
        return <div className="min-h-screen flex items-center justify-center" style={{ background: 'var(--bg-primary)' }}><span style={{ color: 'var(--text-faint)' }}>...</span></div>;
      }

      if (!hrvSource) {
        return <Onboarding onComplete={handleOnboardingComplete} />;
      }

      if (showCompliance) {
        return <CompliancePrompt onSelect={handleCompliance} />;
      }

      return (
        <div className="min-h-screen" style={{ background: 'var(--bg-primary)' }}>
          <div className="max-w-md mx-auto px-8 py-6 min-h-screen flex flex-col">

            {/* Header */}
            <header className="flex justify-between items-center mb-6">
              <button onClick={() => setShowInfo(true)} className="text-xs tracking-widest" style={{ color: 'var(--gold)', opacity: 0.6 }}>
                GENYSYS
              </button>
              <span className="text-xs" style={{ color: 'var(--text-muted)' }}>
                {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
              </span>
            </header>

            {/* Main */}
            <main className="flex-1 flex flex-col">
              {!todayEntry ? (
                <div className="flex-1 flex items-center justify-center">
                  <HRVInput value={todayHRV} onChange={setTodayHRV} onSubmit={handleLogHRV} hrvSource={hrvSource} />
                </div>
              ) : (
                <div className="flex-1">
                  {/* Receipt */}
                  {isRevealed && <Receipt receipt={receipt} />}
                  
                  {/* Day-of-week warning */}
                  {isRevealed && patterns?.todayDowPattern && <DowWarning pattern={patterns.todayDowPattern} />}

                  {/* Command */}
                  <CommandDisplay command={result.command} isRevealed={isRevealed} onClick={() => setIsRevealed(true)} />

                  {/* Revealed content */}
                  {isRevealed && (
                    <>
                      {/* Insight scroll - above observation, collapsible */}
                      {insight && <InsightScroll insight={insight} />}
                      
                      {/* Day 1-2 Promise Content (disappears after enough data) */}
                      {!insight && hrvHistory.length < 7 && daysOnApp <= 2 && (
                        <InsightScroll insight={{
                          label: daysOnApp === 1 ? 'THE PROMISE' : 'WHAT YOU\'LL LEARN',
                          lines: daysOnApp === 1 ? [
                            'In a week, you\'ll stop guessing.',
                            'In a month, you\'ll recognize your rhythms.',
                            'In a year, you\'ll understand the version of you that shows up again and again —',
                            'and how to steer it.'
                          ] : [
                            'Before you opened this, you already had a story about how you feel.',
                            'Tired. Energized. Ready. Wrecked.',
                            'The body doesn\'t run on stories. It runs on the night you just had.',
                            'For your whole life, you\'ve been guessing. The body has been keeping score.'
                          ]
                        }} />
                      )}
                      
                      {observation && <Observation text={observation.text} />}
                      <Prescription actions={actions} />
                      
                      {/* Event Log - collapsible section */}
                      <EventLog onLog={handleEventLog} eventLog={eventLog} />
                      
                      {result.isPreview && (
                        <div className="text-center mt-6 animate-rise delay-400 space-y-3">
                          <p className="text-xs" style={{ color: 'var(--text-muted)' }}>
                            {result.daysUntilFull > 0 ? `${result.daysUntilFull} days until personalized guidance.` : 'Baseline forming.'}
                          </p>
                          {result.daysUntilFull > 0 && (
                            <p className="text-xs" style={{ color: 'var(--gold)', opacity: 0.8 }}>
                              Your past data can unlock this now.
                            </p>
                          )}
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}
            </main>

            {/* Footer - always visible, no scrolling needed */}
            <footer className="pt-4 pb-4 text-center text-xs" style={{ color: 'var(--text-muted)' }}>
              <button onClick={() => setShowHistory(true)} className="hover:opacity-70 transition-opacity">+ History</button>
            </footer>
          </div>

          {/* Modals */}
          <InfoModal isOpen={showInfo} onClose={() => setShowInfo(false)} hrvSource={hrvSource} />
          <HistoryModal isOpen={showHistory} onClose={() => setShowHistory(false)} hrvHistory={hrvHistory} onAdd={handleAddHistory} onDelete={handleDeleteHistory} />
          <FeedbackModal isOpen={showFeedback} onClose={() => setShowFeedback(false)} daysOnApp={daysOnApp} onSubmit={handleFeedback} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
