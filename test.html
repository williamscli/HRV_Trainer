<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" type="image/png" href="data:image/png;base64,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">
  <link rel="apple-touch-icon" href="data:image/png;base64,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">
  <title>GENYSYS (Private Beta)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18.2.0 - pinned versions with crossorigin for security -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js" crossorigin="anonymous"></script>
  <style>
    body { background: #0f172a; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ============================================
    // ANALYTICS CONFIGURATION
    // ============================================
    // Replace with your Google Apps Script Web App URL
    const ANALYTICS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxp_XAHJDYn8gRpbqaHrDjC1u1Dgyy3-i_JU6WS9R62XiFm26tJdhZP1EOi3ID8mgtg/exec';
    
    // Allowed events (must match server allowlist)
    const ALLOWED_EVENTS = [
      'session_start', 'onboarding_complete', 'first_hrv_logged', 'hrv_logged',
      'hrv_backfilled', 'command_generated', 'compliance_recorded', 'energy_recorded',
      'day_3_active', 'day_7_active', 'day_14_active', 'day_30_active',
      'feedback_submitted', 'feedback_dismissed', 'data_exported', 'results_sent',
      'data_reset', 'legacy_user_migrated'
    ];

    // ============================================
    // DATE HELPERS (use local time, not UTC)
    // ============================================
    const getLocalDateString = (date = new Date()) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const getTodayLocal = () => getLocalDateString();
    
    const getYesterdayLocal = () => {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      return getLocalDateString(yesterday);
    };
    
    // Generate UUID v4
    const generateUUID = () => {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    };

    // Get timezone (privacy-friendly region detection)
    const getTimezone = () => {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (e) {
        return 'Unknown';
      }
    };

    // Analytics tracker
    const Analytics = {
      userId: null,
      timezone: null,
      device: null,
      firstUseDate: null,

      init() {
        // Get or create user ID
        let stored = localStorage.getItem('genysys_analytics');
        if (stored) {
          const data = JSON.parse(stored);
          this.userId = data.userId;
          this.timezone = data.timezone || getTimezone();
          this.firstUseDate = data.firstUseDate;
        } else {
          this.userId = generateUUID();
          this.timezone = getTimezone();
          
          // Check if they have existing app data (legacy user from before analytics)
          const appData = localStorage.getItem('genysys_user_data');
          if (appData) {
            try {
              const parsed = JSON.parse(appData);
              this.firstUseDate = parsed.firstUseDate || getTodayLocal();
              // Track that this is a migrated legacy user (delay to ensure init completes)
              setTimeout(() => this.track('legacy_user_migrated', { 
                device: parsed.hrvSource?.label || 'unknown',
                daysLogged: parsed.hrvHistory?.length || 0
              }), 100);
            } catch (e) {
              this.firstUseDate = getTodayLocal();
            }
          } else {
            this.firstUseDate = getTodayLocal();
          }
          
          this.save();
        }
      },

      save() {
        localStorage.setItem('genysys_analytics', JSON.stringify({
          userId: this.userId,
          timezone: this.timezone,
          firstUseDate: this.firstUseDate
        }));
      },

      setDevice(device) {
        this.device = device;
      },

      getDaysActive() {
        if (!this.firstUseDate) return 0;
        const first = new Date(this.firstUseDate);
        const now = new Date();
        return Math.floor((now - first) / (1000 * 60 * 60 * 24));
      },

      track(eventName, properties = {}) {
        // Client-side validation (matches server)
        if (!ALLOWED_EVENTS.includes(eventName)) {
          console.warn('[Analytics] Unknown event:', eventName);
          return;
        }
        
        if (!this.userId) {
          console.warn('[Analytics] No userId, skipping');
          return;
        }
        
        const payload = {
          timestamp: new Date().toISOString(),
          userId: this.userId,
          event: eventName,
          device: this.device || properties.device || 'unknown',
          daysActive: this.getDaysActive(),
          region: this.timezone,
          ...properties
        };

        // Log to console in development
        console.log('[Analytics]', eventName, payload);

        // Send to Google Sheets (fire and forget)
        if (ANALYTICS_ENDPOINT && ANALYTICS_ENDPOINT !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
          fetch(ANALYTICS_ENDPOINT, {
            method: 'POST',
            mode: 'no-cors', // Google Apps Script requires this
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).catch(err => console.log('Analytics error:', err));
        }
      }
    };

    // Initialize analytics
    Analytics.init();

    // ============================================
    // APP CONFIGURATION
    // ============================================
    const THRESHOLDS = { REST: -1.0, PERFORM: 0.5, MIN_DAYS: 7, MIN_PREVIEW_DAYS: 3, MAD_FLOOR: 3.0 };

    const PRESCRIPTIONS = {
      REST: {
        color: '#EF4444',
        bg: 'rgba(239, 68, 68, 0.15)',
        headline: 'REST',
        prescription: 'Light movement only. Walk, stretch, or mobilize. No intense training today.',
        guidance: ['Prioritize 8+ hours of sleep tonight', 'Keep heart rate under 120 bpm', 'Focus on nutrition and hydration']
      },
      BUILD: {
        color: '#F59E0B',
        bg: 'rgba(245, 158, 11, 0.15)',
        headline: 'BUILD',
        prescription: 'Standard training day. Follow your program as planned.',
        guidance: ['Execute your scheduled workout', 'Train at normal intensity', 'Listen to your body for minor adjustments']
      },
      PERFORM: {
        color: '#10B981',
        bg: 'rgba(16, 185, 129, 0.15)',
        headline: 'PERFORM',
        prescription: 'System primed. Push hard today — PRs, competition, max effort.',
        guidance: ['Go for personal records', 'High intensity is welcomed', 'Your body can handle more today']
      },
      LEARNING: {
        color: '#6B7280',
        bg: 'rgba(107, 114, 128, 0.15)',
        headline: 'LEARNING',
        prescription: 'Building your baseline. Keep logging HRV daily.',
        guidance: ['Train normally while we learn your patterns', 'Log HRV at the same time each morning', 'Preview commands start after 3 days']
      }
    };

    const calculateMedian = (arr) => {
      const sorted = [...arr].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    };

    const calculateMAD = (arr, median) => {
      const deviations = arr.map(v => Math.abs(v - median)).sort((a, b) => a - b);
      return Math.max(calculateMedian(deviations) * 1.4826, THRESHOLDS.MAD_FLOOR);
    };

    const getCommandKey = (zScore) => {
      if (zScore === null) return 'LEARNING';
      if (zScore < THRESHOLDS.REST) return 'REST';
      if (zScore >= THRESHOLDS.PERFORM) return 'PERFORM';
      return 'BUILD';
    };

    const ZScoreChart = ({ zScore, baseline, mad }) => {
      const minZ = -3, maxZ = 3, range = maxZ - minZ;
      const clampedZ = Math.max(minZ, Math.min(maxZ, zScore));
      const markerPosition = ((clampedZ - minZ) / range) * 100;
      const restEnd = ((-1 - minZ) / range) * 100;
      const buildEnd = ((0.5 - minZ) / range) * 100;
      const restHRV = Math.round(baseline + (-1 * mad));
      const performHRV = Math.round(baseline + (0.5 * mad));

      return (
        <div className="bg-slate-800 rounded-xl p-4 space-y-3">
          <div className="text-xs text-slate-500 uppercase tracking-wide text-center">Where You Are Today</div>
          <div className="flex text-xs font-medium">
            <div className="text-red-400" style={{ width: `${restEnd}%` }}>REST</div>
            <div className="text-amber-400" style={{ width: `${buildEnd - restEnd}%` }}>BUILD</div>
            <div className="text-green-400 text-right flex-1">PERFORM</div>
          </div>
          <div className="relative h-8 rounded-lg overflow-hidden">
            <div className="absolute inset-0 flex">
              <div className="h-full bg-red-500/30" style={{ width: `${restEnd}%` }} />
              <div className="h-full bg-amber-500/30" style={{ width: `${buildEnd - restEnd}%` }} />
              <div className="h-full bg-green-500/30 flex-1" />
            </div>
            <div className="absolute top-0 bottom-0 w-0.5 bg-slate-600" style={{ left: `${restEnd}%` }} />
            <div className="absolute top-0 bottom-0 w-0.5 bg-slate-600" style={{ left: `${buildEnd}%` }} />
            <div className="absolute top-0 bottom-0 flex flex-col items-center transition-all duration-300" style={{ left: `${markerPosition}%`, transform: 'translateX(-50%)' }}>
              <div className="w-1 flex-1 bg-white rounded-full shadow-lg shadow-white/50" />
            </div>
          </div>
          <div className="flex justify-between text-xs text-slate-600">
            <span>{Math.round(baseline + (minZ * mad))}</span>
            <span className="text-slate-500">{restHRV}</span>
            <span className="text-slate-500">{performHRV}</span>
            <span>{Math.round(baseline + (maxZ * mad))}</span>
          </div>
          <div className="text-center text-xs text-slate-600">
            Your baseline: <span className="text-slate-400 font-mono">{Math.round(baseline)} ms</span>
            <span className="text-slate-700 mx-2">•</span>
            Range: <span className="text-slate-400 font-mono">{restHRV}—{performHRV} ms</span> is BUILD
          </div>
        </div>
      );
    };

    const exportToCSV = (hrvHistory, complianceLog, userName, hrvSource) => {
      const allDates = [...new Set([...hrvHistory.map(h => h.date), ...complianceLog.map(c => c.date)])].sort();
      const headers = ['Date', 'HRV (ms)', 'Command', 'Followed', 'Energy', 'Source'];
      const rows = allDates.map(date => {
        const hrv = hrvHistory.find(h => h.date === date);
        const compliance = complianceLog.find(c => c.date === date);
        return [date, hrv?.value || '', compliance?.command || '', compliance?.followed || '', compliance?.energy || '', hrvSource?.label || ''];
      });
      const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `genysys_hrv_${userName || 'data'}_${getTodayLocal()}.csv`;
      link.click();
      
      // Track export
      Analytics.track('data_exported', { daysLogged: hrvHistory.length });
    };

    const generateCSVContent = (hrvHistory, complianceLog, userName, hrvSource) => {
      const allDates = [...new Set([...hrvHistory.map(h => h.date), ...complianceLog.map(c => c.date)])].sort();
      const headers = ['Date', 'HRV (ms)', 'Command', 'Followed', 'Energy', 'Source'];
      const rows = allDates.map(date => {
        const hrv = hrvHistory.find(h => h.date === date);
        const compliance = complianceLog.find(c => c.date === date);
        return [date, hrv?.value || '', compliance?.command || '', compliance?.followed || '', compliance?.energy || '', hrvSource?.label || ''];
      });
      return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    };

    const HRV_GUIDES = {
      whoop: {
        title: 'Finding HRV in WHOOP',
        steps: [
          'Open the WHOOP app',
          'Tap on today\'s Recovery score',
          'Look for "HRV" — it\'s in milliseconds (ms)',
          'Use the number next to "HRV" (e.g., 45, 62, 78)'
        ]
      },
      apple: {
        title: 'Finding HRV on Apple Watch',
        steps: [
          'Open the Health app on your iPhone',
          'Tap Browse → Heart → Heart Rate Variability',
          'Look at your most recent morning reading',
          'Use the number in milliseconds (ms)'
        ]
      },
      oura: {
        title: 'Finding HRV in Oura',
        steps: [
          'Open the Oura app',
          'Tap on Readiness',
          'Scroll to "HRV Balance"',
          'Tap to see your average HRV in ms'
        ]
      },
      garmin: {
        title: 'Finding HRV in Garmin',
        steps: [
          'Open Garmin Connect app',
          'Go to Health Stats → HRV Status',
          'Look for your overnight HRV average',
          'Use the number in milliseconds (ms)'
        ]
      },
      fitbit: {
        title: 'Finding HRV in Fitbit',
        steps: [
          'Open the Fitbit app',
          'Tap the Health Metrics tile (or go to Discover → Health Metrics)',
          'Look for "Heart Rate Variability"',
          'Use the number in milliseconds (ms)'
        ]
      },
      welltory: {
        title: 'Taking HRV with Welltory',
        steps: [
          'Open Welltory each morning before getting up',
          'Tap "Measure" and place finger on camera',
          'Wait 1-2 minutes for the reading',
          'Use the HRV number shown (in ms)'
        ]
      },
      other: {
        title: 'Finding Your HRV',
        steps: [
          'Open your health/fitness app',
          'Look for "HRV" or "Heart Rate Variability"',
          'Find the number in milliseconds (ms)',
          'Usually shown as a number like 35-100'
        ]
      }
    };

    const FeedbackModal = ({ step, setStep, useful, setUseful, improvement, setImprovement, email, setEmail, onSend, onDismiss, getDaysSinceFirstUse }) => (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div className="bg-slate-800 rounded-2xl p-6 max-w-sm w-full space-y-5" onClick={e => e.stopPropagation()}>
          
          {/* Step 1: The real question */}
          {step === 1 && (
            <>
              <div className="text-center">
                <h2 className="text-xl font-semibold text-white">Has this changed how you train?</h2>
              </div>
              
              <div className="space-y-3">
                <button
                  onClick={() => { setUseful('yes'); setStep(2); }}
                  className="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition text-left px-4"
                >
                  Yes
                </button>
                <button
                  onClick={() => { setUseful('not_yet'); setStep(2); }}
                  className="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition text-left px-4"
                >
                  Not yet
                </button>
              </div>

              <button onClick={() => onDismiss(false)} className="w-full text-slate-500 hover:text-slate-300 text-sm transition pt-2">
                Skip for now
              </button>
            </>
          )}

          {/* Step 2: The improvement */}
          {step === 2 && (
            <>
              <div className="text-center">
                <h2 className="text-xl font-semibold text-white">One thing that would make it better?</h2>
              </div>
              
              <textarea
                value={improvement}
                onChange={(e) => setImprovement(e.target.value)}
                placeholder="Anything at all..."
                className="w-full bg-slate-700 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none h-28"
                autoFocus
              />

              <button
                onClick={() => setStep(3)}
                className="w-full bg-white text-slate-900 font-semibold py-3 rounded-xl transition hover:bg-slate-100"
              >
                Next
              </button>
            </>
          )}

          {/* Step 3: Early access - single button, email signals interest */}
          {step === 3 && (
            <>
              <div className="text-center space-y-2">
                <h2 className="text-lg font-semibold text-white">
                  {useful === 'yes' ? "Glad it's helping." : "Fair."} Here's what we're building.
                </h2>
              </div>

              <div className="space-y-4 text-sm">
                <div className="space-y-1">
                  <div className="text-white font-medium">Auto-sync</div>
                  <div className="text-slate-400">No more typing. We pull from your wearable.</div>
                </div>
                <div className="space-y-1">
                  <div className="text-white font-medium">PERFORM window</div>
                  <div className="text-slate-400">Know when your next high-intensity day is coming.</div>
                </div>
              </div>

              <div className="space-y-2 pt-2">
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="Email for early access"
                  className="w-full bg-slate-700 rounded-lg px-4 py-3 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <button
                onClick={() => onSend()}
                className="w-full bg-white text-slate-900 font-semibold py-3 rounded-xl transition hover:bg-slate-100"
              >
                Send feedback
              </button>
            </>
          )}

        </div>
      </div>
    );

    const InfoModal = ({ onClose, hrvSource }) => {
      const guide = HRV_GUIDES[hrvSource?.type] || HRV_GUIDES.other;
      return (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50" onClick={onClose}>
        <div className="bg-slate-800 rounded-2xl p-6 max-w-md max-h-[80vh] overflow-y-auto space-y-4" onClick={e => e.stopPropagation()}>
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold">How GENYSYS Works</h2>
            <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">&times;</button>
          </div>
          
          <div className="space-y-4 text-sm text-slate-300">
            <p>Your nervous system tells us how recovered you are. We read it. We tell you what to do.</p>
            
            <div className="bg-slate-700/50 rounded-lg p-3 space-y-2">
              <div className="flex items-center gap-2"><span className="text-red-400 font-bold">REST</span> <span className="text-slate-400">→ Light movement only. System needs recovery.</span></div>
              <div className="flex items-center gap-2"><span className="text-amber-400 font-bold">BUILD</span> <span className="text-slate-400">→ Standard training. Execute your program.</span></div>
              <div className="flex items-center gap-2"><span className="text-green-400 font-bold">PERFORM</span> <span className="text-slate-400">→ System primed. Push hard. Chase PRs.</span></div>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">What is HRV?</h3>
              <p className="text-slate-400">Heart Rate Variability — the time variation between heartbeats, measured in milliseconds (ms). Higher usually means more recovered. Most people range from 20-100ms.</p>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">Where to find your HRV ({hrvSource?.label})</h3>
              <ol className="list-decimal list-inside space-y-1 text-slate-400">
                {guide.steps.map((step, i) => (
                  <li key={i}>{step}</li>
                ))}
              </ol>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">The Process</h3>
              <ol className="list-decimal list-inside space-y-1 text-slate-400">
                <li>Log your morning HRV from your device</li>
                <li>After 3 days: Preview commands begin</li>
                <li>After 7 days: Full personalized baseline</li>
              </ol>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-1">No Wearable?</h3>
              <p className="text-slate-400 mb-2">Download <span className="text-white">Welltory</span> (free). Take a 1-minute reading with your phone camera each morning.</p>
              <div className="flex gap-2">
                <a href="https://apps.apple.com/app/welltory/id1074367771" target="_blank" rel="noopener noreferrer" className="flex-1 bg-slate-700 hover:bg-slate-600 text-center text-xs py-2 rounded-lg transition">iOS App Store</a>
                <a href="https://play.google.com/store/apps/details?id=com.welltory.client.android" target="_blank" rel="noopener noreferrer" className="flex-1 bg-slate-700 hover:bg-slate-600 text-center text-xs py-2 rounded-lg transition">Google Play</a>
              </div>
            </div>

            <div className="bg-amber-900/30 border border-amber-700/50 rounded-lg p-3">
              <h3 className="font-semibold text-amber-400 mb-1">âš ï¸ Use the Same Device</h3>
              <p className="text-slate-400 text-xs">Your data is stored locally on this device only. It won't transfer to other phones or computers. Always log from the same device.</p>
            </div>

            <div className="pt-2 border-t border-slate-700">
              <p className="text-slate-500 text-xs">GENYSYS Private Beta — Your feedback shapes what we build next.</p>
            </div>
          </div>
        </div>
      </div>
    );
    };

    const App = () => {
      const [hrvHistory, setHrvHistory] = useState([]);
      const [complianceLog, setComplianceLog] = useState([]);
      const [todayHRV, setTodayHRV] = useState('');
      const [result, setResult] = useState(null);
      const [showHistory, setShowHistory] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [showOnboarding, setShowOnboarding] = useState(true);
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [showHrvGuide, setShowHrvGuide] = useState(false);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackStep, setFeedbackStep] = useState(1);
      const [feedbackUseful, setFeedbackUseful] = useState(null); // 'yes' or 'not_yet'
      const [feedbackImprovement, setFeedbackImprovement] = useState('');
      const [feedbackEmail, setFeedbackEmail] = useState('');
      const [firstUseDate, setFirstUseDate] = useState(null);
      const [feedbackDismissedAt, setFeedbackDismissedAt] = useState(null);
      const [feedbackSubmitted, setFeedbackSubmitted] = useState(false);
      const [newEntry, setNewEntry] = useState('');
      const [newEntryDate, setNewEntryDate] = useState(getTodayLocal());
      const [userName, setUserName] = useState('');
      const [hrvSource, setHrvSource] = useState(null); // {type: 'WHOOP'|etc, custom?: string}
      const [isLoading, setIsLoading] = useState(true);
      const [otherSourceText, setOtherSourceText] = useState('');
      
      // Track retention milestones
      const trackedMilestones = useRef(new Set());

      const CONTACT_EMAIL = 'clinton.bill.williams@gmail.com';

      const HRV_SOURCES = [
        { id: 'whoop', label: 'WHOOP' },
        { id: 'apple', label: 'Apple Watch' },
        { id: 'oura', label: 'Oura' },
        { id: 'garmin', label: 'Garmin' },
        { id: 'fitbit', label: 'Fitbit' },
        { id: 'welltory', label: 'Welltory (Phone Camera)' },
        { id: 'other', label: 'Other' },
      ];

      // Load from localStorage
      useEffect(() => {
        try {
          const saved = localStorage.getItem('genysys_user_data');
          if (saved) {
            const data = JSON.parse(saved);
            setHrvHistory(data.hrvHistory || []);
            setUserName(data.userName || '');
            setComplianceLog(data.complianceLog || []);
            setHrvSource(data.hrvSource || null);
            setFirstUseDate(data.firstUseDate || null);
            setFeedbackDismissedAt(data.feedbackDismissedAt || null);
            setFeedbackSubmitted(data.feedbackSubmitted || false);
            
            // Set device for analytics
            if (data.hrvSource) {
              Analytics.setDevice(data.hrvSource.label);
            }
            
            // Skip onboarding for returning users
            if (data.hrvSource) {
              setShowOnboarding(false);
              
              // Track returning user session
              Analytics.track('session_start', { returning: true });
            }
          } else {
            // Track new user session
            Analytics.track('session_start', { returning: false });
          }
        } catch (e) { console.log('No saved data'); }
        setIsLoading(false);
      }, []);

      // Save to localStorage
      useEffect(() => {
        if (isLoading) return;
        localStorage.setItem('genysys_user_data', JSON.stringify({ 
          hrvHistory, userName, complianceLog, hrvSource,
          firstUseDate, feedbackDismissedAt, feedbackSubmitted 
        }));
      }, [hrvHistory, userName, complianceLog, hrvSource, firstUseDate, feedbackDismissedAt, feedbackSubmitted, isLoading]);

      // Set firstUseDate when user first completes onboarding
      useEffect(() => {
        if (hrvSource && !firstUseDate) {
          setFirstUseDate(getTodayLocal());
        }
      }, [hrvSource, firstUseDate]);

      // Calculate days since first use
      const getDaysSinceFirstUse = () => {
        if (!firstUseDate) return 0;
        const first = new Date(firstUseDate);
        const now = new Date();
        const diff = Math.floor((now - first) / (1000 * 60 * 60 * 24));
        return diff;
      };

      // Track retention milestones
      useEffect(() => {
        if (!hrvSource || isLoading) return;
        
        const daysActive = getDaysSinceFirstUse();
        const milestones = [3, 7, 14, 30];
        
        milestones.forEach(milestone => {
          if (daysActive >= milestone && !trackedMilestones.current.has(milestone)) {
            trackedMilestones.current.add(milestone);
            Analytics.track(`day_${milestone}_active`, { daysLogged: hrvHistory.length });
          }
        });
      }, [hrvSource, isLoading, hrvHistory.length]);

      // Check if we should show feedback prompt
      // TEST VERSION: Shows immediately (>= 0) instead of waiting for day 7
      const shouldShowFeedback = () => {
        if (feedbackSubmitted) return false;
        const daysSinceFirstUse = getDaysSinceFirstUse();
        
        // TEST: First prompt immediately
        if (daysSinceFirstUse >= 0 && !feedbackDismissedAt) return true;
        
        // TEST: Second prompt immediately after dismissal
        if (daysSinceFirstUse >= 0 && feedbackDismissedAt) {
          const dismissedDate = new Date(feedbackDismissedAt);
          const daysSinceDismissed = Math.floor((new Date() - dismissedDate) / (1000 * 60 * 60 * 24));
          if (daysSinceDismissed >= 0) return true;
        }
        
        return false;
      };

      // Check for feedback prompt after calculating command
      useEffect(() => {
        if (result && result.commandKey && result.commandKey !== 'LEARNING' && shouldShowFeedback()) {
          // Small delay so they see their command first
          const timer = setTimeout(() => setShowFeedback(true), 1500);
          return () => clearTimeout(timer);
        }
      }, [result]);

      const sendFeedback = () => {
        // Track feedback via analytics (no email needed)
        Analytics.track('feedback_submitted', { 
          useful: feedbackUseful,
          improvementText: feedbackImprovement.substring(0, 500) || '',
          userEmail: feedbackEmail.trim().substring(0, 100) || '',
          daysLogged: hrvHistory.length
        });
        
        setFeedbackSubmitted(true);
        setShowFeedback(false);
        setFeedbackStep(1);
        setFeedbackUseful(null);
        setFeedbackImprovement('');
        setFeedbackEmail('');
      };

      const dismissFeedback = (dontAskAgain) => {
        if (dontAskAgain) {
          setFeedbackSubmitted(true);
        } else {
          setFeedbackDismissedAt(getTodayLocal());
        }
        setShowFeedback(false);
        setFeedbackStep(1);
        
        // Track feedback dismissal
        Analytics.track('feedback_dismissed', { dontAskAgain });
      };

      // Auto-calculate if today's data exists
      useEffect(() => {
        if (isLoading) return;
        const todayDate = getTodayLocal();
        const todayEntry = hrvHistory.find(h => h.date === todayDate);
        if (todayEntry) {
          setTodayHRV(todayEntry.value.toString());
          const historyWithoutToday = hrvHistory.filter(h => h.date !== todayDate);
          const values = historyWithoutToday.map(h => h.value);
          const isPreview = values.length >= THRESHOLDS.MIN_PREVIEW_DAYS && values.length < THRESHOLDS.MIN_DAYS;
          
          if (values.length < THRESHOLDS.MIN_PREVIEW_DAYS) {
            setResult({ commandKey: 'LEARNING', baseline: null, mad: null, zScore: null, daysNeeded: THRESHOLDS.MIN_PREVIEW_DAYS - values.length, isPreview: false });
          } else {
            const median = calculateMedian(values);
            const mad = calculateMAD(values, median);
            const zScore = (todayEntry.value - median) / mad;
            setResult({ commandKey: getCommandKey(zScore), baseline: median, mad, zScore, todayValue: todayEntry.value, isPreview, daysUntilFull: isPreview ? THRESHOLDS.MIN_DAYS - values.length : 0 });
          }
        }
      }, [isLoading, hrvHistory]);

      const addToHistory = () => {
        const val = parseFloat(newEntry);
        if (isNaN(val) || val <= 0) return;
        const existingIndex = hrvHistory.findIndex(h => h.date === newEntryDate);
        let newHistory = existingIndex >= 0 
          ? hrvHistory.map((h, i) => i === existingIndex ? { value: val, date: newEntryDate } : h)
          : [...hrvHistory, { value: val, date: newEntryDate }];
        newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        if (newHistory.length > 14) newHistory.shift();
        setHrvHistory(newHistory);
        setNewEntry('');
        
        // Track historical HRV entry
        Analytics.track('hrv_backfilled', { hrv: val, hrvDate: newEntryDate, daysLogged: newHistory.length });
      };

      const removeFromHistory = (displayIndex) => {
        const actualIndex = hrvHistory.length - 1 - displayIndex;
        setHrvHistory(hrvHistory.filter((_, i) => i !== actualIndex));
      };

      const calculateCommand = () => {
        const today = parseFloat(todayHRV);
        if (isNaN(today) || today <= 0) { setResult({ error: 'Enter valid HRV' }); return; }
        
        const todayDate = getTodayLocal();
        const existingIndex = hrvHistory.findIndex(h => h.date === todayDate);
        const isFirstHRV = hrvHistory.length === 0;
        
        let updatedHistory = existingIndex >= 0
          ? hrvHistory.map((h, i) => i === existingIndex ? { value: today, date: todayDate } : h)
          : [...hrvHistory, { value: today, date: todayDate }];
        updatedHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
        if (updatedHistory.length > 14) updatedHistory.shift();
        setHrvHistory(updatedHistory);

        const historyWithoutToday = updatedHistory.filter(h => h.date !== todayDate);
        const values = historyWithoutToday.map(h => h.value);

        let commandKey;
        const isPreview = values.length >= THRESHOLDS.MIN_PREVIEW_DAYS && values.length < THRESHOLDS.MIN_DAYS;
        
        if (values.length < THRESHOLDS.MIN_PREVIEW_DAYS) {
          setResult({ commandKey: 'LEARNING', baseline: null, mad: null, zScore: null, daysNeeded: THRESHOLDS.MIN_PREVIEW_DAYS - values.length, isPreview: false });
          commandKey = 'LEARNING';
        } else {
          const median = calculateMedian(values);
          const mad = calculateMAD(values, median);
          const zScore = (today - median) / mad;
          commandKey = getCommandKey(zScore);
          setResult({ commandKey, baseline: median, mad, zScore, todayValue: today, isPreview, daysUntilFull: isPreview ? THRESHOLDS.MIN_DAYS - values.length : 0 });
        }

        // Log today's command
        const existingLog = complianceLog.findIndex(c => c.date === todayDate);
        if (existingLog >= 0) {
          setComplianceLog(complianceLog.map((c, i) => i === existingLog ? { ...c, command: commandKey } : c));
        } else {
          setComplianceLog([...complianceLog, { date: todayDate, command: commandKey, followed: null, energy: null }]);
        }
        
        // Track HRV logging
        if (isFirstHRV) {
          Analytics.track('first_hrv_logged', { hrv: today, hrvDate: todayDate });
        } else {
          Analytics.track('hrv_logged', { 
            hrv: today,
            hrvDate: todayDate,
            command: commandKey, 
            daysLogged: updatedHistory.length,
            isPreview
          });
        }
        
        // Track command generation (only for non-LEARNING)
        if (commandKey !== 'LEARNING') {
          Analytics.track('command_generated', { command: commandKey, isPreview });
        }
      };

      // Yesterday compliance logic
      const yesterdayDate = getYesterdayLocal();
      const yesterdayData = complianceLog.find(c => c.date === yesterdayDate);
      const needsYesterdayCompliance = yesterdayData && yesterdayData.command && yesterdayData.command !== 'LEARNING' && yesterdayData.followed === null;

      const todayDate = getTodayLocal();
      const todayCompliance = complianceLog.find(c => c.date === todayDate);
      const needsEnergyInput = todayCompliance && todayCompliance.command && todayCompliance.energy === null;

      const recordYesterdayCompliance = (followed) => {
        setComplianceLog(complianceLog.map(c => c.date === yesterdayDate ? { ...c, followed } : c));
        
        // Track compliance
        Analytics.track('compliance_recorded', { 
          complianceDate: yesterdayDate,
          command: yesterdayData.command, 
          followed 
        });
      };

      const recordTodayEnergy = (energy) => {
        setComplianceLog(complianceLog.map(c => c.date === todayDate ? { ...c, energy } : c));
        
        // Track energy input
        if (energy !== 'skipped') {
          Analytics.track('energy_recorded', { energy });
        }
      };

      const clearHistory = () => { setHrvHistory([]); setComplianceLog([]); setResult(null); };
      const resetAll = () => { 
        localStorage.removeItem('genysys_user_data'); 
        setHrvHistory([]); 
        setComplianceLog([]); 
        setUserName(''); 
        setHrvSource(null); 
        setResult(null); 
        setTodayHRV(''); 
        setFirstUseDate(null); 
        setFeedbackDismissedAt(null); 
        setFeedbackSubmitted(false); 
        setFeedbackStep(1); 
        setFeedbackUseful(null); 
        setFeedbackImprovement(''); 
        setFeedbackEmail(''); 
        
        // Track reset (but don't reset analytics ID)
        Analytics.track('data_reset');
      };

      // ============================================
      // EVIDENCE LOOP CALCULATION
      // ============================================
      const calculateEvidence = () => {
        if (hrvHistory.length < 5 || complianceLog.length < 3) return null;
        
        // Get baseline stats
        const values = hrvHistory.map(h => h.value).sort((a,b) => a - b);
        const median = values[Math.floor(values.length / 2)];
        const deviations = values.map(v => Math.abs(v - median));
        const mad = Math.max(deviations.sort((a,b) => a - b)[Math.floor(deviations.length / 2)] * 1.4826, THRESHOLDS.MAD_FLOOR);
        
        // Track REST command outcomes (the core validation)
        let restFollowed = { total: 0, crashed: 0 };  // Rested when told to rest
        let restIgnored = { total: 0, crashed: 0 };   // Pushed when told to rest
        
        // Track overall outcomes
        let protectedDays = 0;     // REST followed → recovered
        let missedRecovery = 0;    // REST followed → still crashed
        let overspent = 0;         // REST ignored → crashed (pushed when body said stop)
        let missedWindows = 0;     // BUILD/PERFORM → skipped (had capacity, didn't use it)
        
        // Functional Days: days you START with capacity (HRV above crash threshold)
        let functionalDays = 0;
        hrvHistory.forEach(h => {
          const zScore = (h.value - median) / mad;
          if (zScore >= THRESHOLDS.REST) functionalDays++;
        });
        
        complianceLog.forEach(log => {
          if (!log.command || log.command === 'LEARNING' || !log.followed) return;
          
          // Find next day's HRV
          const logDate = new Date(log.date);
          const nextDate = new Date(logDate);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = getLocalDateString(nextDate);
          const nextDayHRV = hrvHistory.find(h => h.date === nextDateStr);
          
          if (log.command === 'REST') {
            // User was told to rest - compliance is yes/no
            if (log.followed === 'yes') {
              // They rested as commanded
              restFollowed.total++;
              if (nextDayHRV) {
                const zScore = (nextDayHRV.value - median) / mad;
                const crashed = zScore < THRESHOLDS.REST;
                if (crashed) {
                  restFollowed.crashed++;
                  missedRecovery++;
                } else {
                  protectedDays++;
                }
              }
            } else if (log.followed === 'no') {
              // They pushed anyway (ignored REST)
              restIgnored.total++;
              if (nextDayHRV) {
                const zScore = (nextDayHRV.value - median) / mad;
                const crashed = zScore < THRESHOLDS.REST;
                if (crashed) {
                  restIgnored.crashed++;
                  overspent++;  // Pushed when body said stop
                }
              }
            }
          } else if (log.command === 'BUILD' || log.command === 'PERFORM') {
            // User was cleared to train
            if (log.followed === 'skipped') {
              // Had capacity but didn't use it
              missedWindows++;
            }
          }
        });
        
        return {
          restFollowed,
          restIgnored,
          functionalDays,
          totalDays: hrvHistory.length,
          protectedDays,
          missedRecovery,
          overspent,
          missedWindows,
          hasEnoughData: restFollowed.total + restIgnored.total >= 2
        };
      };
      
      const evidence = calculateEvidence();
      
      // ============================================
      // COMMAND CONTEXT - The feedback loop
      // Shows consequence history WITH the command
      // 
      // Window logic:
      // - Minimum: 3 REST decisions before showing stats
      // - Sample: last 5 REST decisions (however long that takes)
      // - Maximum: 60 days cap for relevance
      // - Streak: consecutive from today, no window
      // 
      // Core loop: Command → Comply/Override → Outcome → Evidence → Trust
      // 
      // Recovery = next day HRV z-score >= -1.0 (above crash threshold)
      // Crash = next day HRV z-score < -1.0 (in crash zone)
      // ============================================
      const getCommandContext = () => {
        if (!result || !result.commandKey || result.commandKey === 'LEARNING') return null;
        
        // Get baseline for crash detection
        const values = hrvHistory.map(h => h.value).sort((a,b) => a - b);
        if (values.length < 5) return null;
        const median = values[Math.floor(values.length / 2)];
        const deviations = values.map(v => Math.abs(v - median));
        const mad = Math.max(deviations.sort((a,b) => a - b)[Math.floor(deviations.length / 2)] * 1.4826, THRESHOLDS.MAD_FLOOR);
        
        // 60-day cap for relevance
        const sixtyDaysAgo = new Date();
        sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
        
        // Get all REST logs within 60 days, sorted newest first
        const restLogs = complianceLog
          .filter(log => {
            const logDate = new Date(log.date);
            return logDate >= sixtyDaysAgo && log.command === 'REST' && log.followed;
          })
          .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Take last 5 REST decisions (or fewer if not enough)
        const recentRestLogs = restLogs.slice(0, 5);
        
        // Calculate streak (consecutive REST followed from most recent)
        let currentRestStreak = 0;
        for (const log of restLogs) {
          if (log.followed === 'yes') {
            currentRestStreak++;
          } else {
            break;
          }
        }
        
        // Calculate outcomes for REST commands
        let recentRestIgnored = [];
        let recentRestFollowed = [];
        
        recentRestLogs.forEach(log => {
          // Find next day's HRV
          const logDate = new Date(log.date);
          const nextDate = new Date(logDate);
          nextDate.setDate(nextDate.getDate() + 1);
          const nextDateStr = getLocalDateString(nextDate);
          const nextDayHRV = hrvHistory.find(h => h.date === nextDateStr);
          
          if (!nextDayHRV) return;
          
          // Crash = next day z-score below REST threshold (-1.0)
          const zScore = (nextDayHRV.value - median) / mad;
          const crashed = zScore < THRESHOLDS.REST;
          
          if (log.followed === 'yes') {
            recentRestFollowed.push({ crashed });
          } else if (log.followed === 'no') {
            recentRestIgnored.push({ crashed });
          }
        });
        
        const totalRestDecisions = recentRestFollowed.length + recentRestIgnored.length;
        
        if (result.commandKey === 'REST') {
          // Need at least 3 REST decisions before showing stats
          if (totalRestDecisions < 3) return null;
          
          const ignoredCount = recentRestIgnored.length;
          const crashedAfterIgnore = recentRestIgnored.filter(r => r.crashed).length;
          const followedCount = recentRestFollowed.length;
          const recoveredAfterFollow = recentRestFollowed.filter(r => !r.crashed).length;
          
          // Priority: show ignore consequences if they exist
          if (ignoredCount > 0 && crashedAfterIgnore > 0) {
            return {
              type: 'warning',
              text: `You trained through ${ignoredCount} REST day${ignoredCount > 1 ? 's' : ''}. ${crashedAfterIgnore} time${crashedAfterIgnore > 1 ? 's' : ''} you weren't ready the next morning.`
            };
          }
          
          // Otherwise show follow outcomes
          if (followedCount > 0 && recoveredAfterFollow > 0) {
            return {
              type: 'affirm',
              text: `You followed REST ${followedCount} time${followedCount > 1 ? 's' : ''}. ${recoveredAfterFollow} morning${recoveredAfterFollow > 1 ? 's' : ''} you woke up ready to train.`
            };
          }
        }
        
        // PERFORM only — HRV earned this, streak rewards the pattern
        if (result.commandKey === 'PERFORM' && currentRestStreak >= 1) {
          if (currentRestStreak >= 3) {
            return {
              type: 'earned',
              text: `${currentRestStreak} REST days banked. You earned this.`
            };
          } else {
            return {
              type: 'earned',
              text: `Recovery banked. Go.`
            };
          }
        }
        
        // BUILD — the goal state. Tiered feedback based on actual app usage time.
        if (result.commandKey === 'BUILD') {
          const daysOnApp = getDaysSinceFirstUse();
          
          // Short-term feedback for early days (before we have enough real usage data)
          if (daysOnApp < 3) {
            return null; // Too early for feedback
          } else if (daysOnApp <= 4) {
            return {
              type: 'affirm',
              text: `Commands active. Let's see what you've got.`
            };
          } else if (daysOnApp <= 6) {
            return {
              type: 'affirm',
              text: `${daysOnApp} days in. Your pattern is emerging.`
            };
          }
          
          // Days 7+: Show full functional ratio (only count days since firstUseDate, not backfilled)
          const firstUseDateObj = firstUseDate ? new Date(firstUseDate) : null;
          const sortedHRV = [...hrvHistory]
            .filter(h => firstUseDateObj && new Date(h.date) >= firstUseDateObj)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
          const lastTen = sortedHRV.slice(0, 10);
          
          if (lastTen.length < 5) return null; // Not enough real usage data yet
          
          let functionalCount = 0;
          for (const entry of lastTen) {
            const zScore = (entry.value - median) / mad;
            if (zScore >= THRESHOLDS.REST) {
              functionalCount++;
            }
          }
          
          const totalDays = lastTen.length;
          
          if (functionalCount >= 8) {
            return {
              type: 'affirm',
              text: `${functionalCount} of your last ${totalDays} mornings, you woke up ready.`
            };
          } else if (functionalCount >= 6) {
            return {
              type: 'affirm',
              text: `${functionalCount} of ${totalDays} days you had capacity. You're finding your rhythm.`
            };
          }
          // < 6: no message, don't rub it in
        }
        
        return null;
      };
      
      const commandContext = getCommandContext();
      
      // Handle onboarding completion
      const handleOnboardingComplete = (source) => {
        setHrvSource(source);
        Analytics.setDevice(source.label);
        Analytics.track('onboarding_complete', { device: source.label });
        setShowHrvGuide(true);
      };

      if (isLoading) return <div className="min-h-screen bg-slate-900 text-white flex items-center justify-center"><div className="text-slate-400">Loading...</div></div>;

      // Intro onboarding (first time only)
      if (!hrvSource && showOnboarding) {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-6 flex flex-col justify-center overflow-x-hidden">
            <div className="max-w-md mx-auto space-y-8">
              
              {/* Screen 1: The crash */}
              {onboardingStep === 1 && (
                <>
                  <div className="space-y-6 text-center">
                    <p className="text-slate-400 text-lg">Some days your body says stop.</p>
                    <p className="text-white text-xl font-medium">You push anyway.</p>
                    <p className="text-slate-500 text-lg">The next day, you pay for it.</p>
                  </div>
                  <button 
                    onClick={() => setOnboardingStep(2)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Next
                  </button>
                </>
              )}

              {/* Screen 2: The missed opportunity */}
              {onboardingStep === 2 && (
                <>
                  <div className="space-y-6 text-center">
                    <p className="text-slate-400 text-lg">Some days you're ready to PR.</p>
                    <p className="text-white text-xl font-medium">But you don't know it. So you hold back.</p>
                    <p className="text-slate-500 text-lg">That day is gone.</p>
                  </div>
                  <button 
                    onClick={() => setOnboardingStep(3)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Next
                  </button>
                </>
              )}

              {/* Screen 3: The pivot */}
              {onboardingStep === 3 && (
                <>
                  <div className="text-center">
                    <p className="text-white text-2xl font-semibold">What if you knew which day was which?</p>
                  </div>
                  <button 
                    onClick={() => setOnboardingStep(4)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Next
                  </button>
                </>
              )}

              {/* Screen 4: The product */}
              {onboardingStep === 4 && (
                <>
                  <div className="space-y-6 text-center">
                    <p className="text-slate-400">One command. Every morning.</p>
                    <div className="flex justify-center gap-6 py-2">
                      <span className="text-red-400 font-black text-3xl">REST</span>
                      <span className="text-amber-400 font-black text-3xl">BUILD</span>
                      <span className="text-green-400 font-black text-3xl">PERFORM</span>
                    </div>
                    <div className="space-y-2 text-slate-500 text-sm">
                      <p>Validated on 2,249 days of real data.</p>
                      <p>When people follow the command, they crash <span className="text-white">2-4x less</span>.</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => setShowOnboarding(false)}
                    className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
                  >
                    Get Started
                  </button>
                  <p className="text-slate-600 text-xs text-center">No wearable? No problem — we'll show you a free option.</p>
                </>
              )}

            </div>
          </div>
        );
      }

      // HRV source selection
      if (!hrvSource) {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
            <div className="max-w-md mx-auto space-y-6 pt-8">
              <div className="text-center space-y-2">
                <h1 className="text-2xl font-bold">Where do you get your HRV?</h1>
                <p className="text-slate-500 text-sm">We'll show you exactly where to find it</p>
              </div>
              
              <div className="space-y-2">
                {HRV_SOURCES.map(source => (
                  <button
                    key={source.id}
                    onClick={() => {
                      if (source.id !== 'other') {
                        handleOnboardingComplete({ type: source.id, label: source.label });
                      }
                    }}
                    className={`w-full text-left px-4 py-3 rounded-lg transition ${
                      source.id === 'other' 
                        ? 'bg-slate-800/50 text-slate-400' 
                        : 'bg-slate-800 hover:bg-slate-700 text-white'
                    }`}
                  >
                    {source.label}
                  </button>
                ))}
              </div>
              
              {/* Other input */}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={otherSourceText}
                  onChange={(e) => setOtherSourceText(e.target.value)}
                  placeholder="Other source..."
                  className="flex-1 min-w-0 bg-slate-800 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                  onClick={() => {
                    if (otherSourceText.trim()) {
                      handleOnboardingComplete({ type: 'other', label: otherSourceText.trim() });
                    }
                  }}
                  disabled={!otherSourceText.trim()}
                  className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg px-4 py-3 font-medium transition shrink-0"
                >
                  Go
                </button>
              </div>

              <div className="text-center text-slate-600 text-xs pt-4">
                Don't have a wearable? Select <span className="text-slate-400">Welltory</span> — it's free and uses your phone camera.
              </div>
            </div>
          </div>
        );
      }

      // HRV Guide screen (shows after device selection)
      if (showHrvGuide) {
        const guide = HRV_GUIDES[hrvSource.type] || HRV_GUIDES.other;
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
            <div className="max-w-md mx-auto space-y-6 pt-8">
              
              <div className="text-center space-y-2">
                <h1 className="text-2xl font-bold">{guide.title}</h1>
              </div>

              {/* What is HRV */}
              <div className="bg-slate-800/50 rounded-xl p-4 space-y-2">
                <h3 className="text-slate-400 text-xs uppercase tracking-wide">What is HRV?</h3>
                <p className="text-slate-300 text-sm">Heart Rate Variability — the variation in time between heartbeats. Higher usually means more recovered. It's measured in milliseconds (ms).</p>
                <p className="text-slate-500 text-xs">Most people range from 20-100ms. Yours will vary day to day.</p>
              </div>

              {/* Steps */}
              <div className="bg-slate-800 rounded-xl p-4 space-y-3">
                <h3 className="text-slate-400 text-xs uppercase tracking-wide">How to find it</h3>
                <ol className="space-y-3">
                  {guide.steps.map((step, i) => (
                    <li key={i} className="flex gap-3 text-sm">
                      <span className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center shrink-0 text-xs font-bold">{i + 1}</span>
                      <span className="text-slate-300">{step}</span>
                    </li>
                  ))}
                </ol>
              </div>

              <button 
                onClick={() => setShowHrvGuide(false)}
                className="w-full bg-white text-slate-900 font-semibold py-4 rounded-xl text-lg hover:bg-slate-100 transition"
              >
                Got it — Let's Start
              </button>

              <button 
                onClick={() => {
                  setHrvSource(null);
                  setShowHrvGuide(false);
                }}
                className="w-full text-slate-600 text-sm py-2 hover:text-slate-400 transition"
              >
                â† Choose different device
              </button>
            </div>
          </div>
        );
      }

      const prescription = result && !result.error ? PRESCRIPTIONS[result.commandKey] : null;

      return (
        <div className="min-h-screen bg-slate-900 text-white p-4 overflow-x-hidden">
          <div className="max-w-md mx-auto space-y-4">
            
            {/* Header */}
            <div className="flex items-center justify-between pt-2 pb-1">
              <div className="flex items-center gap-2">
                <div className="text-xs text-slate-600">{hrvSource?.label}</div>
                <button onClick={() => setShowInfo(true)} className="text-slate-500 hover:text-slate-300 text-sm">â“˜</button>
              </div>
              <div className="flex items-center gap-2 text-xs text-slate-500">
                {userName && <span>{userName}</span>}
              </div>
            </div>

            {/* Info Modal */}
            {showInfo && <InfoModal onClose={() => setShowInfo(false)} hrvSource={hrvSource} />}
            {showFeedback && <FeedbackModal step={feedbackStep} setStep={setFeedbackStep} useful={feedbackUseful} setUseful={setFeedbackUseful} improvement={feedbackImprovement} setImprovement={setFeedbackImprovement} email={feedbackEmail} setEmail={setFeedbackEmail} onSend={sendFeedback} onDismiss={dismissFeedback} getDaysSinceFirstUse={getDaysSinceFirstUse} />}

            {/* Yesterday Compliance */}
            {needsYesterdayCompliance && (
              <div className="bg-slate-800 rounded-xl p-4 space-y-3">
                <div className="text-center">
                  <div className="text-slate-400 text-sm">Yesterday was</div>
                  <div className="text-2xl font-bold" style={{ color: PRESCRIPTIONS[yesterdayData.command]?.color || '#6B7280' }}>{yesterdayData.command}</div>
                  <div className="text-slate-500 text-sm mt-2">
                    {yesterdayData.command === 'REST' ? 'Did you rest?' : "How'd it go?"}
                  </div>
                </div>
                {yesterdayData.command === 'REST' ? (
                  <div className="flex gap-2">
                    <button onClick={() => recordYesterdayCompliance('yes')} className="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 rounded-lg py-3 text-sm font-medium transition">Yes</button>
                    <button onClick={() => recordYesterdayCompliance('no')} className="flex-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 rounded-lg py-3 text-sm font-medium transition">No</button>
                  </div>
                ) : (
                  <div className="flex gap-2">
                    <button onClick={() => recordYesterdayCompliance('skipped')} className="flex-1 bg-slate-600/20 hover:bg-slate-600/30 text-slate-400 rounded-lg py-2 text-sm font-medium transition">Skipped</button>
                    <button onClick={() => recordYesterdayCompliance('trained')} className="flex-1 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 rounded-lg py-2 text-sm font-medium transition">Trained</button>
                    <button onClick={() => recordYesterdayCompliance('sent_it')} className="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 rounded-lg py-2 text-sm font-medium transition">Sent It</button>
                  </div>
                )}
              </div>
            )}

            {/* Energy */}
            {needsEnergyInput && !needsYesterdayCompliance && (
              <div className="bg-slate-800/50 rounded-xl p-4 space-y-3">
                <div className="text-center text-slate-500 text-sm">How's your energy today?</div>
                <div className="flex gap-2">
                  <button onClick={() => recordTodayEnergy('low')} className="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg py-2 text-sm transition">Low</button>
                  <button onClick={() => recordTodayEnergy('normal')} className="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg py-2 text-sm transition">Normal</button>
                  <button onClick={() => recordTodayEnergy('high')} className="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg py-2 text-sm transition">High</button>
                </div>
                <button onClick={() => recordTodayEnergy('skipped')} className="w-full text-slate-600 text-xs py-1 hover:text-slate-500">Skip</button>
              </div>
            )}

            {/* HERO */}
            {prescription && (
              <div className="rounded-2xl p-6 space-y-4" style={{ backgroundColor: prescription.bg, border: `1px solid ${prescription.color}30` }}>
                {/* Preview badge */}
                {result.isPreview && (
                  <div className="text-center">
                    <span className="inline-block bg-slate-700 text-slate-300 text-xs px-3 py-1 rounded-full">
                      Preview Mode
                    </span>
                  </div>
                )}
                <div className="text-center">
                  <div className="text-6xl font-black tracking-tighter" style={{ color: prescription.color }}>{prescription.headline}</div>
                  <div className="text-slate-300 text-lg mt-2 font-medium">{prescription.prescription}</div>
                </div>
                <div className="space-y-2 pt-2">
                  {prescription.guidance.map((item, i) => (
                    <div key={i} className="flex items-start gap-3 text-slate-400 text-sm">
                      <span style={{ color: prescription.color }}>→</span>
                      <span>{item}</span>
                    </div>
                  ))}
                </div>
                {/* Command Context - The feedback loop */}
                {commandContext && (
                  <div className={`text-center text-sm pt-3 mt-3 border-t border-slate-700/30 ${
                    commandContext.type === 'warning' ? 'text-red-400/90' :
                    commandContext.type === 'caution' ? 'text-amber-400/90' :
                    commandContext.type === 'affirm' ? 'text-green-400/80' :
                    commandContext.type === 'earned' ? 'text-emerald-400/80' :
                    'text-slate-400'
                  }`}>
                    {commandContext.text}
                  </div>
                )}
                {/* Preview disclaimer */}
                {result.isPreview && (
                  <div className="text-center text-slate-500 text-xs pt-2 border-t border-slate-700/50">
                    Based on limited data — accuracy improves in {result.daysUntilFull} more day{result.daysUntilFull !== 1 ? 's' : ''}
                  </div>
                )}
                {result.zScore !== null && !result.isPreview && (
                  <div className="flex justify-center gap-8 pt-3 text-xs text-slate-500 border-t border-slate-700/50 mt-4">
                    <div className="text-center"><div className="font-mono text-slate-400 text-lg">{Math.round(result.baseline)}</div><div>baseline</div></div>
                    <div className="text-center"><div className="font-mono text-slate-400 text-lg">{Math.round(result.todayValue)}</div><div>today</div></div>
                  </div>
                )}
                {result.zScore !== null && result.isPreview && (
                  <div className="flex justify-center gap-8 pt-2 text-xs text-slate-600">
                    <div className="text-center"><div className="font-mono text-slate-500">{Math.round(result.baseline)}</div><div>baseline</div></div>
                    <div className="text-center"><div className="font-mono text-slate-500">{Math.round(result.todayValue)}</div><div>today</div></div>
                  </div>
                )}
                {result.daysNeeded && <div className="text-center text-amber-400 text-sm pt-2">{result.daysNeeded} more day{result.daysNeeded > 1 ? 's' : ''} until commands start</div>}
              </div>
            )}

            {/* Chart */}
            {result && !result.error && result.zScore !== null && <ZScoreChart zScore={result.zScore} baseline={result.baseline} mad={result.mad} />}

            {/* Stats Bar — subtle summary, only when meaningful */}
            {evidence && (evidence.totalDays >= 7 || evidence.overspent > 0 || evidence.missedWindows > 0) && (
              <div className="text-center space-y-1 py-2">
                {evidence.totalDays >= 7 && (
                  <div className="text-slate-500 text-xs">
                    {evidence.functionalDays} of {evidence.totalDays} days ready to train
                  </div>
                )}
                {evidence.overspent > 0 && (
                  <div className="text-red-400/70 text-xs">
                    {evidence.overspent} day{evidence.overspent > 1 ? 's' : ''} you pushed when your body said REST
                  </div>
                )}
                {evidence.missedWindows > 0 && (
                  <div className="text-amber-400/70 text-xs">
                    {evidence.missedWindows} day{evidence.missedWindows > 1 ? 's' : ''} you skipped when you could have trained
                  </div>
                )}
              </div>
            )}

            {/* Empty state */}
            {!result && (
              <div className="rounded-2xl p-8 bg-slate-800/50 text-center">
                <div className="text-slate-500 text-lg">Enter today's HRV below</div>
                <div className="text-slate-600 text-sm mt-1">to get your command</div>
              </div>
            )}

            {result?.error && <div className="bg-red-900/30 text-red-400 rounded-xl p-4 text-center">{result.error}</div>}

            {/* Input */}
            <div className="bg-slate-800 rounded-xl p-4 space-y-3">
              <div className="flex justify-between items-center">
                <div className="flex items-center gap-2">
                  <label className="text-xs text-slate-500 uppercase tracking-wide">Today's HRV (ms)</label>
                  <button onClick={() => setShowInfo(true)} className="text-xs text-blue-400 underline">What is HRV?</button>
                </div>
                <span className="text-xs text-slate-600">{new Date().toLocaleDateString()}</span>
              </div>
              <div className="flex gap-2">
                <input type="number" value={todayHRV} onChange={(e) => setTodayHRV(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && calculateCommand()} placeholder="e.g., 55" className="flex-1 min-w-0 bg-slate-700 rounded-lg px-4 py-3 text-xl text-center font-mono text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button onClick={calculateCommand} className="bg-blue-600 hover:bg-blue-700 rounded-lg px-5 py-3 font-semibold transition shrink-0">GO</button>
              </div>
            </div>

            {/* History */}
            <div className="bg-slate-800/50 rounded-xl p-4 space-y-3">
              <div className="flex justify-between items-center">
                <span className="text-xs text-slate-500 uppercase tracking-wide">Your Baseline</span>
                <button onClick={() => setShowHistory(!showHistory)} className="text-blue-400 text-xs">{showHistory ? 'Hide' : 'Show'}</button>
              </div>
              
              {/* Progress display */}
              {hrvHistory.length < 3 ? (
                <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                  <div className="text-3xl font-bold text-white">{3 - hrvHistory.length}</div>
                  <div className="text-xs text-slate-400">day{3 - hrvHistory.length !== 1 ? 's' : ''} until commands start</div>
                </div>
              ) : hrvHistory.length < 14 ? (
                <div className="bg-blue-500/20 border border-blue-500/30 rounded-lg p-3 text-center">
                  <div className="text-xs text-blue-400 mb-1">âœ“ Commands active</div>
                  <div className="text-2xl font-bold text-white">{hrvHistory.length} / 14</div>
                  <div className="text-xs text-slate-400">days logged — accuracy improves with more data</div>
                </div>
              ) : (
                <div className="bg-green-500/20 border border-green-500/30 rounded-lg p-3 text-center">
                  <div className="text-green-400 font-medium">âœ“ Full baseline</div>
                  <div className="text-xs text-slate-400 mt-1">{hrvHistory.length} days logged</div>
                </div>
              )}

              <div className="space-y-2">
                <div className="flex flex-wrap gap-2">
                  <input type="number" value={newEntry} onChange={(e) => setNewEntry(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addToHistory()} placeholder="HRV" className="w-20 bg-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
                  <input type="date" value={newEntryDate} onChange={(e) => setNewEntryDate(e.target.value)} className="flex-1 min-w-0 bg-slate-700 rounded-lg px-2 py-2 text-sm text-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                  <button onClick={addToHistory} className="bg-slate-600 hover:bg-slate-500 rounded-lg px-4 py-2 text-sm transition shrink-0">Add</button>
                </div>
                <div className="text-xs text-slate-600 text-center">Add past HRV readings to build your baseline faster</div>
              </div>
              {showHistory && hrvHistory.length > 0 && (
                <div className="space-y-1 pt-2 max-h-40 overflow-y-auto">
                  {[...hrvHistory].reverse().map((entry, i) => (
                    <div key={i} className="flex justify-between items-center text-xs text-slate-500 py-1 border-b border-slate-700/50">
                      <span className="flex items-center gap-2">{entry.date}{entry.date === getTodayLocal() && <span className="text-blue-400 text-[10px]">today</span>}</span>
                      <div className="flex items-center gap-3">
                        <span className="font-mono text-slate-400">{entry.value}</span>
                        <button onClick={() => removeFromHistory(i)} className="text-red-400/60 hover:text-red-400">✕</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
              {hrvHistory.length > 0 && <button onClick={clearHistory} className="w-full text-red-400/60 text-xs py-1 hover:text-red-400">Clear History</button>}
            </div>

            {/* Settings */}
            <div className="bg-slate-800/30 rounded-xl p-3">
              <input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} placeholder="Your name" className="w-full bg-transparent text-sm text-slate-400 focus:outline-none placeholder-slate-600" />
            </div>

            {/* Export & Reset */}
            <div className="space-y-2">
              <div className="flex gap-2">
                {hrvHistory.length > 0 && <button onClick={() => exportToCSV(hrvHistory, complianceLog, userName, hrvSource)} className="flex-1 bg-slate-800 text-slate-400 text-xs py-2 rounded-lg hover:bg-slate-700 transition">Export CSV</button>}
                <button onClick={resetAll} className="flex-1 text-slate-600 text-xs py-2 hover:text-red-400 transition">Reset All Data</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
